<?php /* soy2_build 2012-06-15 17:31:51 */ ?><?php class SOY2{private $_rootDir=array();private static function getInstance(){static $_static;if(!$_static)$_static=new SOY2();return $_static;}public static function RootDir($dir=null){$_static=self::getInstance();if($dir){if(substr($dir,strlen($dir)-1) != '/'){throw new Exception("[SOY2]RootDir must end by '/'.");}$_static->_rootDir[]=str_replace("\\","/",$dir);}return $_static->_rootDir[0];}public static function RootDirectories(){$inst=self::getInstance();return $inst->_rootDir;}public static function copy($array,$from){$res=new stdClass();$from=SOY2::cast("object",$from);foreach($array as $key){if(empty($key))continue;$res->$key=(isset($from->$key)) ? $from->$key : null;}return $res;}public static function import($path,$extension =".class.php"){$dir=null;if(is_array($path)){list($dir,$_path)=$path;$path=$_path;}if(class_exists($path)){return $path;}$tmp=array();preg_match('/\.([a-zA-Z0-9_]+$)/',$path,$tmp);if(count($tmp)){$className=$tmp[1];}else{$className=$path;}if($dir){$path=str_replace(".","/",$path);$result=include_once($dir.$path.$extension);}else{$dir=self::RootDirectories();$path=str_replace(".","/",$path);$result=false;foreach($dir as $_dir){if(file_exists($_dir.$path.$extension)){$result=include_once($_dir.$path.$extension);break;}}}if($result == false){return false;}return $className;}public static function imports($dir,$rootDir=null){if(!$rootDir)$rootDir=SOY2::RootDir();$path=str_replace(".","/",$dir);$dirPath=$rootDir.str_replace("*","",$path);$files=scandir($dirPath);foreach($files as $file){if(preg_match('/function\.(.*)?\.php$/',$file,$tmp)){$funcName=$tmp[1];if(!function_exists($funcName)){include_once($dirPath.$file);continue;}}if(preg_match('/.php$/',$file)){include_once($dirPath.$file);}}}public static function cast($className,$obj){if(!is_object($className)){if($className != "array" && $className != "object"){$result=self::import($className);if($result == false){throw new Exception("[SOY2]Could not find class:".$className);}$className=$result;}}$tmpObject=new stdClass;if($obj instanceof stdClass){$tmpObject=$obj;}else if(is_array($obj)){$tmpObject=(object)$obj;}else if(is_null($obj)){$tmpObject=new stdClass;}else{$refClass=new ReflectionClass($obj);$properties=$refClass->getProperties();foreach($properties as $property){$name=$property->getName();if($refClass->hasMethod("get".ucwords($name))){$method="get".ucwords($name);$value=$obj->$method();if(is_string($value) && !strlen($value))$value=null;$tmpObject->$name=$value;}else{if(!$property->isPublic())continue;$value=$obj->$name;if(is_string($value) && !strlen($value))$value=null;$tmpObject->$name=$value;}}}if(is_object($className)){$newObj=$className;}else if($className == "array"){return (array)$tmpObject;}else if($className == "object"){return $tmpObject;}else{$newObj=new $className();}foreach($tmpObject as $prop => $property){if($newObj instanceof stdClass){$newObj->$prop=$property;continue;}$methodName="set".ucwords($prop);if(!method_exists($newObj,$methodName))continue;$newObj->$methodName($property);}return $newObj;}public static function config($array){if(isset($array['RootDir'])){SOY2::RootDir($array['RootDir']);}if(isset($array['ActionDir'])){SOY2ActionConfig::ActionDir($array['ActionDir']);}if(isset($array['PageDir'])){SOY2HTMLConfig::PageDir($array['PageDir']);}if(isset($array['CacheDir'])){SOY2HTMLConfig::CacheDir($array['CacheDir']);}if(isset($array['DaoDir'])){SOY2DAOConfig::DaoDir($array['DaoDir']);}if(isset($array['EntityDir'])){SOY2DAOConfig::EntityDir($array['EntityDir']);}if(isset($array['Dsn'])){SOY2DAOConfig::Dsn($array['Dsn']);}if(isset($array['pass'])){SOY2DAOConfig::user($array['user']);}if(isset($array['pass'])){SOY2DAOConfig::pass($array['pass']);}}}?>
<?php interface SOY2_Controller{public static function run();}interface SOY2_ClassPathBuilder{function getClassPath($path);}interface SOY2_PathBuilder{function getPath();function getArguments();}?>
<?php class SOY2FancyURIController{public static function init($class){return self::getInstance($class);}public static function getInstance($class=null){static $_inst;if($class){$_inst=new $class;$_inst->initialize();}if(!$_inst){$_inst=new SOY2FancyURIController();$_inst->initialize();}return $_inst;}public static function run(){$instance=self::getInstance();$instance->execute();}public static function createLink($path,$isAbsolute=false){$instance=self::getInstance();return $instance->createLinkFromPath($path,$isAbsolute);}public static function createRelativeLink($path,$isAbsolute=false){$instance=self::getInstance();return $instance->createRelativeLinkFromPath($path,$isAbsolute);}function jump($url,$suffix=null){$url=self::createLink($url,true);if($suffix)$url .= $suffix;header("Location: ".$url);exit;}function redirect($url){header("Location: ".self::createRelativeLink($url,true));exit;}function reload($array=array()){if(!is_array($array))$array=array();$instance=self::getInstance();$url=$instance->requestURL;if(!empty($array)){$res=parse_url($url);$query=array();if(isset($res["query"]))parse_str($res["query"],$query);$query=array_merge($query,$array);$url=(strpos($url,"?") !== false) ? substr($url,0,strpos($url,"?")) : $url;if($query){$url .= "?".http_build_query($query);}}header("Location: ".self::createRelativeLink($url,true));exit;}private $pageId;private $requestURL;private $script;private $path;private $rootURL;function initialize(){$this->requestURL=rawurldecode($_SERVER["REQUEST_URI"]);$this->script=$_SERVER["SCRIPT_FILENAME"];$this->path=(isset($_SERVER["PATH_INFO"])) ? $_SERVER["PATH_INFO"] : "";$path=implode("/",array_map(create_function('$a','return rawurlencode($a);'),array_diff(explode("/",$this->path),array(""))));$reqUrl=$_SERVER["REQUEST_URI"];if(strpos($reqUrl,"?")!==false)$reqUrl=substr($reqUrl,0,strpos($reqUrl,"?"));$pos=strrpos($reqUrl,$path);if($pos === 0){$this->rootURL="/";}else{$_path=($pos) ? $this->union(substr($reqUrl,0,$pos),"/") : $this->union($reqUrl,"/");$this->rootURL=preg_replace("/\?.*/","",$_path);}}function union(){$arguments=func_get_args();$tmp=array();foreach($arguments as $key => $value){if($key == 0 && $value == "_home"){continue;}if($key == 0){$value=preg_replace('/\/$/',"",$value);if(strlen($value)<1){$tmp[]=$value;continue;}}else{$value=preg_replace('/^\/|\/$/',"",$value);}if(strlen($value)<1)continue;$tmp[]=$value;}$last=$arguments[count($arguments)-1];if(strpos($last,".")===false){$tmp[]="";}return implode("/",$tmp);}function execute(){if(strpos($this->requestURL,"/index.php") !== false){header("Location: ".str_replace("/index.php","",$this->requestURL));exit;}try{$webPage=$this->getWebPage($this->path);if($webPage){$webPage->display();}}catch(Exception $e){$this->onError($e);}}function getWebPage($path){$arguments=array();$path_array=array_diff(explode("/",$path),array(""));$webPage=null;$args=array();$dir=SOY2HTMLConfig::PageDir();$class="page_";if(count($path_array)<1){$path_array=array("index");}while(count($path_array) > 0){$current_path_array=$path_array;$tmpDir=$dir . implode("/",$path_array)."/";$class="page_".implode("_",$current_path_array);$class_index="page_".implode("_",$path_array)."_index";$classPath=$tmpDir . $class_index.".class.php";if(file_exists($classPath)){$webPage=SOY2HTMLFactory::createInstance(implode(".",$path_array).".".$class_index,array("arguments" => $args));break;}$tmpValue=array_pop($path_array);$tmpDir=$dir . implode("/",$path_array)."/";$classPath=$tmpDir . $class.".class.php";if(file_exists($classPath)){$webPage=SOY2HTMLFactory::createInstance(implode(".",$path_array).".".$class,array("arguments" => $args));break;}array_unshift($args,$tmpValue);continue;}if(!$webPage){return $this->onError(new Exception("Page Not Found:".$class));}$this->arguments=$args;$this->page=get_class($webPage);return $webPage;}function onError($e){var_dump($e);}function createLinkFromPath($path,$isAbsolute=false){$path=str_replace(".","/",$path);$url=$this->rootURL;if(strlen($path)>0 && $path[0] == "/")$path=substr($path,1);$uri=$url . $path;if($isAbsolute){return $this->createAbsoluteURL($uri);}else{return $uri;}}function createRelativeLinkFromPath($path,$isAbsolute=false){if(preg_match("/^https?:/",$path)){return $path;}if(preg_match("/^\//",$path)){}else{$base=$this->rootURL;$dirs=array_diff(explode("/",$base),array(""));$paths=explode("/",$path);$pathStack=array();foreach($paths as $path){if($path == ".."){array_pop($dirs);}elseif($path == "."){}else{array_push($pathStack,$path);}}$absolutePath=implode("/",array_merge($dirs,$pathStack));$path="/".$absolutePath;}if($isAbsolute){return $this->createAbsoluteURL($path);}else{return $path;}}protected function createAbsoluteURL($path){static $scheme,$domain,$port;if(!$scheme){$scheme=((isset($_SERVER["HTTPS"]) && $_SERVER["HTTPS"]) || (defined("SOY2_HTTPS") && SOY2_HTTPS)) ? "https" : "http";}if(!$domain){$domain=$_SERVER["SERVER_NAME"];}if(!$port){if( $_SERVER["SERVER_PORT"] == "80" && !isset($_SERVER["HTTPS"]) || $_SERVER["SERVER_PORT"] == "443" && isset($_SERVER["HTTPS"]) ){$port="";}elseif(strlen($_SERVER["SERVER_PORT"]) > 0){$port=":".$_SERVER["SERVER_PORT"];}else{$port="";}}return $scheme."://".$domain.$port.$path;}}?>
<?php class SOY2PageController implements SOY2_Controller{var $defaultPath="Index";var $requestPath="";var $arguments=array();public static function init($controller=null,$force=false){static $_controller;if(!$_controller){if($controller){$_controller=new $controller();}else{$_controller=new SOY2PageController();}}if($controller && $force){$_controller=new $controller();}return $_controller;}final public static function run(){$controller=self::init();$controller->execute();}final public static function getRequestPath(){$controller=self::init();return $controller->requestPath;}public static function getArguments(){$controller=self::init();return $controller->arguments;}function execute(){$pathBuilder=$this->getPathBuilder();$path=$pathBuilder->getPath();$args=$pathBuilder->getArguments();if(!strlen($path) || substr($path,strlen($path)-1,1) == "."){$path .= $this->getDefaultPath();}$this->requestPath=$path;$this->arguments=$args;$classPathBuilder=$this->getClassPathBuilder();$classPath=$classPathBuilder->getClassPath($path);$classPath .= 'Page';if(!SOY2HTMLFactory::pageExists($classPath)){$path=$pathBuilder->getPath();$classPath=$classPathBuilder->getClassPath($path);if(!preg_match('/.+Page$/',$classPath)){$classPath .= '.IndexPage';}}if(!SOY2HTMLFactory::pageExists($classPath)){$this->onNotFound();}$webPage=&SOY2HTMLFactory::createInstance($classPath,array("arguments" => $args));try{$webPage->display();}catch(Exception $e){$this->onError($e);}}function onError(Exception $e){throw $e;}function onNotFound(){header("HTTP/1.1 404 Not Found");header("Content-Type: text/html; charset=utf-8");echo "<h1>404 Not Found</h1><hr>指定のパスへのアクセスは有効でありません。";exit;}function getDefaultPath(){$controller=self::init();return $controller->defaultPath;}function setDefaultPath($path){$controller=self::init();$controller->defaultPath=$path;}public static function jump($path){$url=self::createLink($path,true);header("Location: ".$url);exit;}public static function redirect($path){$url=self::createRelativeLink($path,true);header("Location: ".$url);exit;}public static function reload(){$url=self::createLink(self::getRequestPath(),true) ."/". implode("/",self::getArguments());header("Location: ".$url);exit;}function &getPathBuilder(){static $builder;if(!$builder){$builder=new SOY2_PathInfoPathBuilder();}return $builder;}function &getClassPathBuilder(){static $builder;if(!$builder){$builder=new SOY2_DefaultClassPathBuilder();}return $builder;}public static function createLink($path,$isAbsoluteUrl=false){$controller=self::init();$pathBuilder=$controller->getPathBuilder();return $pathBuilder->createLinkFromPath($path,$isAbsoluteUrl);}public static function createRelativeLink($path,$isAbsoluteUrl=false){$controller=self::init();$pathBuilder=$controller->getPathBuilder();return $pathBuilder->createLinkFromRelativePath($path,$isAbsoluteUrl);}}class SOY2_PathInfoPathBuilder implements SOY2_PathBuilder{var $path;var $arguments;function SOY2_PathInfoPathBuilder(){$pathInfo=(isset($_SERVER['PATH_INFO'])) ? $_SERVER['PATH_INFO'] : "";if(preg_match('/^((\/[a-zA-Z]*)*)(\/-)?((\/[0-9a-zA-Z_\.-]*)*)$/',$pathInfo,$tmp)){$path=preg_replace('/^\/|\/$/',"",$tmp[1]);$path=str_replace("/",".",$path);$arguments=preg_replace("/^\//","",$tmp[4]);$arguments=explode("/",$arguments);foreach($arguments as $key => $value){if(!strlen($value)){$arguments[$key]=null;unset($arguments[$key]);}}$this->path=$path;$this->arguments=$arguments;}}function getPath(){return $this->path;}function getArguments(){return $this->arguments;}function createLinkFromPath($path,$isAbsoluteUrl=false){$scriptPath=self::getScriptPath();if(strlen($path)>0){$path=$scriptPath."/".str_replace(".","/",$path);}else{$path=strrev(strstr(strrev($scriptPath),"/"));}if($isAbsoluteUrl){return self::createAbsoluteURL($path);}else{return $path;}}function createLinkFromRelativePath($path,$isAbsoluteUrl=false){if(preg_match("/^https?:/",$path)){return $path;}if(preg_match("/^\//",$path)){}else{$scriptPath=self::getScriptPath();$scriptDir=preg_replace("/".basename($scriptPath)."\$/","",$scriptPath);$path=self::convertRelativePathToAbsolutePath($path,$scriptDir);}if($isAbsoluteUrl){return self::createAbsoluteURL($path);}else{return $path;}}protected static function getScriptPath(){static $script;if(!$script){$documentRoot=(defined("SOY2_DOCUMENT_ROOT")) ? SOY2_DOCUMENT_ROOT : ((isset($_SERVER["SOY2_DOCUMENT_ROOT"])) ? $_SERVER["SOY2_DOCUMENT_ROOT"] : $_SERVER["DOCUMENT_ROOT"]);$documentRoot=str_replace("\\","/",$documentRoot);if(strlen($documentRoot) >0 && $documentRoot[strlen($documentRoot)-1] != "/") $documentRoot .= "/";$script=str_replace($documentRoot,"/",str_replace("\\","/",$_SERVER["SCRIPT_FILENAME"]));$script=str_replace("\\","/",$_SERVER["SCRIPT_FILENAME"]);$script=str_replace($documentRoot,"/",$script);}return $script;}protected static function createAbsoluteURL($path){static $scheme,$domain,$port;if(!$scheme){$scheme=(isset($_SERVER["HTTPS"]) || defined("SOY2_HTTPS") && SOY2_HTTPS) ? "https" : "http";}if(!$domain){$domain=$_SERVER["SERVER_NAME"];}if(!$port){if( $_SERVER["SERVER_PORT"] == "80" && !isset($_SERVER["HTTPS"]) || $_SERVER["SERVER_PORT"] == "443" && isset($_SERVER["HTTPS"]) ){$port="";}elseif(strlen($_SERVER["SERVER_PORT"]) > 0){$port=":".$_SERVER["SERVER_PORT"];}else{$port="";}}return $scheme."://".$domain.$port.$path;}protected static function convertRelativePathToAbsolutePath($relativePath,$base){$base=str_replace("\\","/",$base);$base=preg_replace("/\/+/","/",$base);$relativePath=str_replace("\\","/",$relativePath);$relativePath=preg_replace("/\/+/","/",$relativePath);$dirs=explode("/",$base);if($dirs[0] == "") array_shift($dirs);if($dirs[count($dirs)-1] == "") array_pop($dirs);$paths=explode("/",$relativePath);$pathStack=array();foreach($paths as $path){if($path == ".."){array_pop($dirs);}elseif($path == "."){}else{array_push($pathStack,$path);}}$absolutePath=implode("/",array_merge($dirs,$pathStack));$absolutePath="/".$absolutePath;return $absolutePath;}}class SOY2_DefaultClassPathBuilder implements SOY2_ClassPathBuilder{function getClassPath($path){return $path;}}?>
<?php class SOY2Mail {public static function create($type,$options=array()){$mail=null;switch($type){case "imap":$mail=new SOY2Mail_IMAPLogic($options);break;case "pop":$mail=new SOY2Mail_POPLogic($options);break;case "smtp":$mail=new SOY2Mail_SMTPLogic($options);break;case "sendmail":$mail=new SOY2Mail_SendMailLogic($options);break;default:throw new SOY2MailException("[SOY2Mail]Invalid Logic type ".$type);break;}return $mail;}private $subject;private $encodedSubject;private $text;private $encodedText;private $attachments=array();private $headers=array();private $from=array();private $recipients=array();private $bccRecipients=array();private $encoding="UTF-8";private $subjectEncoding="ISO-2022-JP";function getSubject() {return $this->subject;}function setSubject($subject) {$this->subject=$subject;$this->encodedSubject="";}function getEncodedSubject() {if(strlen($this->encodedSubject)<1){$this->encodedSubject=mb_encode_mimeheader($this->subject,$this->subjectEncoding,"B","\r\n",strlen("Subject: "));}return $this->encodedSubject;}function setEncodedSubject($encodedSubject) {$this->encodedSubject=$encodedSubject;}function getText() {return $this->text;}function setText($text,$encoding=null) {$this->text=$text;if(!$this->encodedText){if(!$encoding)$encoding=$this->getEncoding();$this->encodedText=mb_convert_encoding($text,$encoding);}}function getEncodedText() {return $this->encodedText;}function setEncodedText($encodedText) {$this->encodedText=$encodedText;}function getAttachments() {return $this->attachments;}function setAttachments($attachments) {$this->attachments=$attachments;}function getHeaders() {return $this->headers;}function setHeaders($headers) {$this->headers=$headers;}function getFrom() {return $this->from;}function setFrom($from,$label=null,$encoding=null) {if(!$encoding)$encoding=$this->getEncoding();$this->from=new SOY2Mail_MailAddress($from,$label,$encoding);}function getRecipients() {return $this->recipients;}function setRecipients($recipients) {$this->recipients=$recipients;}function getEncodedRecipients() {return $this->encodedRecipients;}function setEncodedRecipients($encodedRecipients) {$this->encodedRecipients=$encodedRecipients;}function getEncoding() {return $this->encoding;}function setEncoding($encoding) {$this->encoding=$encoding;}function getBccRecipients() {return $this->bccRecipients;}function setBccRecipients($bccRecipients) {$this->bccRecipients=$bccRecipients;}function addRecipient($address,$label=null,$encoding=null){if(!$encoding)$encoding=$this->getEncoding();$recipient=new SOY2Mail_MailAddress($address,$label,$encoding);$this->recipients[$address]=$recipient;return $this;}function removeRecipient($address){$this->recipients[$address]=null;unset($this->recipients[$address]);}function addBccRecipient($address,$label=null,$encoding=null){if(!$encoding)$encoding=$this->getEncoding();$recipient=new SOY2Mail_MailAddress($address,$label,$encoding);$this->bccRecipients[$address]=$recipient;return $this;}function removeBccRecipient($address){$this->bccRecipients[$address]=null;unset($this->bccRecipients[$address]);}function setHeader($key,$value){if(strlen($value)>0){$this->headers[$key]=$value;}else{if(array_key_exists($key,$this->headers)){unset($this->headers[$key]);}}return $this;}function getHeader($key){return (isset($this->headers[$key])) ? $this->headers[$key] : "";}function addAttachment($filename,$type,$contents){$this->attachments[$filename]=array("filename" => $filename,"mime-type" => $type,"contents" => $contents);}function removeAttachment($filename){$this->attachments[$filename]=null;unset($this->attachments[$filename]);}function getSubjectEncoding() {return $this->subjectEncoding;}function setSubjectEncoding($subjectEncoding) {$this->subjectEncoding=$subjectEncoding;}}class SOY2Mail_MailAddress{private $address;private $label;private $encoding;function SOY2Mail_MailAddress($address,$label="",$encoding=""){if(strpos($address,"<")!==false){$label=trim(substr($address,0,strpos($address,"<")));$address=substr($address,strpos($address,"<")+1,strpos($address,">")-strpos($address,"<")-1);}$this->address=$address;$this->label=$label;$this->encoding=$encoding;}function getAddress() {return $this->address;}function setAddress($address) {$this->address=$address;}function getLabel() {return $this->label;}function setLabel($label) {$this->label=$label;}function getEncoding() {return $this->encoding;}function setEncoding($encoding) {$this->encoding=$encoding;}function getString(){if(strlen($this->address)<1)return '';if(strlen($this->label)<1)return '<' . $this->address . '>';return '"'.mb_encode_mimeheader($this->label,$this->encoding).'" <'.$this->address.'>';}function __toString(){return $this->getString();}}interface SOY2Mail_SenderInterface{function open();function send();function close();}interface SOY2Mail_ReceiverInterface{function open();function receive();function close();}class SOY2MailException extends Exception{}?>
<?php class SOY2Mail_IMAPLogic extends SOY2Mail implements SOY2Mail_ReceiverInterface{private $con;private $host;private $port;private $flag;private $folder;private $user;private $pass;function SOY2Mail_IMAPLogic($options) {if(!isset($options["imap.host"])){throw new SOY2MailException("[imap.host] is necessary.");}if(!isset($options["imap.port"])){throw new SOY2MailException("[imap.port] is necessary.");}if(!isset($options["imap.user"])){throw new SOY2MailException("[imap.user] is necessary.");}if(!isset($options["imap.pass"])){throw new SOY2MailException("[imap.pass] is necessary.");}$this->host=$options["imap.host"];$this->port=$options["imap.port"];if(isset($options["imap.flag"]))$this->flag=$options["imap.flag"];if(isset($options["imap.folder"]))$this->folder=$options["imap.folder"];$this->user=$options["imap.user"];$this->pass=$options["imap.pass"];}function open(){$host=$this->host;$host .= ":".$this->port;if($this->flag)$host .= "/".$this->flag;$this->con=imap_open("{".$host."}".$this->folder,$this->user,$this->pass);if($this->con === false){throw new SOY2MailException("imap_open(): login failed");}}function close(){imap_close($this->con);}function receive(){if(!$this->con)$this->open();$unseen=imap_search($this->con,"UNSEEN");if($unseen == false){return false;}$mail=new SOY2Mail();$i=array_shift($unseen);$head=imap_headerinfo($this->con,$i);$title=mb_decode_mimeheader(@$head->subject);$encoding="JIS";$structure=imap_fetchstructure($this->con,$i);$attribute=$structure->parameters[0]->attribute;if(preg_match("/boundary/i",$attribute)){$boundary=$structure->parameters[0]->value;list($body,$_encoding)=$this->fetchBody($i,$mail,$structure);if($_encoding)$encoding=$_encoding;}else{$body=imap_body($this->con,$i,FT_INTERNAL ^ FT_PEEK);$encoding=$structure->parameters[0]->value;}imap_setflag_full($this->con,$i,"\\Seen");$from=$head->from[0];$mail->setFrom($from->mailbox."@".$from->host,@$from->personal);$to=$head->to[0];$mail->addRecipient($to->mailbox."@".$to->host,@$to->personal);$mail->setEncoding($encoding);$mail->setHeaders((array)$head);$mail->setSubject($title);$mail->setEncodedText($body);$mail->setText(mb_convert_encoding($body,"UTF-8",$encoding));return $mail;}function fetchBody($index,$mail,$structure,$_cnt=0){$cnt=count($structure->parts);$body="";$encoding=null;foreach($structure->parts as $j => $_structure){if(count($_structure->parts) > 0){return $this->fetchBody($index,$mail,$_structure,($_cnt+1));}if($_structure->subtype == "HTML" || $_structure->subtype == "PLAIN"){$section=($_cnt) ? $_cnt.".".($j+1) : ($j+1);$body=imap_qprint(imap_fetchbody($this->con,$index,$section));$encoding=$_structure->parameters[0]->value;continue;}$attachmentName=$_structure->parameters[0]->value;$attachmentName=mb_encode_mimeheader($attachmentName);$attachmentFile=imap_fetchbody ($this->con,$index,$j+1);$attachmentFile=imap_base64 ($attachmentFile);$mail->addAttachment($attachmentName,"",$attachmentFile);}return array($body,$encoding);}function getCon() {return $this->con;}function setCon($con) {$this->con=$con;}function getHost() {return $this->host;}function setHost($host) {$this->host=$host;}function getPort() {return $this->port;}function setPort($port) {$this->port=$port;}function getFlag() {return $this->flag;}function setFlag($flag) {$this->flag=$flag;}function getUser() {return $this->user;}function setUser($user) {$this->user=$user;}function getPass() {return $this->pass;}function setPass($pass) {$this->pass=$pass;}}?>
<?php class SOY2Mail_POPLogic extends SOY2Mail implements SOY2Mail_ReceiverInterface{private $con;private $host;private $port;private $flag;private $folder;private $user;private $pass;function SOY2Mail_POPLogic($options){if(!isset($options["pop.host"])){throw new SOY2MailException("[pop.host] is necessary.");}if(!isset($options["pop.port"])){throw new SOY2MailException("[pop.port] is necessary.");}if(!isset($options["pop.user"])){throw new SOY2MailException("[pop.user] is necessary.");}if(!isset($options["pop.pass"])){throw new SOY2MailException("[pop.pass] is necessary.");}$this->host=$options["pop.host"];$this->port=$options["pop.port"];if(isset($options["pop.flag"]))$this->flag=$options["pop.flag"];if(isset($options["pop.folder"]))$this->folder=$options["pop.folder"];$this->user=$options["pop.user"];$this->pass=$options["pop.pass"];}function open(){$this->con=fsockopen($this->host,$this->port,$errono,$errnstr);if(!$this->con){$this->close();throw new SOY2MailException("failed to connect");}$buff=$this->popCommand("USER ".$this->user);if(!$buff)throw new SOY2MailException("Failed to connect pop server");$buff=$this->popCommand("PASS ".$this->pass);if(!$buff)throw new SOY2MailException("Failed to connect pop server");}function close(){if($this->con){$this->popCommand("QUIT");fclose($this->con);}}function receive(){if(!$this->con)$this->open();$res=$this->popCommand("LIST");if(!$res)throw new SOY2MailException("failed to open Receive Server");$mailId=null;while(true){$buff=$this->getPopResponse();if($buff == ".")break;$array=explode(" ",$buff);if(!is_numeric($array[0]))continue;if(!$mailId)$mailId=$array[0];}if(!$mailId)return false;$res=$this->popCommand("RETR ".$mailId);$flag=false;$header="";$body="";$encoding="JIS";$headers=array();$mail=new SOY2Mail();while(true){$buff=$this->getPopResponse();if($buff == ".")break;if(!$flag && strlen($buff)==0){$flag=true;continue;}if($flag){$body .= $buff."\r\n";}else{$header .= $buff."\r\n";}}$this->popCommand("DELE ".$mailId);$headers=$this->parseHeaders($header);if(isset($headers["Content-Type"]) && preg_match("/boundary=\"?([^\"]*)\"?/",$headers["Content-Type"],$tmp)){$boundary=$tmp[1];$bodies=explode("--". $boundary,$body);$attachCount=count($bodies);for($i=0;$i<$attachCount;$i++){$tmpHeader=substr($bodies[$i],0,strpos($bodies[$i],"\r\n\r\n"));$tmpBody=substr($bodies[$i],strpos($bodies[$i],"\r\n\r\n")+4);$tmpHeaders=$this->parseHeaders($tmpHeader);if(isset($tmpHeaders["Content-Disposition"]) && preg_match("/filename.*=(.*)/",$tmpHeaders["Content-Disposition"],$tmp)){$filename=preg_replace('/["\']/',"",$tmp[1]);$mail->addAttachment($filename,"",base64_decode($tmpBody));continue;}if(isset($tmpHeaders["Content-Type"])&& preg_match("/charset=(.*)/",$tmpHeaders["Content-Type"],$tmp)){$encoding=$tmp[1];$body=$tmpBody;if($tmpHeaders["Content-Transfer-Encoding"] == "base64"){$body=base64_decode($body);}}}}else{if(isset($header["Content-Type"]) && preg_match("/charset=(.*)/",$header["Content-Type"],$tmp)){$encoding=$tmp[1];}}$from=explode(",",$headers["From"]);$from=trim($from[0]);if(preg_match('/"?(.*?)"?\s?<?(.+@.+)>?/',$from,$tmp)){$label=mb_decode_mimeheader($tmp[1]);$address=$tmp[2];$mail->setFrom($address,$label);}$toes=explode(",",$headers["To"]);foreach($toes as $to){$to=trim($to);if(preg_match('/"?(.*?)"?\s?<?(.+@.+)>?/',$to,$tmp)){$label=mb_decode_mimeheader($tmp[1]);$address=$tmp[2];$mail->addRecipient($address,$label);}}$mail->setSubject(mb_decode_mimeheader(@$headers["Subject"]));$mail->setHeaders($headers);$mail->setEncodedText($body);$mail->setText(mb_convert_encoding($body,"UTF-8",$encoding));$mail->setEncoding($encoding);return $mail;}function popCommand($string){fputs($this->con,$string."\r\n");$buff=fgets($this->con);if(strpos($buff,"+OK") == 0){return $buff;}else{return false;}}function getPopResponse(){$buff=fgets($this->con);$buff=rtrim($buff,"\r\n");return $buff;}function parseHeaders($header){$headers=array();$header=preg_replace("/\r\n[ \t]+/",' ',$header);$raw_headers=explode("\r\n",$header);foreach($raw_headers as $value){$name =substr($value,0,$pos=strpos($value,':'));$value=ltrim(substr($value,$pos + 1));if (isset($headers[$name]) AND is_array($headers[$name])) {$headers[$name][]=$value;} elseif (isset($headers[$name])) {$headers[$name]=array($headers[$name],$value);} else {$headers[$name]=$value;}}return $headers;}}?>
<?php class SOY2Mail_SMTPLogic extends SOY2Mail implements SOY2Mail_SenderInterface{private $con;private $host;private $port;private $isSMTPAuth=false;private $user;private $pass;private $debug=false;function SOY2Mail_SMTPLogic($options){if(!isset($options["smtp.host"])){throw new SOY2MailException("[smtp.host] is necessary.");}if(!isset($options["smtp.port"])){throw new SOY2MailException("[smtp.port] is necessary.");}$this->host=$options["smtp.host"];$this->port=$options["smtp.port"];$this->isSMTPAuth=(isset($options["smtp.auth"])) ? $options["smtp.auth"] : false;$this->user= (isset($options["smtp.user"])) ? $options["smtp.user"] : null;$this->pass= (isset($options["smtp.pass"])) ? $options["smtp.pass"] : null;if(isset($options["debug"]))$this->debug=(boolean)$options["debug"];}function open(){$this->con=fsockopen($this->host,$this->port,$errono,$errnstr,60);if(!$this->con){$this->close();throw new SOY2MailException("failed to connect");}stream_set_timeout($this->con,1);$ehlo_host=str_replace("ssl://","",$this->host);$this->smtpCommand("EHLO ". $ehlo_host);$buff=$this->getSmtpResponse();if(substr($buff,0,3) != "220"){throw new SOY2MailException("Failed:EHLO");}if($this->isSMTPAuth){$authType=false;while(true){$str=$this->getSmtpResponse();if(is_null($str)) break;if(preg_match("/250-AUTH/i",$str)){if(preg_match("/".$this->isSMTPAuth."/i",$str)){$authType=strtoupper($this->isSMTPAuth);}break;}}switch($authType){case "PLAIN":$this->smtpCommand("AUTH PLAIN ".base64_encode($this->user."\0" .$this->user."\0" .$this->pass ));while(true){$str=$this->getSmtpResponse();if(preg_match("/^235/i",$str)) break;if(preg_match("/^501/i",$str)) throw new SOY2MailException("smtp login failed");if(preg_match("/^535/i",$str)) throw new SOY2MailException("smtp login failed");}break;case "LOGIN":$this->smtpCommand("auth login");$str=$this->getSmtpResponse();if(!preg_match("/^334/i",$str)) throw new SOY2MailException("smtp login failed");$this->smtpCommand(base64_encode($this->user));$this->smtpCommand(base64_encode($this->pass));while(true){$str=$this->getSmtpResponse();if(preg_match("/^235/i",$str))break;if(preg_match("/^501/i",$str))throw new SOY2MailException("smtp login failed");if(preg_match("/^535/i",$str))throw new SOY2MailException("smtp login failed");}break;default:break;}}}function send(){$bccRecipients=$this->getBccRecipients();$recipients=$this->getRecipients();foreach($recipients as $recipient){$this->sendMail($recipient,$bccRecipients);}}function sendMail(SOY2Mail_MailAddress $sendTo,$bccRecipients=array()){if(!$this->con)$this->open();try{$from=$this->getFrom();$title=$this->getEncodedSubject();$body=$this->getEncodedText();$body=str_replace(array("\r\n","\r"),"\n",$body);  $body=preg_replace('/^\\./m','..',$body);$body=str_replace("\n","\r\n",$body);$this->smtpCommand("MAIL FROM:<".$from->getAddress().">");while(true){$str=$this->getSmtpResponse();if(strlen($str)<1)break;if(preg_match("/Ok/i",$str)) break;if(substr($str,0,3)!="250")throw new SOY2MailException("Failed: MAIL FROM ".$str);}$this->isSendMailFrom=true;$this->smtpCommand("RCPT TO:<".$sendTo->getAddress().">");foreach($bccRecipients as $bccSendTo){$this->smtpCommand("RCPT TO:<".$bccSendTo->getAddress().">");}while(true){$str=$this->getSmtpResponse();if(strlen($str)<1)break;if(preg_match("/Ok/i",$str)) break;if(substr($str,0,3)!="250")throw new SOY2MailException("Failed: RCPT TO ".$str);}$this->smtpCommand("DATA");while(true){$str=$this->getSmtpResponse();if(strlen($str)<1)break;if(preg_match("/354/i",$str)) break;if(substr($str,0,3)!="250")throw new SOY2MailException("Failed: DATA ".$str);}$headers=$this->getHeaders();foreach($headers as $key => $value){$this->data("$key: $value");}$this->data("MIME-Version: 1.0");$this->data("Subject: ".$title);$this->data("From: ".$from->getString());$this->data("To: ".$sendTo->getString());$attachments=$this->getAttachments();if(count($attachments)<1){if(!isset($headers["Content-Type"]))$this->data("Content-Type: text/plain; charset=".$this->getEncoding()."");$this->data("");$this->data("$body");}else{$boundary="----------".md5(time());$this->data("Content-Type: multipart/mixed;  boundary=\"$boundary\"");$this->data("");$this->data("--".$boundary);if(!isset($headers["Content-Type"]))$this->data("Content-Type: text/plain; charset=".$this->getEncoding()."");$this->data("");$this->data("$body");foreach($attachments as $filename => $attachment){$this->data("--".$boundary);$this->data("Content-Type: ".$attachment["mime-type"]."; name=\"".mb_encode_mimeheader($filename)."\"");$this->data("Content-Disposition: inline; filename=\"".mb_encode_mimeheader($filename)."\"");$this->data("Content-Transfer-Encoding: base64");$this->data("");$this->data(wordwrap(base64_encode($attachment["contents"]),72,"\r\n",true));}$this->data("--". $boundary."--");}$this->smtpCommand(".");}catch(Exception $e){$this->smtpCommand("RSET");throw $e;}}function close(){if($this->con && $this->smtpCommand("QUIT")){fclose($this->con);}$this->con=null;}function data($string){$this->smtpCommand($string);}function smtpCommand($string){if(!$this->con){throw new SOY2MailException('SMTP is null');return;}if($this->debug)echo "> ". htmlspecialchars($string)."<br>";$result=fputs($this->con,$string."\r\n");if($result == false){throw new SOY2MailException('Result is false.');}}function getSmtpResponse(){static $unread_bytes=0;$buff=fgets($this->con);if($this->debug)echo "> ". htmlspecialchars($buff)."<br>";$meta=stream_get_meta_data($this->con);if($unread_bytes > 0 && $meta["unread_bytes"] == 0){$unread_bytes=0;return null;}else{$unread_bytes=$meta["unread_bytes"];}return $buff;}function getCon() {return $this->con;}function setCon($con) {$this->con=$con;}function getHost() {return $this->host;}function setHost($host) {$this->host=$host;}function getPort() {return $this->port;}function setPort($port) {$this->port=$port;}function getIsSMTPAuth() {return $this->isSMTPAuth;}function setIsSMTPAuth($isSMTPAuth) {$this->isSMTPAuth=$isSMTPAuth;}function getUser() {return $this->user;}function setUser($user) {$this->user=$user;}function getPass() {return $this->pass;}function setPass($pass) {$this->pass=$pass;}function getDebug() {return $this->debug;}function setDebug($debug) {$this->debug=$debug;}}?>
<?php class SOY2Mail_SendMailLogic extends SOY2Mail implements SOY2Mail_SenderInterface{function SOY2Mail_SendMailLogic($options) {}function open(){}function close(){}function send(){$bccRecipients=$this->getBccRecipients();$recipients=$this->getRecipients();foreach($recipients as $recipient){$this->sendMail($recipient,$bccRecipients);}}function sendMail($sendTo,$bccRecipients=array()){$from=$this->getFrom();$title=$this->getEncodedSubject();$body=$this->getEncodedText();$headers=array();$_headers=$this->getHeaders();foreach($_headers as $key => $value){$headers[]="$key: $value";}$headers[]="MIME-Version: 1.0" ;$headers[]="From: ".$from->getAddress();$attachments=$this->getAttachments();if(count($attachments)<1){if(!isset($_headers["Content-Type"]))$headers[]="Content-Type: text/plain; charset=".$this->getEncoding()."";}else{$boundary="----------".md5(time());$headers[]="Content-Type: multipart/mixed;  boundary=\"$boundary\"";$body="--".$boundary."\r\n";if(!isset($headers["Content-Type"]))$body .= "Content-Type: text/plain; charset=".$this->getEncoding().""."\r\n";$body .= "\r\n".$body."\r\n";foreach($attachments as $filename => $attachment){$body .= "--".$boundary."\r\n";$body .= "Content-Type: ".$attachment["mime-type"]."; name=\"".mb_encode_mimeheader($filename)."\""."\r\n";$body .= "Content-Disposition: inline; filename=\"".mb_encode_mimeheader($filename)."\""."\r\n";$body .= "Content-Transfer-Encoding: base64"."\r\n";$body .= "\r\n";$body .= wordwrap(base64_encode($attachment["contents"]),72,"\r\n",true)."\r\n";}$body .= "--".$boundary."--";}$title=str_replace(array("\r\n","\r"),"\n",$title);$body=str_replace(array("\r\n","\r"),"\n",$body);$headersText=implode("\n",$headers);$sendmail_params ="-f".$from->getAddress();$to=$sendTo->getString();$to=str_replace(array("\r\n","\r"),"\n",$to);mail($to,$title,$body,$headersText,$sendmail_params);if(count($bccRecipients) >0){$headers[]="X-To: ".$sendTo->getString();$headersText=implode("\n",$headers);foreach($bccRecipients as $bccSendTo){$to=$bccSendTo->getString();$to=str_replace(array("\r\n","\r"),"\n",$to);mail($to,$title,$body,$headersText,$sendmail_params);}}}}?>
<?php class SOY2Mail_ServerConfig {const SERVER_TYPE_SMTP=0;const SERVER_TYPE_SENDMAIL=2;const RECEIVE_SERVER_TYPE_POP =0;const RECEIVE_SERVER_TYPE_IMAP=1;private $sendServerType=SOY2Mail_ServerConfig::SERVER_TYPE_SENDMAIL;private $isUseSMTPAuth=true;private $isUsePopBeforeSMTP=false;private $sendServerAddress="localhost";private $sendServerPort=25;private $sendServerUser="";private $sendServerPassword="";private $isUseSSLSendServer=false;private $receiveServerType=SOY2Mail_ServerConfig::RECEIVE_SERVER_TYPE_POP;private $receiveServerAddress="localhost";private $receiveServerPort=110;private $receiveServerUser="";private $receiveServerPassword="";private $isUseSSLReceiveServer=false;private $fromMailAddress="";private $fromMailAddressName="";private $returnMailAddress="";private $returnMailAddressName="";private $encoding="ISO-2022-JP";function buildReceiveMail(){switch($this->receiveServerType){case self::RECEIVE_SERVER_TYPE_IMAP:$flag=null;if($this->getIsUseSSLReceiveServer())$flag="ssl";return SOY2Mail::create("imap",array("imap.host" => $this->getReceiveServerAddress(),"imap.port" => $this->getReceiveServerPort(),"imap.user" => $this->getReceiveServerUser(),"imap.pass" => $this->getReceiveServerPassword(),"imap.flag" => $flag));break;case self::RECEIVE_SERVER_TYPE_POP:default:$host=$this->getReceiveServerAddress();if($this->getIsUseSSLReceiveServer())$host= "ssl://".$host;return SOY2Mail::create("pop",array("pop.host" => $host,"pop.port" => $this->getReceiveServerPort(),"pop.user" => $this->getReceiveServerUser(),"pop.pass" => $this->getReceiveServerPassword()));break;}}function buildSendMail(){$mail=null;switch($this->sendServerType){case self::SERVER_TYPE_SMTP:$host=$this->getSendServerAddress();if($this->getIsUseSSLSendServer())$host= "ssl://".$host;$mail=SOY2Mail::create("smtp",array("smtp.host" => $host,"smtp.port" => $this->getSendServerPort(),"smtp.user" => $this->getSendServerUser(),"smtp.pass" => $this->getSendServerPassword(),"smtp.auth" => ($this->getIsUseSMTPAuth()) ? "PLAIN" : false));break;case self::SERVER_TYPE_SENDMAIL:default:$mail=SOY2Mail::create("sendmail",array());break;}if($mail){$mail->setEncoding($this->getEncoding());$mail->setFrom($this->getFromMailAddress(),$this->getFromMailAddressName());}return $mail;}function export(){return base64_encode(addslashes(serialize($this)));}function import($str){$obj=unserialize(stripslashes($str));if($obj && $obj instanceof SOY2Mail_ServerConfig){SOY2::cast($this,$obj);}else{throw new SOY2MailException("Failed to import");}}function getSendServerType() {return $this->sendServerType;}function setSendServerType($sendServerType) {$this->sendServerType=$sendServerType;}function getIsUseSMTPAuth() {return $this->isUseSMTPAuth;}function setIsUseSMTPAuth($isUseSMTPAuth) {$this->isUseSMTPAuth=$isUseSMTPAuth;}function getIsUsePopBeforeSMTP() {return $this->isUsePopBeforeSMTP;}function setIsUsePopBeforeSMTP($isUsePopBeforeSMTP) {$this->isUsePopBeforeSMTP=$isUsePopBeforeSMTP;}function getSendServerAddress() {return $this->sendServerAddress;}function setSendServerAddress($sendServerAddress) {$this->sendServerAddress=$sendServerAddress;}function getSendServerPort() {return $this->sendServerPort;}function setSendServerPort($sendServerPort) {$this->sendServerPort=$sendServerPort;}function getSendServerUser() {return $this->sendServerUser;}function setSendServerUser($sendServerUser) {$this->sendServerUser=$sendServerUser;}function getSendServerPassword() {return $this->sendServerPassword;}function setSendServerPassword($sendServerPassword) {$this->sendServerPassword=$sendServerPassword;}function getIsUseSSLSendServer() {return $this->isUseSSLSendServer;}function setIsUseSSLSendServer($isUseSSLSendServer) {$this->isUseSSLSendServer=$isUseSSLSendServer;}function getReceiveServerType() {return $this->receiveServerType;}function setReceiveServerType($receiveServerType) {$this->receiveServerType=$receiveServerType;}function getReceiveServerAddress() {return $this->receiveServerAddress;}function setReceiveServerAddress($receiveServerAddress) {$this->receiveServerAddress=$receiveServerAddress;}function getReceiveServerPort() {return $this->receiveServerPort;}function setReceiveServerPort($receiveServerPort) {$this->receiveServerPort=$receiveServerPort;}function getReceiveServerUser() {return $this->receiveServerUser;}function setReceiveServerUser($receiveServerUser) {$this->receiveServerUser=$receiveServerUser;}function getReceiveServerPassword() {return $this->receiveServerPassword;}function setReceiveServerPassword($receiveServerPassword) {$this->receiveServerPassword=$receiveServerPassword;}function getIsUseSSLReceiveServer() {return $this->isUseSSLReceiveServer;}function setIsUseSSLReceiveServer($isUseSSLReceiveServer) {$this->isUseSSLReceiveServer=$isUseSSLReceiveServer;}function getFromMailAddress() {return $this->fromMailAddress;}function setFromMailAddress($fromMailAddress) {$this->fromMailAddress=$fromMailAddress;}function getFromMailAddressName() {return $this->fromMailAddressName;}function setFromMailAddressName($fromMailAddressName) {$this->fromMailAddressName=$fromMailAddressName;}function getReturnMailAddress() {return $this->returnMailAddress;}function setReturnMailAddress($returnMailAddress) {$this->returnMailAddress=$returnMailAddress;}function getReturnMailAddressName() {return $this->returnMailAddressName;}function setReturnMailAddressName($returnMailAddressName) {$this->returnMailAddressName=$returnMailAddressName;}function getEncoding() {return $this->encoding;}function setEncoding($encoding) {$this->encoding=$encoding;}}?>
<?php class SOY2DAOConfig{var $type;var $daoDir="dao/";var $entityDir="entity/";var $daoCacheDir;var $event=array();var $options=array();var $tableMappings=array();var $dbConfig=array("default" => array("dsn" => "","user" => "","password" => ""));private function SOY2DAOConfig(){}private static function &getInstance(){static $_static;if(!$_static)$_static=new SOY2DAOConfig();return $_static;}public static function dsn($dsn=null,$name="default"){$config =& self::getInstance();if($name == "slave" && !isset($config->dbConfig[$name]))$name="default";$res=(isset($config->dbConfig[$name])) ? $config->dbConfig[$name] : array("user"=>"","password"=>"","dsn"=>"");if($dsn){$type=substr($dsn,0,strpos($dsn,":"));$res["dsn"]=$dsn;$res["type"]=$type;$config->dbConfig[$name]=$res;}return $res["dsn"];}public static function user($user=null,$name="default"){$config =& self::getInstance();if($name == "slave" && !isset($config->dbConfig[$name]))$name="default";$res=(isset($config->dbConfig[$name])) ? $config->dbConfig[$name] : array("user"=>"","password"=>"","dsn"=>"");if($user){$res["user"]=$user;$config->dbConfig[$name]=$res;}return @$res["user"];}public static function password($pass=null,$name="default"){$config=self::getInstance();if($name == "slave" && !isset($config->dbConfig[$name]))$name="default";$res=(isset($config->dbConfig[$name])) ? $config->dbConfig[$name] : array("user"=>"","password"=>"","dsn"=>"");if($pass){$res["password"]=$pass;$config->dbConfig[$name]=$res;}return $res["password"];}public static function type($name="default"){$config=self::getInstance();$res=(isset($config->dbConfig[$name])) ? $config->dbConfig[$name] : array("user"=>"","password"=>"","dsn"=>"");return @$res["type"];}public static function DaoDir($dir=null){$config=self::getInstance();$res=$config->daoDir;if($dir){if(substr($dir,strlen($dir)-1) != '/'){throw new SOY2DAOException("[SOY2DAO] DaoDir must end by '/'.");}$config->daoDir=str_replace("\\","/",$dir);}return $res;}public static function EntityDir($dir=null){$config=self::getInstance();$res=$config->entityDir;if($dir){if(substr($dir,strlen($dir)-1) != '/'){throw new SOY2DAOException("[SOY2DAO] EntityDir must end by '/'.");}$config->entityDir=str_replace("\\","/",$dir);}return $res;}public static function DaoCacheDir($dir=null){$config=self::getInstance();$res=$config->daoCacheDir;if($dir){if(substr($dir,strlen($dir)-1) != '/'){throw new SOY2DAOException("[SOY2DAO] EntityDir must end by '/'.");}$config->daoCacheDir=str_replace("\\","/",$dir);}return $res;}public static function setOption($key,$value=null){$config=self::getInstance();if($value)$config->options[$key]=$value;return (isset($config->options[$key]) ) ? $config->options[$key] : null;}public static function getOption($key){return self::setOption($key);}public static function setTableMapping($key,$value=null){$config=self::getInstance();if($value)$config->tableMappings[$key]=$value;return (isset($config->tableMappings[$key]) ) ? $config->tableMappings[$key] : $key;}public static function getTableMapping($key){return self::setTableMapping($key);}public static function setQueryEvent($function){$config=self::getInstance();if(!isset($config->event["query"]))$config->event["query"]=array();$config->event["query"][]=$function;}public static function setUpdateQueryEvent($function){$config=self::getInstance();if(!isset($config->event["updateQuery"]))$config->event["updateQuery"]=array();$config->event["updateQuery"][]=$function;}public static function getQueryEvent(){$config=self::getInstance();if(!isset($config->event["query"]))$config->event["query"]=array();return $config->event["query"];}public static function getUpdateQueryEvent(){$config=self::getInstance();if(!isset($config->event["updateQuery"]))$config->event["updateQuery"]=array();return $config->event["updateQuery"];}}class SOY2DAO{protected $_method;protected $_entity;protected $_query;protected $_binds;protected $_offset;protected $_limit;protected $_rowcount;protected $_tempQuery=null;protected $_statementCache=array();protected $_keepStatement;protected $_order;protected $_responseTime;protected $_dsn=null;protected $_dbUser=null;protected $_dbPass=null;function getQuery(){if(!isset($this->_query[$this->_method])){$query=$this->buildQuery($this->_method);return $query;}return $this->_query[$this->_method];}function setQuery($sql){$this->_query[$this->_method]=$sql;}function getBinds(){return $this->_binds;}function buildBinds($sql,$binds){if($sql instanceof SOY2DAO_Query){$sql=$sql->getQuery();}$sql=preg_replace("/'[^']*'/","",$sql);$regex=":([a-zA-Z0-9_]*)";$tmp=array();$result=preg_match_all("/$regex/",$sql,$tmp);if(!$result){return array();}$bindArray=array();$mapping=$tmp[1];foreach($binds as $key => $bind){if(is_object($bind)){foreach($mapping as $name){$method="get_".$name;if(method_exists($bind,$method) && !isset($bindArray[":".$name])){$bindArray[":".$name]=$bind->$method();}$method="get".ucwords($name);if(method_exists($bind,$method) && !isset($bindArray[":".$name])){$bindArray[":".$name]=$bind->$method();}}unset($mapping[array_search($key,$mapping)]);}else{if(in_array($key,$mapping) && !isset($bindArray[":".$key])){$bindArray[":".$key]=$bind;}}}foreach($mapping as $key => $map){if(strlen($map) && !array_key_exists(":".$map,$bindArray)){throw new SOY2DAOException("バインドするべき変数".$map."が足りません");}}$this->_binds=$bindArray;return $bindArray;}function &buildQuery($method,$noPersistents=array(),$columns=array(),$queryType=null){if(!isset($this->_query[$method])){$this->_query[$method] =SOY2DAO_QueryBuilder::buildQuery($method,$this->getEntityInfo(),$noPersistents,$columns,$queryType);$this->_query[$method]->replaceTableNames();}return  $this->_query[$method];}function getObject($row){$entityInfo=$this->getEntityInfo();$objName=$entityInfo->name;$obj=new $objName();foreach($row as $key => $value){$column=$entityInfo->getColumnByName($key,false);if($column){$propName=$column->prop;$method="set_".$propName;}else{$method="set_".$key;}if(method_exists($obj,$method)){$obj->$method($value);continue;}if($column){$propName=$column->prop;$method="set".ucwords($propName);}else{$method="set".ucwords($key);}if(method_exists($obj,$method)){$obj->$method($value);}}return $obj;}function getEntityInfo(){if(!is_object($this->_entity)){$this->_entity=unserialize($this->_entity);}return $this->_entity;}function &getDataSource(){if(SOY2DAOConfig::getOption("master_slave") === true){return SOY2DAO::_getMasterSlaveDataSource("slave",$this->getDsn(),$this->getDbUser(),$this->getDbPass());}else{return SOY2DAO::_getDataSource($this->getDsn(),$this->getDbUser(),$this->getDbPass());}}function &getMasterDataSource(){return SOY2DAO::_getMasterSlaveDataSource("master",$this->getDsn(),$this->getDbUser(),$this->getDbPass());}function releaseDataSource(){SOY2DAO::_releaseDataSource();}function clearStatementCache(){$this->_statementCache=array();}public static function &_getMasterSlaveDataSource($type="master",$dsn=null,$user=null,$pass=null){static $pdo;if(is_null($pdo)){$pdo=array();}$dsn=(is_null($dsn)) ? SOY2DAOConfig::Dsn(null,$type) : $dsn;if(!isset($pdo[$dsn])){$user=(is_null($user)) ? SOY2DAOConfig::user(null,$type) : $user;$pass=(is_null($pass)) ? SOY2DAOConfig::password(null,$type) : $pass;try{$pdo[$dsn]=new PDO($dsn,$user,$pass,array(PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION));} catch (Exception $e) {$event=SOY2DAOConfig::getOption("connection_failure");if($event != "throw"){die("Can not get DataSource ({$dsn}).");}else{throw new SOY2DAOException("Can not get DataSource ({$dsn})",$e);}}if(preg_match('/^mysql/',$dsn)){try{$pdo[$dsn]->exec("set names 'utf8'");}catch(Exception $e){}}}return $pdo[$dsn];}public static function &_getDataSource($dsn=null,$user=null,$pass=null){static $pdo;if(is_null($pdo)){$pdo=array();}$dsn=(is_null($dsn)) ? SOY2DAOConfig::Dsn() : $dsn;if(!isset($pdo[$dsn])){$user=(is_null($user)) ? SOY2DAOConfig::user() : $user;$pass=(is_null($pass)) ? SOY2DAOConfig::password() : $pass;try{$pdo[$dsn]=new PDO($dsn,$user,$pass,array(PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION));} catch (Exception $e) {$event=SOY2DAOConfig::getOption("connection_failure");if($event == "throw"){throw new SOY2DAOException("Can not get DataSource ({$dsn})",$e);}else{die("Can not get DataSource ({$dsn}).");}}if(preg_match('/^mysql/',$dsn)){try{$pdo[$dsn]->exec("set names 'utf8'");}catch(Exception $e){}}}return $pdo[$dsn];}public static function _releaseDataSource(){$pdo=&self::_getDataSource();$pdo=null;}public static function find($className,$arguments=array()){if(!is_array($arguments))$arguments=array("id" => $arguments);SOY2DAOFactory::importEntity($className);$daoName=$className."DAO";$dao=SOY2DAOFactory::create($daoName);if(empty($arguments) && method_exists($dao,"get")){return $dao->get();}foreach($arguments as $key => $value){if(method_exists($dao,"getBy".ucwords($key))){$method="getBy".ucwords($key);return $dao->$method($value);}}throw new Exception("not supported");}function executeQuery($sql,$binds=array(),$keepStatement=false){if($sql instanceof SOY2DAO_Query){if(strlen($this->getOrder())){$sql->setOrder($this->getOrder());}$sql->replaceTableNames();$sql=$sql->getQuery();}if(!is_null($this->_keepStatement)){$keepStatement=$this->_keepStatement;}$isUseLimitQuery=false;if(SOY2DAOConfig::getOption("limit_query") === true && !is_null($this->_limit)){if(!is_null($this->_offset)){$sql .= " limit ".(int)$this->_offset.",".(int)$this->_limit;}else{$sql .= " limit 0,".(int)$this->_limit;}$isUseLimitQuery=true;}if(SOY2DAOConfig::getOption("keep_statement") !== null){$keepStatement=(boolean)SOY2DAOConfig::getOption("keep_statement");}if(SOY2DAOConfig::getOption("profile") === true){SOY2DAO_QueryProfile::prepare($sql,$binds);}$pdo=$this->getDataSource();try{$events=SOY2DAOConfig::getQueryEvent();foreach($events as $event){call_user_func($event,$sql,$binds);}if($keepStatement){if(isset($this->_statementCache[md5($sql)])){$stmt=$this->_statementCache[md5($sql)];}else{$stmt=$pdo->prepare($sql);$this->_statementCache[md5($sql)]=$stmt;}}else{$stmt=$pdo->prepare($sql);}if(!$stmt){$e=new SOY2DAOException("The database server cannot successfully prepare the statement. SQL: ".$sql);$e->setQuery($sql."");throw $e;}foreach($binds as $key => $bind){$type=PDO::PARAM_STR;switch(true){case is_null($bind) :$type=PDO::PARAM_NULL;break;case is_int($bind) :$type=PDO::PARAM_INT;break;case is_bool($bind) :case is_float($bind) :case is_numeric($bind) :case is_string($bind) :default:$type=PDO::PARAM_STR;break;}$stmt->bindParam($key,$binds[$key],$type);}$start=microtime(true);$result=$stmt->execute();$this->_responseTime=microtime(true)-$start;}catch(Exception $e){$e=new SOY2DAOException("Invalid query.",$e);$e->setQuery($sql."");throw $e;}if(!$result){$e=new SOY2DAOException("[Failed] Statement->execute. ",$e);$e->setQuery($sql."");throw $e;}$resultArray=array();$counter=0;if($isUseLimitQuery){while($row=$stmt->fetch(PDO::FETCH_ASSOC)){$resultArray[]=$row;$counter++;}}else{if(!is_null($this->_offset)){for($i=0; $i<$this->_offset; $i++){if($stmt->fetch() == false)break;$counter++;}}while($row=$stmt->fetch(PDO::FETCH_ASSOC)){if(is_null($this->_limit) || $counter < ($this->_offset + $this->_limit)){$resultArray[]=$row;}if(!is_null($this->_limit) && $counter > ($this->_offset + $this->_limit)){break;}$counter++;}}$this->_rowcount=$counter;if(SOY2DAOConfig::getOption("profile") === true){SOY2DAO_QueryProfile::result();}return $resultArray;}function executeUpdateQuery($sql,$binds=array(),$keepStatement=false){if($sql instanceof SOY2DAO_Query){if(strlen($this->getOrder())){$sql->setOrder($this->getOrder());}$sql->replaceTableNames();$this->_tempQuery=$sql;$sql=$sql->getQuery();}if(SOY2DAOConfig::getOption("keep_statement") !== null){$keepStatement=(boolean)SOY2DAOConfig::getOption("keep_statement");}if(!is_null($this->_keepStatement)){$keepStatement=$this->_keepStatement;}if(SOY2DAOConfig::getOption("profile") === true){SOY2DAO_QueryProfile::prepare($sql,$binds);}if(SOY2DAOConfig::getOption("master_slave") === true){$pdo=$this->getMasterDataSource();}else{$pdo=$this->getDataSource();}if($sql instanceof SOY2DAO_Query){$sql=$sql->__toString();}try{$events=SOY2DAOConfig::getUpdateQueryEvent();foreach($events as $event){call_user_func($event,$sql,$binds);}if($keepStatement){if(isset($this->_statementCache[md5($sql)])){$stmt=$this->_statementCache[md5($sql)];}else{$stmt=$pdo->prepare($sql);$this->_statementCache[md5($sql)]=$stmt;}}else{$stmt=$pdo->prepare($sql);}if($stmt === false){throw new SOY2DAOException("The database server cannot successfully prepare the statement. SQL: ".$sql);}foreach($binds as $key => $bind){$type=PDO::PARAM_STR;switch(true){case is_null($bind) :$type=PDO::PARAM_NULL;break;case is_int($bind) :$type=PDO::PARAM_INT;break;case is_bool($bind) :case is_float($bind) :case is_numeric($bind) :case is_string($bind) :default:$type=PDO::PARAM_STR;break;}$stmt->bindParam($key,$binds[$key],$type);}$start=microtime(true);$result=$stmt->execute();$this->_responseTime=microtime(true)-$start;}catch(Exception $e){$e=new SOY2DAOException("Invalid query.",$e);$e->setQuery($sql."");throw $e;}if(SOY2DAOConfig::getOption("profile") === true){SOY2DAO_QueryProfile::result();}return $result;}function setMethod($method){$this->_method=$method;$this->_binds=array();}function lastInsertId(){if(SOY2DAOConfig::getOption("master_slave") === true){$pdo=$this->getMasterDataSource();}else{$pdo=$this->getDataSource();}if(SOY2DAOConfig::type() != "pgsql"){return $pdo->lastInsertId();}else{if($this->_tempQuery && $this->_tempQuery instanceof SOY2DAO_Query){$sequence=$this->_tempQuery->sequence;$stmt=$pdo->query("select currval('$sequence') as current_seq_id");if(!$stmt)return null;while($row=$stmt->fetch(PDO::FETCH_ASSOC)){return $row["current_seq_id"];}}return null;}}function setOffset($offset){$this->_offset=$offset;}function setLimit($limit){$this->_limit=$limit;}function getRowCount(){return $this->_rowcount;}function begin(){$this->getDataSource()->beginTransaction();}function rollback(){$this->getDataSource()->rollBack();}function commit(){$this->getDataSource()->commit();}function setKeepStatement($flag){$this->_keepStatement=(boolean)$flag;}function getTableName($key){return SOY2DAOConfig::getTableMapping($key);}function setOrder($order){$this->_order=$order;}function getOrder(){return $this->_order;}function setDsn($dsn){$this->_dsn=$dsn;}function getDsn(){return $this->_dsn;}function getDbUser() {return $this->_dbUser;}function setDbUser($dbUser) {$this->_dbUser=$dbUser;}function getDbPass() {return $this->_dbPass;}function setDbPass($dbPass) {$this->_dbPass=$dbPass;}function getResponseTime(){return $this->_responseTime;}}class SOY2DAOException extends Exception{private $pdoException;private $query;function SOY2DAOException($msg,Exception $e=null){if($e)$msg .= "\n".$e->getMessage();$this->pdoException=$e;parent::__construct($msg);}function getPDOExceptionMessage(){if(!$this->pdoException)return "";$message=$this->pdoException->getMessage();if($this->pdoException instanceof PDOException && !empty($this->pdoException->errorInfo)){$message .= "; ".implode(",",$this->pdoException->errorInfo);}return $message;}function getPdoException() {return $this->pdoException;}function setPdoException($pdoException) {$this->pdoException=$pdoException;}function getQuery() {return $this->query;}function setQuery($query) {$this->query=$query;}}?>
<?php class SOY2DAOContainer{private $daos=array();public static function get($name,$arguments=array()){static $_inst;if(!$_inst)$_inst=new SOY2DAOContainer();if(isset($_inst->daos[$name])){$dao =$_inst->daos[$name];}else{$dao=SOY2DAOFactory::create($name,$arguments);$_inst->daos[$name]=$dao;}foreach($arguments as $key => $value){if(method_exists($dao,"set".ucwords($key))){$func="set".ucwords($key);$dao->$func($value);continue;}}$dao->setLimit(null);$dao->setOffset(null);return $dao;}}?>
<?php class SOY2DAOFactory{public static function create($className,$arguments=array()){$className=SOY2DAOFactory::importDAO($className);$obj=SOY2DAOFactoryImpl::build($className);foreach($arguments as $key => $value){if(method_exists($obj,"set".ucwords($key))){$func="set".ucwords($key);$obj->$func($value);continue;}}return $obj;}const ANNOTATION_ENTITY="entity";const ANNOTATION_QUERY="query";const ANNOTATION_SQL="sql";const ANNOTATION_RETURN="return";const ANNOTATION_ORDER="order";const ANNOTATION_COLUMNS="columns";const ANNOTATION_GROUP="group";const ANNOTATION_HAVING="having";const ANNOTATION_DISTINCT="distinct";const ANNOTATION_TRIGGER="trigger";const ANNOTATION_FINAL="final";const ANNOTATION_QUERY_TYPE="query_type";const ANNOTATION_TABLE="table";const ANNOTATION_ID="id";const ANNOTATION_NO_PERSISTENT="no_persistent";const ANNOTATION_READ_ONLY="read_only";const ANNOTATION_COLUMN="column";const ANNOTATION_COLUMN_ALIAS="alias";const ANNOTATION_COLUMN_TYPE="type";const ANNOTATION_COLUMN_DATE="date";const ANNOTATION_INDEX="index";public static function getAnnotation($key,$str){$regex='@'.$key.'\s+(.+)';$tmp=array();if(!preg_match("/$regex/",$str,$tmp)){$regex='@'.$key;if(preg_match("/$regex/",$str)){return true;}else{return false;}}return trim($tmp[1]);}public static function importDAO($className){if(!class_exists($className,false)){$path=$className;$tmp=array();if(preg_match('/\.?([a-zA-Z0-9_]+$)/',$className,$tmp)){$className=$tmp[1];}if(!class_exists($className)){$fullPath=SOY2DAOConfig::DaoDir(). str_replace(".","/",$path).".class.php";include($fullPath);}}return $className;}public static function importEntity($className){if(!class_exists($className,false)){$path=$className;$tmp=array();if(preg_match('/\.?([a-zA-Z0-9_]+$)/',$className,$tmp)){$className=$tmp[1];}if(class_exists($className)){return $className;}$fullPath=SOY2DAOConfig::EntityDir(). str_replace(".","/",$path).".class.php";require_once($fullPath);}return $className;}}class SOY2DAOFactoryImpl extends SOY2DAOFactory {public static function build($className){if(class_exists($className."Impl",false)){$name =$className."Impl";return new $name();}$cacheDir=SOY2DAOConfig::DaoCacheDir();if(file_exists($cacheDir.$className."Impl.class.php")&& filemtime($cacheDir.$className."Impl.class.php") > filemtime(__FILE__)){include_once($cacheDir.$className."Impl.class.php");}if(class_exists($className."Impl",false)){$name =$className."Impl";return new $name();}$reflection=new ReflectionClass($className);$daoComment=$reflection->getDocComment();$entityClass=self::getEntityClassName($className,$daoComment);$entityClass=SOY2DAOFactory::importEntity($entityClass);$entityInfo=self::buildEntityInfomation($entityClass);if(!$reflection->isSubclassOf(new ReflectionClass("SOY2DAO"))){return $reflection->newInstance();}$methods=$reflection->getMethods();foreach($methods as $method){if($method->getDeclaringClass()->getName() != $className)continue;$methodStrings[]=self::buildMethod($method,$entityInfo);}$str="class ".$reflection->getName()."Impl extends ".$reflection->getName()."{";$str.="\n";$str .= 'var $_entity="'.str_replace('"','\"',serialize($entityInfo)).'";';$str.="\n";$str .= implode("",$methodStrings);$str .= "}";if($cacheDir){$fp=fopen($cacheDir.$reflection->getName()."Impl.class.php","w");$entityReflection=new ReflectionClass($entityClass);$import="<?php if(!class_exists('$entityClass')){ \n"."include_once(\"".str_replace("\\","/",$entityReflection->getFileName())."\"); \n"."} \n?>";$updateCheck='<?php $updateDate'."=max(filemtime(\"".str_replace("\\","/",$reflection->getFileName())."\"),filemtime(\"".str_replace("\\","/",$entityReflection->getFileName())."\"));";$updateCheck .= 'if($updateDate  < filemtime(__FILE__)){ ?>';fwrite($fp,$import);fwrite($fp,$updateCheck);fwrite($fp,"<?php\n".$str."?>");fwrite($fp,"<?php\n } \n?>");fclose($fp);}eval($str);$name=$reflection->getName()."Impl";return new $name();}public static function buildMethod($method,$entityInfo){$table=self::getAnnotation(SOY2DAOFactory::ANNOTATION_TABLE,$method->getDocComment());$return=self::getAnnotation(SOY2DAOFactory::ANNOTATION_RETURN,$method->getDocComment());$queryAnnotation=self::getAnnotation(SOY2DAOFactory::ANNOTATION_QUERY,$method->getDocComment());$sqlAnnotation=self::getAnnotation(SOY2DAOFactory::ANNOTATION_SQL,$method->getDocComment());$noPersistent=self::getAnnotation(SOY2DAOFactory::ANNOTATION_NO_PERSISTENT,$method->getDocComment());$order=self::getAnnotation(SOY2DAOFactory::ANNOTATION_ORDER,$method->getDocComment());$column=self::getAnnotation(SOY2DAOFactory::ANNOTATION_COLUMNS,$method->getDocComment());$columns=(strlen($column)) ? explode(",",$column) : array();$group=self::getAnnotation(SOY2DAOFactory::ANNOTATION_GROUP,$method->getDocComment());$having=self::getAnnotation(SOY2DAOFactory::ANNOTATION_HAVING,$method->getDocComment());$index=self::getAnnotation(SOY2DAOFactory::ANNOTATION_INDEX,$method->getDocComment());$distinct=self::getAnnotation(SOY2DAOFactory::ANNOTATION_DISTINCT,$method->getDocComment());$trigger=self::getAnnotation(SOY2DAOFactory::ANNOTATION_TRIGGER,$method->getDocComment());$final=self::getAnnotation(SOY2DAOFactory::ANNOTATION_FINAL,$method->getDocComment());$queryType=self::getAnnotation(SOY2DAOFactory::ANNOTATION_QUERY_TYPE,$method->getDocComment());if($final || $method->isFinal() || $method->isPrivate()){return;}$replacePropertyNameFunction=create_function('$key','$entityInfo="'.str_replace('"','\"',serialize($entityInfo)).'";return unserialize($entityInfo)->getColumn($key[1])->getName();');$queryAnnotation=preg_replace_callback('/#+([a-zA-Z0-9]*)#+/',$replacePropertyNameFunction,$queryAnnotation);$group=preg_replace_callback('/#+([a-zA-Z0-9]*)#+/',$replacePropertyNameFunction,$group);$having=preg_replace_callback('/#+([a-zA-Z0-9]*)#+/',$replacePropertyNameFunction,$having);$order=preg_replace_callback('/#+([a-zA-Z0-9]*)#+/',$replacePropertyNameFunction,$order);$noPersistent=preg_replace_callback('/#+([a-zA-Z0-9]*)#+/',$replacePropertyNameFunction,$noPersistent);$noPersistents=(strlen($noPersistent)) ? explode(",",$noPersistent) : array();$indexColumn=preg_replace_callback('/#+([a-zA-Z0-9]*)#+/',$replacePropertyNameFunction,$index);$columns=preg_replace_callback('/#+([a-zA-Z0-9]*)#+/',$replacePropertyNameFunction,$columns);$parameters=$method->getParameters();$params=array();foreach($parameters as $param){$str="";$class=$param->getClass();if($class){$str .= $class->getName()." ";}if($param->isPassedByReference()){$str .= "&";}$str .= '$'.$param->getName();if($param->isDefaultValueAvailable()){$defValue=$param->getDefaultValue();if(is_null($defValue)){$defValue='null';}else if(!is_numeric($defValue)){$defValue='"'.$defValue.'"';}$str .= "=".$defValue;}$params[]=$str;}$methodString=array();$methodString[]= "function ".$method->getName();$methodString[]= "(".implode(",",$params)."){";$methodString[]='$this->setMethod("'.$method->getName().'");';if($sqlAnnotation){$methodString[]='$this->setQuery("'.$sqlAnnotation.'");';}$methodString[]='$query=$this->buildQuery($this->_method,'.'unserialize(\''.serialize($noPersistents).'\'),'.'unserialize(\''.serialize($columns).'\'),' .'"'.$queryType.'");';if($table)$methodString[]='$query->table="'.$table.'";';if($queryAnnotation)$methodString[]='$query->where="'.$queryAnnotation.'";';if($order)$methodString[]='$query->order="'.$order.'";';if($group)$methodString[]='$query->group="'.$group.'";';if($having)$methodString[]='$query->having="'.$having.'";';if($distinct)$methodString[]='$query->distinct=true;';$props=array();foreach($method->getParameters() as $key => $refParam){$props[]='"'.$refParam->getName().'" => $'.$refParam->getName();}$methodString[]='if($query instanceof SOY2DAO_Query){';$methodString[]='$query->parseExpression(array(';$methodString[]=implode(',',$props);$methodString[]='));';$methodString[]='}';$methodString[]='$this->buildBinds($query,array(';$methodString[]=implode(',',$props);$methodString[]='));';if($method->isAbstract()){$methodString[]='$query=$this->getQuery();';$methodString[]='$binds=$this->getBinds();';if($trigger){$triggers=explode(",",$trigger);foreach($triggers as $key => $trigger){$methodString[]='if(method_exists($this,"'.$trigger.'")){';if(!strpos("::",$trigger)){$methodString[]='list($query,$binds)=$this->' . $trigger . '($query,$binds);';}$methodString[]='}else{';$methodString[]='list($query,$binds)=' . $trigger . '($query,$binds);';$methodString[]='}';}}if(empty($return) && preg_match('/^count/',$method->getName())){$return="column_count_id";}$returnType=$return;if(preg_match('/^column_(.*)$/i',$return,$tmp)){$returnType='column';$returnColumnName=$tmp[1];}if(preg_match('/^columns_(.*)$/i',$return,$tmp)){$returnType='columns';$returnColumnName=$tmp[1];}if($returnType == "object"|| $returnType == "column"|| $returnType == "row"){$methodString[]='$oldLimit=$this->_limit;';$methodString[]='$this->setLimit(1);';$methodString[]='$oldOffset=$this->_offset;';$methodString[]='$this->setOffset(0);';}if(preg_match("/^insert|^create/",strtolower($method->getName())) || $queryType == "insert"){$methodString[]='$result=$this->executeUpdateQuery($query,$binds);';}else if(preg_match("/^delete|^remove/",strtolower($method->getName())) || $queryType == "delete"){$methodString[]='$result=$this->executeUpdateQuery($query,$binds);';}else if(preg_match("/^update|^save|^write|^reset|^change/",strtolower($method->getName())) || $queryType == "update"){$methodString[]='$result=$this->executeUpdateQuery($query,$binds);';}else{$methodString[]='$result=$this->executeQuery($query,$binds);';}switch($returnType){case "id":$methodString[]='return $this->lastInsertId();';break;case "object":$methodString[]='$this->setLimit($oldLimit);';$methodString[]='$this->setOffset($oldOffset);';$methodString[]='if(count($result)<1)throw new SOY2DAOException("[SOY2DAO]Failed to return Object.");';$methodString[]='$obj=$this->getObject($result[0]);';$methodString[]='return $obj;';break;case "row":$methodString[]='$this->setLimit($oldLimit);';$methodString[]='$this->setOffset($oldOffset);';$methodString[]='if(count($result)<1)throw new SOY2DAOException("[SOY2DAO]Failed to return row.");';$methodString[]='return $result[0];';break;case "column":$methodString[]='$this->setLimit($oldLimit);';$methodString[]='$this->setOffset($oldOffset);';$methodString[]='if(count($result)<1)throw new SOY2DAOException("[SOY2DAO]Failed to return column.");';$methodString[]='$row=$result[0];';$methodString[]='return $row["'.$returnColumnName.'"];';break;case "array":$methodString[]='$array=array();';if($index){$methodString[]='if(is_array($result)){';$methodString[]='foreach($result as $row){';$methodString[]='$array[$row["'.$indexColumn.'"]]=$row;';$methodString[]='}';$methodString[]='}';}else{$methodString[]='$array=$result;';}$methodString[]='return $array;';break;case "columns":$methodString[]='$array=array();';if($index){$methodString[]='if(is_array($result)){';$methodString[]='foreach($result as $row){';$methodString[]='$array[$row["'.$indexColumn.'"]]=$row["'.$returnColumnName.'"];';$methodString[]='}';$methodString[]='}';}else{$methodString[]='if(is_array($result)){';$methodString[]='foreach($result as $row){';$methodString[]='$array[]=$row["'.$returnColumnName.'"];';$methodString[]='}';$methodString[]='}';}$methodString[]='return $array;';break;case "list":default:$methodString[]='$array=array();';$methodString[]='if(is_array($result)){';$methodString[]='foreach($result as $row){';if($index){$func="get".ucfirst($index);$methodString[]='$obj=$this->getObject($row);';$methodString[]='$array[$obj->'.$func.'()]=$obj;';}else{$methodString[]='$array[]=$this->getObject($row);';}$methodString[]='}';$methodString[]='}';$methodString[]='return $array;';break;}}else{$parameters=$method->getParameters();$params=array();foreach($parameters as $parameter){$params[]='$'.$parameter->getName();}$methodString[]="return parent::".$method->getName()."(".implode(",",$params).");";}$methodString[]='}';return implode("\n",$methodString);}public static function getEntityClassName($className,$daoComment){$result=self::getAnnotation(SOY2DAOFactory::ANNOTATION_ENTITY,$daoComment);if($result !== false){$entity=$result;}else{$entity=preg_replace('/dao$/i',"",$className);}return $entity;}public static function buildEntityInfomation($entity){$reflection=new ReflectionClass($entity);$comment=$reflection->getDocComment();$entityInfo=new SOY2DAO_Entity();$entityInfo->name=$entity;$table=self::getAnnotation(self::ANNOTATION_TABLE,$comment);$entityInfo->table=(strlen($table)>0) ? $table : $entity;$id=self::getAnnotation(self::ANNOTATION_ID,$comment);$entityInfo->id=$id;$properties=$reflection->getProperties();$parent=$reflection->getParentClass();while($parent){$properties=array_merge($properties,$parent->getProperties());$parent=$parent->getParentClass();}foreach($properties as $property){$propertyComment=$property->getDocComment();$propName=$property->getName();if($propName[0] == "_")continue;$noPersistent=self::getAnnotation(self::ANNOTATION_NO_PERSISTENT,$propertyComment);if($noPersistent)continue;$column=new SOY2DAO_EntityColumn();$column->prop=$property->getName();$columnAnnotation=self::getAnnotation(self::ANNOTATION_COLUMN,$propertyComment);$alias=self::getAnnotation(self::ANNOTATION_COLUMN_ALIAS,$propertyComment);if($columnAnnotation === false){$column->name=$property->getName();}else{$column->name=$columnAnnotation;}if($alias !== false){$column->alias=$alias;}$type=self::getAnnotation(self::ANNOTATION_COLUMN_TYPE,$propertyComment);if($type){$column->type=$type;}$date=self::getAnnotation(self::ANNOTATION_COLUMN_DATE,$propertyComment);if($date){$column->date=$date;}$id=self::getAnnotation(self::ANNOTATION_ID,$propertyComment);$tmp=array();switch(true){case ($id === false):break;case preg_match("/^sequence=(.*)/",$id,$tmp):$column->sequence=$tmp[1];case preg_match("/^identity/",$id):default:$column->isPrimary=true;break;}$readOnly=(boolean)self::getAnnotation(self::ANNOTATION_READ_ONLY,$propertyComment);$column->readOnly=$readOnly;$entityInfo->columns[strtolower($column->prop)]=$column;}$entityInfo->buildReverseColumns();return $entityInfo;}}?>
<?php class SOY2DAO_Entity{var $name;var $table;var $id;var $columns=array();var $reverseColumns=array();function getColumns($flag=false){$array=array();foreach($this->columns as $column){if(!$flag && $column->readOnly)continue;$array[strtolower($column->prop)]=$column->name;}return $array;}function getColumn($key){$key=strtolower($key);return (isset($this->columns[$key])) ? $this->columns[$key] : null;}function getColumnByName($name,$isThrow=true){$name=strtolower($name);if(!isset($this->reverseColumns[$name])){if($isThrow){trigger_error("[SOY2DAO]".$this->name." does not have $name.");}else{return null;}}return $this->getColumn(@$this->reverseColumns[$name]);}function buildReverseColumns(){foreach($this->columns as $key => $column){$name=($column->getAlias()) ? $column->getAlias() : $column->getName();$name=strtolower($name);$this->reverseColumns[$name]=$key;}}}?>
<?php class SOY2DAO_EntityBase {function save(){$dao=$this->getDAO();if($this->check()){if(strlen($this->getId())>0){$dao->update($this);}else{$id=$dao->insert($this);$this->setId($id);}}}function create(){$this->setId(null);$this->save();}function delete(){$this->getDAO()->delete($this->getId());}public static function deleteAll(){eval('$obj=new static;');$dao=$obj->getDAO();$dao->deleteAll();}final function get($id=null){if($id){$res=$this->getDAO()->getById($id);}else{$res=$this->getDAO()->getById($this->getId());}return $res;}private $_dao;final function getDAO(){if(is_null($this->_dao)){$daoClass=get_class($this)."DAO";if(!class_exists($daoClass)){$ref=new ReflectionClass($this);$filepath=dirname($ref->getFileName())."/".$daoClass.".class.php";if(file_exists($filepath))include_once($filepath);}$this->_dao=SOY2DAOFactory::create($daoClass);}return $this->_dao;}function __wakeup(){$this->_dao=null;}}?>
<?php class SOY2DAO_EntityColumn{var $id;var $name;var $alias;var $prop;var $isPrimary;var $readOnly;var $sequence;function getId() {return $this->id;}function setId($id) {$this->id=$id;}function getName() {return $this->name;}function setName($name) {$this->name=$name;}function getAlias() {return $this->alias;}function setAlias($alias) {$this->alias=$alias;}function getProp() {return $this->prop;}function setProp($prop) {$this->prop=$prop;}function getIsPrimary() {return $this->isPrimary;}function setIsPrimary($isPrimary) {$this->isPrimary=$isPrimary;}function getSequence() {return $this->sequence;}function setSequence($sequence) {$this->sequence=$sequence;}}?>
<?php class SOY2DAO_Query{public static function select($table){$obj=new SOY2DAO_QueryFactory();return $obj->prefix("select")->table($table);}var $prefix;var $table;var $sql;var $where;var $order;var $group;var $having;var $distinct;var $sequence;var $binds=array();function __toString(){switch($this->prefix){case "insert":$sql= $this->prefix." into ".$this->table." ".$this->sql;if(strlen($this->where)){$sql .= " where ".$this->where;}break;case "select":$sql= $this->prefix." ";if($this->distinct){$sql .= "distinct ";}$sql .= $this->sql." from ".$this->table;if(strlen($this->where)){$sql .= " where ".$this->where;}if(strlen($this->group)){$sql .= " group by ".$this->group;}if(strlen($this->having)){$sql .= " having ".$this->having;}if(strlen($this->order)){$sql .= " order by ".$this->order;}break;case "update":$sql= $this->prefix." ".$this->table." set ".$this->sql;if(strlen($this->where)){$sql .= " where ".$this->where;}break;case "delete":$sql= $this->prefix." from ".$this->table;if(strlen($this->where)){$sql .= " where ".$this->where;}break;}return $sql;}function parseExpression($arguments){$phpExpression='/<\?php\s(.*)?\?>/';if(preg_match($phpExpression,$this->where,$tmp)){$expression=$tmp[1];$expression=str_replace("\\:","@:@",$expression);$expression=preg_replace("/:([a-zA-Z0-9_]+)/",'$arguments[\'$1\']',$expression);$expression=str_replace("@:@",":",$expression);$replace="";eval('$replace='.$expression.";");if(!is_string($replace) AND !is_numeric($replace))throw new SOY2DAOException("PHP式の変換に失敗しました。(".$tmp[1].")");$this->where=preg_replace($phpExpression,$replace,$this->where);}if(preg_match($phpExpression,$this->having,$tmp)){$expression=$tmp[1];$expression=preg_replace("/:([a-zA-Z0-9_]*)/",'$arguments[\'$1\']',$expression);$replace="";eval('$replace='.$expression.";");if(!is_string($replace) AND !is_numeric($replace))throw new SOY2DAOException("PHP式の変換に失敗しました。(".$tmp[1].")");$this->having=preg_replace($phpExpression,$replace,$this->having);}}function replaceTableNames(){$this->table=preg_replace_callback('/([a-zA-Z_0-9]+)\?/',array($this,'replaceTableName'),$this->table);$this->sql=preg_replace_callback('/([a-zA-Z_0-9]+)\?/',array($this,'replaceTableName'),$this->sql);$this->where=preg_replace_callback('/([a-zA-Z_0-9]+)\?/',array($this,'replaceTableName'),$this->where);$this->having=preg_replace_callback('/([a-zA-Z_0-9]+)\?/',array($this,'replaceTableName'),$this->having);}function replaceTableName($key){return SOY2DAOConfig::getTableMapping($key[1]);}function getQuery(){return $this->__toString();}function getPrefix() {return $this->prefix;}function setPrefix($prefix) {$this->prefix=$prefix;}function getTable() {return $this->table;}function setTable($table) {$this->table=$table;}function getSql() {return $this->sql;}function setSql($sql) {$this->sql=$sql;}function getWhere() {return $this->where;}function setWhere($where) {$this->where=$where;}function getOrder() {return $this->order;}function setOrder($order) {$this->order=$order;}function getGroup() {return $this->group;}function setGroup($group) {$this->group=$group;}function getHaving() {return $this->having;}function setHaving($having) {$this->having=$having;}function getDistinct() {return $this->distinct;}function setDistinct($distinct) {$this->distinct=$distinct;}function getSequence() {return $this->sequence;}function setSequence($sequence) {$this->sequence=$sequence;}function getBinds() {return $this->binds;}function setBinds($binds) {$this->binds=$binds;}}?>
<?php class SOY2DAO_QueryBuilder{public static function buildQuery($methodName,$entityInfo,$noPersistents=array(),$columns=array(),$queryType=null){if(preg_match("/^insert|^create/",$methodName) || $queryType == "insert"){return SOY2DAO_InsertQueryBuilder::build($methodName,$entityInfo,$noPersistents,$columns);}if(preg_match("/^delete|^remove/",$methodName) || $queryType == "delete"){return SOY2DAO_DeleteQueryBuilder::build($methodName,$entityInfo,$noPersistents,$columns);}if(preg_match("/^update|^save|^write|^reset|^change/",$methodName) || $queryType == "update"){return SOY2DAO_UpdateQueryBuilder::build($methodName,$entityInfo,$noPersistents,$columns);}return SOY2DAO_SelectQueryBuilder::build($methodName,$entityInfo,$noPersistents,$columns);}protected static function build($methodName,$entityInfo,$noPersistents,$columns){return new SOY2DAO_Query();}}?>
<?php class SOY2DAO_DeleteQueryBuilder extends SOY2DAO_QueryBuilder{protected static function build($methodName,$entityInfo,$noPersistents,$columns){$query=new SOY2DAO_Query();$query->prefix="delete";$query->table=$entityInfo->table;$columns=$entityInfo->getColumns();if(preg_match('/By([a-zA-Z0-9]*)$/',$methodName,$tmp)){$param=$tmp[1];$column=$entityInfo->getColumn($param);if($column){$query->where=$column->name. "=:". $column->prop;}}else{foreach($columns as $key => $value){$column=$entityInfo->getColumn($key);if($column->isPrimary){$query->where=$column->name ."=:".$column->prop;}}}return $query;}}?>
<?php class SOY2DAO_InsertQueryBuilder extends SOY2DAO_QueryBuilder{protected static function build($methodName,$entityInfo,$noPersistents,$columns){$query=new SOY2DAO_Query();$query->prefix="insert";$query->table=$entityInfo->table;if(empty($columns)){$columns=$entityInfo->getColumns();}$columnString=array();foreach($columns as $key => $value){$column=$entityInfo->getColumnByName($value);if($column->isPrimary && !$column->sequence){continue;}$columnString[]=$column->name;}$sql="(".implode(",",$columnString).") ";$values=array();foreach($columns as $key => $value){$column=$entityInfo->getColumnByName($value);if($column->isPrimary && $column->sequence){$values[]="nextval('".$column->sequence."')";$query->sequence=$column->sequence;continue;}if($column->isPrimary){continue;}$values[]=":".$column->prop;}$sql.= "values(".implode(",",$values).") ";$query->sql=$sql;return $query;}}?>
<?php class SOY2DAO_SelectQueryBuilder extends SOY2DAO_QueryBuilder{protected static function build($methodName,$entityInfo,$noPersistents,$columns){$query=new SOY2DAO_Query();$query->prefix="select";$query->table=$entityInfo->table;$is_empty_column=false;if(empty($columns)){$columns=$entityInfo->getColumns(true);$is_empty_column=true;}$query->sql=implode(",",$columns);$tmp=array();if(preg_match('/By([a-zA-Z0-9]*)$/',$methodName,$tmp)){$param=$tmp[1];$column=$entityInfo->getColumn($param);if(!is_null($column)){$query->where=$column->name. "=:". $column->prop;}}if($is_empty_column && preg_match('/^count/',$methodName)){$query->sql="count(id) as count_id";}return $query;}}?>
<?php class SOY2DAO_UpdateQueryBuilder extends SOY2DAO_QueryBuilder{protected static function build($methodName,$entityInfo,$noPersistents,$columns){$query=new SOY2DAO_Query();$query->prefix="update";$query->table=$entityInfo->table;if(empty($columns)){$columns=$entityInfo->getColumns();}$sql=array();foreach($columns as $key => $value){$column=$entityInfo->getColumnByName($value);if(in_array($column->prop,$noPersistents)){continue;}if(in_array($column->name,$noPersistents)){continue;}if($column->isPrimary){$query->where=$column->name ."=:".$column->prop;}else{$sql[]=$column->name ."=:".$column->prop;}}$query->sql=implode(",",$sql);return $query;}}?>
<?php class SOY2DAO_QueryFactory extends SOY2DAO_Query{function prefix($prefix){$this->prefix=$prefix;return $this;}function table($table){$this->_table=$table;$this->table=$table;return $this;}function join($join,$on,$type=null){$this->joins[]=array($join,$on,$type);return $this;}function column(){$args=func_get_args();foreach($args as $arg){$this->columns[]=$arg;}return $this;}function where(){$args=func_get_args();foreach($args as $arg){$this->wheres[]=$arg;}return $this;}function orWhere(){$args=func_get_args();foreach($args as $arg){$this->orWheres[]=$arg;}return $this;}function order(){$args=func_get_args();foreach($args as $arg){if(is_array($arg)){$this->orders=array_merge($this->orders,$arg);}else{$this->orders[]=$arg;}}return $this;}function group(){$args=func_get_args();foreach($args as $arg){if(is_array($arg)){$this->groups=array_merge($this->groups,$arg);}else{$this->groups[]=$arg;}}return $this;}function distinct($flag=true){$this->disinct=$flag;return $this;}function having($having){$args=func_get_args();foreach($args as $arg){$this->havings[]=$arg;}return $this;}public $columns=array();public $wheres=array();public $orWheres=array();public $joins=array();public $groups=array();public $havings=array();public $orders=array();function __toString(){if(!empty($this->columns)){$this->sql=implode(",",$this->columns);}if(!empty($this->wheres)){$this->where=implode(" AND ",$this->wheres);}if(!empty($this->orWheres)){if(strlen($this->where)){$this->where .= " OR ";}$this->where .= implode(" OR ",$this->orWheres);}if(!empty($this->havings)){$this->having=implode(" AND ",$this->havings);}if(!empty($this->orders)){$this->order=implode(",",$this->orders);}if(!empty($this->groups)){$this->group=implode(",",$this->groups);}if(!empty($this->joins)){$table=$this->_table;foreach($this->joins as $array){$join=($array[2]) ? " ".$array[2]." join " : " join ";$table .= " ".$join . $array[0]." on (".$array[1].")";}$this->table=$table;}return parent::__toString();}}?>
<?php class SOY2DAO_QueryProfile {static $_stack=array();public static function prepare($query,$binds){$obj=new SOY2DAO_QueryProfile($query,$binds);array_push(self::$_stack,$obj);return $obj;}public static function show(){$array=self::$_stack;$analyze=array("time" => 0);$queries=array();foreach($array as $obj){if(!isset($queries[$obj->query]))$queries[$obj->query]=0;$queries[$obj->query]++;$analyze["time"] += $obj->profile["time"];}arsort($queries);echo "<table class='soy2dao-query-profile-table' border=1>";echo "<caption>query profile</caption>";echo "<tr>";echo "<th width=100>total</th><td>".count($array)." query</td>";echo "</tr><tr>";echo "<th width=100>total time</th><td>".$analyze["time"]."</td>";echo "</tr><tr>";echo "<th>queries</th>";echo "<td>";echo "<table><thead><th>count</th><td>query</td></tr></thead><tbody>";foreach($queries as $_query => $count){echo "<tr>";echo "<th>".$count."</th>";echo "<td>".$_query."</td>";echo "</tr>";}echo "</tbody></table>";echo "</td>";echo "</tr>";echo "<tr>";echo "<td colspan=3>";echo "<table>";foreach($array as $obj){echo "<tr>";echo "<td>";echo $obj->query;var_dump($obj->bind);echo "</td>";echo "</tr>";echo "<tr>";echo "<td>";var_dump($obj->profile);echo "</td>";echo "</tr>";}echo "</table>";echo "</td>";echo "</tr>";echo "</table>";}public static function result(){$obj=self::$_stack[count(self::$_stack)-1];$obj->profile["endtime"]=microtime(true);$obj->profile["time"]=microtime(true)-$obj->profile["starttime"];$obj->profile["endmemory"]=memory_get_usage(true);}function SOY2DAO_QueryProfile($query,$binds){$this->query=$query;$this->bind=$binds;$this->profile=array("starttime" => microtime(true),"memory" => memory_get_usage(true));}private $query;private $bind;private $profile;}?>
<?php class SOY2HTMLBase{private $_soy2_classPath;protected $_soy2_functions=array();protected function getClassPath(){if(is_null($this->_soy2_classPath)){$e=new SOY2HTMLException();$array=$e->getTrace();$class=get_class($this);foreach($array as $buff){$file=(isset($buff['file'])) ? $buff['file'] : '';if(strstr($file,$class)){$this->_soy2_classPath=str_replace("\\","/",$file);break;}}}return $this->_soy2_classPath;}function __call($name,$args){if(method_exists($this,"createAdd") && preg_match('/^add([A-Za-z]+)$/',$name,$tmp) && count($args)>0){$class="HTML".$tmp[1];if(class_exists($class)){$id=array_shift($args);$arguments =(count($args)>0 && is_array($args[0])) ? @$args[0] : array();$this->createAdd($id,$class,$arguments);if(isset($arguments["value"])){$this->createAdd($id."_text","HTMLLabel",array("text" => $arguments["value"]));}if(($name == "addTextarea") && isset($args["text"])){$this->createAdd($id."_text","HTMLLabel",array("text" => $arguments["text"]));}return;}}if(!$this->functionExists($name)){throw new SOY2HTMLException("method not fouund:".$name);}$func=$this->_soy2_functions[$name];$code=$func['code'];$argments=$func['args'];$variant="";for($i=0; $i<count($argments);$i++){$variant .= $argments[$i].'=$args['.$i.'];';}return eval($variant.$code.";");}function addFunction($name,$args,$code){$this->_soy2_functions[$name]['args']=$args;$this->_soy2_functions[$name]['code']=$code;}function functionExists($name){return array_key_exists($name,$this->_soy2_functions);}}abstract class SOY2HTML extends SOY2HTMLBase{const HTML_BODY='_HTML_BODY_';const SKIP_BODY='_SKIP_BODY_';const SOY_BODY ='_SOY_BODY_';const SOY_TYPE=SOY2HTML::HTML_BODY;const ENCODING='UTF-8';protected $tag="[a-zA-Z0-9]+|!--";protected $_soy2_id;protected $_soy2_parentId=null;protected $_soy2_parent=null;protected $_soy2_prefix="soy";protected $_soy2_pageParam="page";protected $_soy2_parentPageParam="page";protected $_soy2_isModified=true;protected $_soy2_outerHTML;protected $_soy2_innerHTML;public $_soy2_attribute=array();public $_attribute=array();protected $_soy2_style;protected $_soy2_visible=true;protected $_skip_end_tag=false;protected $_start_new_line=false;protected $_end_new_line=false;protected $_message_properties=array();protected $_soy2_permanent_attributes=array();abstract function getObject();function init(){}function execute(){if($this->getComponentType() == SOY2HTML::SKIP_BODY){return;}$this->_soy2_innerHTML ='<?php echo $'.$this->_soy2_pageParam.'["'.$this->_soy2_id.'"]; ?>';}function getSoy2Prefix(){return $this->_soy2_prefix;}function setSoy2Prefix($prefix){$this->_soy2_prefix=$prefix;}function setId($id){$this->_soy2_id=$id;}function getId(){return $this->_soy2_id;}function setParentId($id){$this->_soy2_parentId=$id;}function getParentId(){return $this->_soy2_parentId;}function setParentObject($obj){$this->_soy2_parent=$obj;}function getParentObject(){return $this->_soy2_parent;}function setPageParam($param){$this->_soy2_pageParam=$param;}function getPageParam(){return $this->_soy2_pageParam;}function setParentPageParam($param){$this->_soy2_parentPageParam=$param;}function getParentPageParam(){return $this->_soy2_parentPageParam;}function setTag($tag){$this->tag=$tag;}function getTag(){return $this->tag;}function getComponentType(){return eval("return ".get_class($this). "::SOY_TYPE;");}function setVisible($value){$this->_soy2_visible=(boolean)$value;}function getVisible(){return $this->_soy2_visible;}function setIsModified($value){$this->_soy2_isModified=$value;}function getIsModified(){return $this->_soy2_isModified;}function setInnerHTML($innerHTML){$this->_soy2_innerHTML=$innerHTML;}function getInnerHTML(){return $this->_soy2_innerHTML;}function setOuterHTML($outerHTML){$this->_soy2_outerHTML=$outerHTML;}function getOuterHTML(){return $this->_soy2_outerHTML;}function setSkipEndTag($boolean){$this->_skip_end_tag=$boolean;}function getIsSkipEndTag(){return $this->_skip_end_tag;}function setEndNewLine($boolean){$this->_end_new_line=$boolean;}function getEndNewLine(){return $this->_end_new_line;}function setStartNewLine($boolean){$this->_start_new_line=$boolean;}function getStartNewLine(){return $this->_start_new_line;}function _clear(){$this->_attribute=array();$this->_soy2_attribute=array();$this->_start_new_line=false;$this->_end_new_line=false;}function setContent($content){list($tag,$line,$innerHTML,$outerHTML,$value,$suffix,$skipendtag,$startnewline,$endnewline)=$this->parse("id",$this->_soy2_id,$content);$this->tag=$tag;$this->parseAttributes($line);$this->_soy2_innerHTML=$innerHTML;$this->_soy2_outerHTML=$outerHTML;$this->setSkipEndTag($skipendtag);$this->setStartNewLine($startnewline);$this->setEndNewLine($endnewline);}function parse($suffix,$value,$content){$result=array("tag" => "","line" => "","innerHTML" => "","outerHTML" => "","value" => "","suffix" => "","skipendtag" => false,"startnewline" => false,"endnewline" => false);if($content instanceof HTMLList_DummyObject) $content="";switch ($this->getComponentType()) {case SOY2HTML::HTML_BODY:$regex='/<(('.$this->tag.')[^<>]*\s'.$this->_soy2_prefix.':('.$suffix.')=\"('.$value.')\"\s?[^>]*)>/i';$tmp=array();if(preg_match($regex,$content,$tmp,PREG_OFFSET_CAPTURE)){$start=$tmp[0][1];$end=0;$endOffset=0;$tmpValue=str_replace("/","\/",$tmp[4][0]);$endTag=$tmp[2][0];$endPrefix=$this->_soy2_prefix;if($endTag != "!--"){$endTag='\/'. $endTag;}else{$endPrefix='\/' . $endPrefix;}if(strpos($tmpValue,"*") !== false)$tmpValue=str_replace("*","\\*",$tmpValue);$endRegex='/(<('.$endTag.')[^<>]*\s'.$endPrefix.':'.$suffix.'=\"'.$tmpValue.'\"\s?[^>]*>)\n?/';$endRegex_short='/(<!--\s?[^<]*\/'.$tmpValue.'\s?[^>]*-->)\n?/';$line=$tmp[1][0];$tag=$tmp[2][0];$suffix=$tmp[3][0];$value=$tmp[4][0];$result["line"]=$line;$result["tag"]=$tag;$result["suffix"]=$suffix;$result["value"]=$value;$innerHTML="";$outerHTML="";$line=trim($line);if(preg_match('/\/(--)?$/',$line) OR in_array(strtolower($tag),SOY2HTML::getEmptyTagList())){$outerHTML=$tmp[0][0];$result["skipendtag"]=true;$endOffset=$start + strlen($outerHTML) + 1;}else if(preg_match($endRegex,$content,$tmp2,PREG_OFFSET_CAPTURE)|| preg_match($endRegex_short,$content,$tmp2,PREG_OFFSET_CAPTURE,$tmp[1][1])){$startOffset=$tmp[1][1];$endOffset=$tmp2[1][1] + strlen($tmp2[1][0]);$outerHTML=substr($content,$startOffset-1,$endOffset-$startOffset + 1);$innerHTML=substr($content,$startOffset+strlen($tmp[1][0])+1,$tmp2[1][1]-($startOffset + strlen($tmp[1][0]))-1);}else{$i=$start + strlen($tmp[0][0]);while($i<strlen($content)){$buff=$content[$i];if($buff === "<" && $content[$i+1] === "/"){$buff=substr($content,$i,strlen("</".$tag));$end=$i + strlen("</".$tag);if($buff === "</".$tag){while($end<strlen($content)){$buff2=$content[$end];$buff .= $buff2;$end++;if($buff2 == ">"){break;}}break;}else{$buff=$content[$i];}}$innerHTML .= $buff;$i++;}$outerHTML=substr($content,$start,$end-$start);$endOffset=$end;}if(substr($content,$endOffset,1) == "\r" || substr($content,$endOffset,1) == "\n"){$result["endnewline"]=true;}$result["innerHTML"]=$innerHTML;$result["outerHTML"]=$outerHTML;}break;case SOY2HTML::SKIP_BODY:$regex='/(<(('.$this->tag.')[^<>]*\s'.$this->_soy2_prefix.':('.$suffix.')=\"('.$value.')\"\s?[^>]*\/?)>(\n)?)/i';$tmp=array();if(preg_match($regex,$content,$tmp)){$result["outerHTML"]=$tmp[1];$result["line"]=$tmp[2];$result["tag"]=$tmp[3];$result["suffix"]=$tmp[4];$result["value"]=$tmp[5];$result["skipendtag"]=true;if(isset($tmp[6]))$result["endnewline"]=true;}break;case SOY2HTML::SOY_BODY:$startRegex='/(<(('.$this->tag.')[^<>]*\s'.$this->_soy2_prefix.':('.$suffix.')=\"('.$value.')\"\s?[^>]*)>)/';$startRegex_comment='/(<((!--)[^<>]*\s'.$this->_soy2_prefix.':('.$suffix.')=\"('.$value.')\"\s?[^>]*)>)/';$tmp1=array();$tmp2=array();if(preg_match($startRegex_comment,$content,$tmp1,PREG_OFFSET_CAPTURE)){$endRegex_comment='/(<(!--)[^<>]*\s?\/'.$this->_soy2_prefix.':'.$suffix.'=\"'.$value.'\"\s?[^>]*>)/';$endRegex_comment_short='/(<(!--)[^<>]*\s?\/'.$value.'\s?[^>]*>)/';if(preg_match($endRegex_comment,$content,$tmp2,PREG_OFFSET_CAPTURE)|| preg_match($endRegex_comment_short,$content,$tmp2,PREG_OFFSET_CAPTURE,$tmp1[1][1])){$startOffset=$tmp1[1][1];$endOffset=$tmp2[1][1] + strlen($tmp2[1][0]);$result["line"]=$tmp1[2][0];$result["tag"]=$tmp1[3][0];$result["suffix"]=$tmp1[4][0];$result["value"]=$tmp1[5][0];$result["outerHTML"]=substr($content,$startOffset,$endOffset-$startOffset);$result["innerHTML"]=substr($content,$startOffset + strlen($tmp1[1][0]),$tmp2[1][1]-($startOffset + strlen($tmp1[1][0])));}}else if(preg_match($startRegex,$content,$tmp1,PREG_OFFSET_CAPTURE)){$tag=$tmp1[3][0];$endRegex='/(<\/('.$tag.')[^<>]*\s'.$this->_soy2_prefix.':'.$suffix.'=\"'.$value.'\"\s?[^>]*>)/';$endRegex_short='/(<\/('.$tag.')>)/';if(preg_match($endRegex,$content,$tmp2,PREG_OFFSET_CAPTURE)|| preg_match($endRegex_short,$content,$tmp2,PREG_OFFSET_CAPTURE,$tmp1[1][1])){$startOffset=$tmp1[1][1];$endOffset=$tmp2[1][1] + strlen($tmp2[1][0]);$result["line"]=$tmp1[2][0];$result["tag"]=$tmp1[3][0];$result["suffix"]=$tmp1[4][0];$result["value"]=$tmp1[5][0];$result["outerHTML"]=substr($content,$startOffset,$endOffset-$startOffset);$result["innerHTML"]=substr($content,$startOffset + strlen($tmp1[1][0]),$tmp2[1][1]-($startOffset + strlen($tmp1[1][0])));}}break;default:break;}if(strlen($result["innerHTML"]) > 0 && $result["tag"] == "!--" && ($result["innerHTML"][0] == "\r" || $result["innerHTML"][0] == "\n")){$result["startnewline"]=true;}return array($result["tag"],$result["line"],$result["innerHTML"],$result["outerHTML"],$result["value"],$result["suffix"],$result["skipendtag"],$result["startnewline"],$result["endnewline"]);}function parseAttributes($line){$regex ='/([a-zA-Z_:\-]*)\s*=\s*"([^"]*)"/';$tmp=array();if(preg_match_all($regex,$line,$tmp)){$keys=$tmp[1];$values=$tmp[2];foreach($keys as $i => $key){$key=strtolower($key);$value=html_entity_decode($values[$i],ENT_QUOTES,SOY2HTML::ENCODING);if(preg_match('/'.$this->_soy2_prefix.':/',$key)){$this->_soy2_attribute[$key]=$value;$this->setPermanentAttribute($key,$value);continue;}if($key == "style"){$this->_attribute[$key]=new SOY2HTMLStyle($value);continue;}$this->_attribute[$key]=$value;}}}function getContent(SOY2HTML $tag,$content){$in=$tag->_soy2_outerHTML;$tag->parseMessageProperty();$out="";switch ($tag->getComponentType()) {case SOY2HTML::SKIP_BODY:$out=$tag->getStartTag();break;case SOY2HTML::HTML_BODY:case SOY2HTML::SOY_BODY:$innerHTML=$tag->_soy2_innerHTML;if(strlen($innerHTML)){$tag->setSkipEndTag(false);}$out=$tag->getStartTag().$innerHTML.$tag->getEndTag();break;}list($start,$end)=$tag->getVisbleScript();$in=str_replace($in,$start.$out.$end,$content);$tmpTag="[a-zA-Z0-9]+|!--";$tag->tag=$tmpTag;while(true){list($tagName,$line,$innerHTML,$outerHTML,$value,$suffix,$skipendtag,$startnewline,$endnewline)=$tag->parse("id",$tag->_soy2_id.'\*',$in);if(strlen($tagName)<1){return $in;}$tag->_clear();$tag->setTag($tagName);$tag->parseAttributes($line);$tag->setInnerHTML($innerHTML);$tag->setOuterHTML($outerHTML);$tag->setSkipEndTag($skipendtag);$tag->setStartNewLine($startnewline);$tag->setEndNewLine($endnewline);$tag->execute();$this->_set($tag->getId(),$tag);$in=$this->getContent($tag,$in);$tag->setTag($tmpTag);}}function getStartTag(){if($this->tag == "!--"){if($this->getStartNewLine() && $this->getComponentType() == SOY2HTML::HTML_BODY){return "\n";}else if($this->getEndNewLine() && $this->getComponentType() == SOY2HTML::SKIP_BODY){return "\n";}else{return '';}}$attributes=array();foreach($this->_attribute as $key => $value){if(is_object($value)){$value=$value->__toString();}if(!preg_match("/$key=\"/i",$value)){$value=$key."=\"".htmlspecialchars((string)$value,ENT_QUOTES,SOY2HTML::ENCODING)."\"";}$attributes[]=$value;}$attribute=implode(" ",$attributes);$out='<'.$this->tag;if(strlen($attribute))$out .= ' '.$attribute;if($this->getComponentType() == SOY2HTML::SKIP_BODY){$out .= ' /';}else if($this->getIsSkipEndTag()){$out .= ' /';}$out .= '>';if($this->getEndNewLine() && $this->getComponentType() == SOY2HTML::SKIP_BODY){$out .= "\n";}if($this->getStartNewLine() != false){$out .= "\n";}return $out;}function getEndTag(){$suffix=($this->getEndNewLine()) ? "" : "";if($this->getIsSkipEndTag())return $suffix;if($this->tag == "!--")return $suffix;return '</'.$this->tag.'>' . $suffix;}function getVisbleScript(){return array('<?php if(!isset($'.$this->getPageParam().'["'.$this->getId().'_visible"]) || $'.$this->getPageParam().'["'.$this->getId().'_visible"]){ ?>'."\n",'<?php } ?>'."\n");}function getAttribute($key){$key=strtolower($key);return (isset($this->_attribute[$key]) && $this->_attribute[$key] !== true) ? $this->_attribute[$key] :(isset($this->_soy2_attribute[$key]) ? $this->_soy2_attribute[$key] : null);}function getAttributes(){return $this->_soy2_attribute;}function setAttribute($key,$value,$flag=true){$key=strtolower($key);$this->_attribute[$key]=$flag;$this->_soy2_attribute[$key]=$value;}function setPermanentAttribute($key,$value){if(!$this->getIsModified())return;$this->_soy2_permanent_attributes[$key]=$value;}function getPermanentAttribute($key=null){if(is_null($key)){return $this->_soy2_permanent_attributes;}if(isset($this->_soy2_permanent_attributes[$key])){return $this->_soy2_permanent_attributes[$key];}else{return null;}}function clearAttribute($key){$key=strtolower($key);$this->_attribute[$key]=null;$this->_soy2_attribute[$key]=null;unset($this->_attribute[$key]);unset($this->_soy2_attribute[$key]);}function &getStyle(){if(!isset($this->_soy2_attribute['style'])){$this->_soy2_attribute['style']=new SOY2HTMLStyle();}return $this->_soy2_attribute['style'];}function setStyle($style){if(!$style instanceof SOY2HTMLStyle){$style=new SOY2HTMLStyle($style);}$this->_soy2_attribute['style']=$style;$this->_attribute['style']="";}function addMessageProperty($key,$message){$this->_message_properties[$key]=$message;}function parseMessageProperty(){if($this->getIsModified()){foreach($this->_message_properties as $key => $message){$tmpKey="@@".$key.";";$this->_soy2_innerHTML=str_replace($tmpKey,$message,$this->_soy2_innerHTML);}}}function isMerge(){return false;}function _set($id,SOY2HTML &$obj,&$page=null){if(is_null($page)){$page=&WebPage::getPage($this->getParentId());}$value=$obj->getObject();if(isset($page[$id]) && is_array($value) && $obj->isMerge()){$page[$id]=array_merge($page[$id],$value);}else{$page[$id]=$value;}$attribute=$obj->_soy2_attribute;if(!empty($obj->_soy2_permanent_attributes))$this->_soy2_permanent_attributes[$id]=$obj->_soy2_permanent_attributes;foreach($attribute as $key => $value){if(!isset($obj->_attribute[$key]))continue;if(is_object($value))$value=$value->__toString();$page[$obj->getId()."_attribute"][$key]=htmlspecialchars((string)$value,ENT_QUOTES,SOY2HTML::ENCODING);if(!$obj->_attribute[$key]){$obj->_attribute[$key]='<?php if($'.$obj->getPageParam().'["'.$obj->getId().'_attribute"]["'.$key.'"]){ ?>' .$key.'="<?php echo $'.$obj->getPageParam().'["'.$obj->getId().'_attribute"]["'.$key.'"]; ?>"' .'<?php } ?>';}else{$obj->_attribute[$key]=$key.'="<?php echo $'.$obj->getPageParam().'["'.$obj->getId().'_attribute"]["'.$key.'"]; ?>"';}}$page[$obj->getId()."_visible"]=$obj->getVisible();}public static function getEmptyTagList(){return array("area","base","basefont","bgsound","br","embed","hr","img","input","link","meta","param");}public static function ToText($html,$encoding=SOY2HTML::ENCODING){return html_entity_decode(strip_tags($html),ENT_QUOTES,$encoding);}}class SOY2HTMLConfig{private function SOY2HTMLConfig(){}private $cacheDir="cache/";private $pageDir=array();private $templateDir=array();private $lang="";private $layoutDir=array();private $options=array();private static function &getInstance(){static $_static;if(!$_static){$_static=new SOY2HTMLConfig();}return $_static;}public static function CacheDir($dir=null){$config=self::getInstance();if($dir){if(substr($dir,strlen($dir)-1) != '/'){throw new SOY2HTMLException("[SOY2HTML]CacheDir must end by '/'.");}$config->cacheDir=str_replace("\\","/",$dir);}return $config->cacheDir;}public static function PageDirectories(){$config=self::getInstance();return $config->pageDir;}public static function PageDir($dir=null){$config=self::getInstance();if($dir){if(substr($dir,strlen($dir)-1) != '/'){throw new SOY2HTMLException("[SOY2HTML]PageDir must end by '/'.");}$config->pageDir[]=str_replace("\\","/",$dir);$config->pageDir=array_reverse($config->pageDir);}return (!empty($config->pageDir)) ? $config->pageDir[0] : null;}public static function TemplateDirectories(){$config=self::getInstance();return $config->templateDir;}public static function TemplateDir($dir=null){$config=self::getInstance();if($dir){if(substr($dir,strlen($dir)-1) != '/'){throw new SOY2HTMLException("[SOY2HTML]TemplateDir must end by '/'.");}$config->templateDir[]=str_replace("\\","/",$dir);$config->templateDir=array_reverse($config->templateDir);}return (!empty($config->templateDir)) ? $config->templateDir[0] : null;}public static function LayoutDirectories(){$config=self::getInstance();return $config->layoutDir;}public static function LayoutDir($dir=null){$config=self::getInstance();if($dir){if(substr($dir,strlen($dir)-1) != '/'){throw new SOY2HTMLException("[SOY2HTML]Layout Dir must end with '/'.");}$config->layoutDir[]=str_replace("\\","/",$dir);$config->layoutDir=array_reverse($config->layoutDir);}return (!empty($config->layoutDir)) ? $config->layoutDir[0] : null;}public static function Language($lang=null){$config=self::getInstance();if($lang){$config->lang=$lang;}return $config->lang;}public static function setOption($key,$value=null){$config=self::getInstance();if($value)$config->options[$key]=$value;return (isset($config->options[$key]) ) ? $config->options[$key] : null;}public static function getOption($key){return self::setOption($key);}}class SOY2HTMLFactory extends SOY2HTMLBase{public static function &createInstance($className,$attributes=array()){if(!class_exists($className)){try{self::importWebPage($className);}catch(SOY2HTMLException $e){throw new SOY2HTMLException("[SOY2HTML]Class ".$className. " is undefined.");}}$tmp=array();preg_match('/\.([a-zA-Z0-9_]+$)/',$className,$tmp);if(count($tmp)){$className=$tmp[1];}if(isset($attributes['arguments'])){$class=new $className($attributes['arguments']);$attributes['arguments']=null;unset($attributes['arguments']);}else{$class=new $className();}foreach($attributes as $key => $value){if($key == "id"){$class->setAttribute($key,$value);continue;}if(strpos($key,"attr:") !== false){$key=substr($key,5);$class->setAttribute($key,$value);continue;}if(method_exists($class,"set".ucwords($key))  || $class->functionExists("set".ucwords($key))){$func="set".ucwords($key);$class->$func($value);continue;}if(stristr($key,':function')){$key=trim($key);$funcName=str_replace(strstr($key,":function"),"",$key);$argsRegex='/:function\s*\((.*)\)$/';$tmp=array();if(preg_match($argsRegex,$key,$tmp)){$args=explode(",",$tmp[1]);}else{continue;}$code=$value;$class->addFunction($funcName,$args,$code);continue;}$class->setAttribute($key,$value);}return $class;}public static function importWebPage($className){if(self::pageExists($className) == false){throw new SOY2HTMLException();}$pageDirectories=SOY2HTMLConfig::PageDirectories();$path=str_replace(".","/",$className);$extension=".class.php";foreach($pageDirectories as $pageDir){if(file_exists($pageDir.$path.$extension)){include_once($pageDir.$path.$extension);break;}}}public static function pageExists($className){$pageDir=SOY2HTMLConfig::PageDir();$path=str_replace(".","/",$className);$extension=".class.php";if(defined("SOY2HTML_AUTO_GENERATE") && SOY2HTML_AUTO_GENERATE == true && !file_exists($pageDir.$path.$extension) && file_exists($pageDir.$path.".html")){self::generateWebPage($className,$pageDir.$path);}$pageDirectories=SOY2HTMLConfig::PageDirectories();$res=false;foreach($pageDirectories as $pageDir){if(file_exists($pageDir.$path.$extension)){$res=true;break;}}if(!$res)return false;$tmp=array();preg_match('/\.([a-zA-Z0-9_]+$)/',$className,$tmp);if(count($tmp)){$className=$tmp[1];}return $className;}private static function generateWebPage($className,$path){$templatePath=$path.".html";$fullPath=$path.".class.php";$dirpath=dirname($fullPath);while(file_exists($dirpath) == false){if(!mkdir($dirpath))return;$dirpath=dirname($dirpath);}$docComment=array();$docComment[]="/**";$docComment[]=" * @class $className";$docComment[]=" * @date ".date("c");$docComment[]=" * @author SOY2HTMLFactory";$docComment[]=" */ ";$tmp=array();preg_match('/\.([a-zA-Z0-9_]+$)/',$className,$tmp);if(count($tmp)){$tmpClassName=$tmp[1];}else{$tmpClassName=$className;}$class=array();$class[]="class ".$tmpClassName." extends WebPage{";$class[]="";$class[]='function '.$tmpClassName.'(){';$class[]="WebPage::WebPage();";$soyIds=array();$tmpSoyIds=array();$templates=file($templatePath);$regex='/<([^>^\s]*)[^>]*(\/)?soy:id=\"([a-zA-Z][a-zA-Z0-9_]+)\"\s?[^>]*>/i';foreach($templates as $str){if(!preg_match($regex,$str,$tmp))continue;$tag=$tmp[1];$isEnded=(boolean)(strlen($tmp[2]) OR $tag[0] == "/");$soyId=$tmp[3];if($isEnded && isset($tmpSoyIds[$soyId])){$childSoyIds=array();$tmpKeys=array_keys($tmpSoyIds);$tmpKeys=array_reverse($tmpKeys);foreach($tmpKeys as $value){if($value == $soyId){$tmpSoyIds[$soyId]["child"]=array_reverse($childSoyIds);$soyIds += array_reverse($tmpSoyIds);$tmpSoyIds=array();break;}$childSoyIds[$value]=$tmpSoyIds[$value];unset($tmpSoyIds[$value]);}continue;}$tmpSoyIds[$soyId]=array("tag" => $tag,"child" => array());}list($result,$classes)=self::generateCreateAdd($soyIds);$class[]=implode("\n\t\t",$result);$class[]="}";$class[]="}";$class[]="";$class[]=implode("\n",$classes);file_put_contents($fullPath,"<?php \n".implode("\n",$docComment) ."\n". implode("\n",$class)."\n?>");}private static function generateCreateAdd($soyIds,$className="HTMLLabel"){$keys=array_keys($soyIds);$script=array();$classes=array();foreach($keys as $key){$className="HTMLLabel";$createKey=array("text");$script[]='';if($soyIds[$key]["tag"] == "input"){$className="HTMLInput";$createKey=array("name" => $key,"value" => "");}if($soyIds[$key]["tag"] == "select"){$className="HTMLSelect";$createKey=array("name" => $key,"options" => array(),"selected" => "");}if($soyIds[$key]["tag"] == "textarea"){$className="HTMLTextArea";$createKey=array("name" => $key,"value" => "");}if(preg_match('/_link$/',$key)){$className="HTMLLink";$createKey=array("link");}if(preg_match('/_form$/',$key)){$className="HTMLForm";list($tmpScript,$tmpClass)=self::generateCreateAdd($soyIds[$key]["child"]);$script[]='$this->createAdd("'.$key.'","'.$className.'");';$script=array_merge($script,$tmpScript);$classes=array_merge($classes,$tmpClass);continue;}if(preg_match('/_list$/',$key)){$className=str_replace("_list","List",ucwords($key));list($tmpScript,$tmpClass)=self::generateCreateAdd($soyIds[$key]["child"]);$script[]='$this->createAdd("'.$key.'","'.$className.'",array(';$script[]="\t".'"list" => array()';$script[]='));';$classes[]='';$classes[]='/**';$classes[]=' * @class '.$className;$classes[]=' * @generated by SOY2HTML';$classes[]=' */';$classes[]='class '.$className.' extends HTMLList{';$classes[]="\t".'protected function populateItem($entity){';$classes[]="\t\t".implode("\n\t\t",$tmpScript);$classes[]="\t".'}';$classes[]='}';$classes=array_merge($classes,$tmpClass);continue;}list($tmpScript,$tmpClass)=self::generateCreateAdd($soyIds[$key]["child"]);$script[]='$this->createAdd("'.$key.'","'.$className.'",array(';foreach($createKey as $tmpCreateKey => $defaultValue){if(is_numeric($tmpCreateKey)){$tmpCreateKey=$defaultValue;$defaultValue="";}if(is_string($defaultValue)){$defaultValue='"'.$defaultValue.'"';}if(is_array($defaultValue)){$defaultValue='array()';}if(!strlen($defaultValue))$defaultValue='""';$script[]="\t".'"'.$tmpCreateKey.'" => '.$defaultValue.',';}$script[]='));';$script=array_merge($script,$tmpScript);$classes=array_merge($classes,$tmpClass);}return array($script,$classes);}}class SOY2HTMLException extends Exception{}?>
<?php class SOY2HTMLCache{public static function config($key,$val){SOY2HTMLCacheImpl::getInstance()->config($key,$val);}public static function is(){$key=self::flatten(func_get_args());return SOY2HTMLCacheImpl::getInstance()->is($key);}public static function out(){$key=self::flatten(func_get_args());return SOY2HTMLCacheImpl::getInstance()->out($key);}public static function start(){$key=self::flatten(func_get_args());return SOY2HTMLCacheImpl::getInstance()->start($key);}public static function cache(){$key=self::flatten(func_get_args());return SOY2HTMLCacheImpl::getInstance()->cache($key);}public static function clear(){$key=self::flatten(func_get_args());return SOY2HTMLCacheImpl::getInstance()->clear($key);}public static function info(){$key=self::flatten(func_get_args());return SOY2HTMLCacheImpl::getInstance()->info($key);}private static function flatten($array){$return=array();foreach($array as $key=>$value) {if (is_array($value)) {$return=array_merge($return,self::flatten($value));}else{$return[]=$value;}}return $return;}}class SOY2HTMLCacheImpl{public static function getInstance(){static $_inst;if(!$_inst){$_inst=new SOY2HTMLCacheImpl();$_inst->config("cache_dir",SOY2HTMLConfig::CacheDir());}return $_inst;}private $_start=array();private $_configs=array();function config($key,$value=null){if($value){$this->_configs[$key]=$value;}if(!isset($this->_configs[$key])){return null;}return $this->_configs[$key];}function is($keys){if(!is_array($keys))$keys=array($keys);$dir=$this->config("cache_dir");$now=time();$path=$this->getCacheFilePath($keys);if(!file_exists($path))return false;$lastModified=filemtime($path);foreach($keys as $key){$path=$dir . $key.".key";if(!file_exists($path))return false;if(filemtime($path) > $lastModified)return false;if(file_get_contents($path) < $now)return false;}return true;}function clear($keys){if(!is_array($keys))$keys=array($keys);$dir=$this->config("cache_dir");$res=array();foreach($keys as $key){$path=$dir . $key.".key";if(!file_exists($path))continue;$res[]=$path;file_put_contents($path,-1);}return (count($res)>0) ? $res : false;}function out($keys){if(!is_array($keys))$keys=array($keys);$key=md5(implode("/",$keys));if(in_array($key,$this->_start)){$html=$this->cache($keys);echo $html;return;}$path=$this->getCacheFilePath($keys);echo file_get_contents($path);}function start($keys){if(!is_array($keys))$keys=array($keys);$this->_start[]=md5(implode("/",$keys));ob_start();register_shutdown_function(array($this,"out"),$keys);}function info($keys){if(!is_array($keys))$keys=array($keys);$dir=$this->config("cache_dir");$lifetime=null;foreach($keys as $key){$path=$dir . $key.".key";if(!file_exists($path))continue;$lifetime=(is_null($lifetime)) ? file_get_contents($path) : min($lifetime,file_get_contents($path));}return array("time" => filemtime($this->getCacheFilePath($keys)),"lifetime" => $lifetime);}function cache($keys){if(!is_array($keys))$keys=array($keys);$dir=$this->config("cache_dir");$limit=$this->config("limit");if($limit){$lifetime=strtotime($limit);}else{$lifetime=$this->config("lifetime");if(!$lifetime)$lifetime=24 * 60 * 60;$lifetime=time() + $lifetime;}$html=ob_get_clean();foreach($keys as $key){file_put_contents($dir . $key .".key",$lifetime);}$path=$this->getCacheFilePath($keys);file_put_contents($path,$html);return $html;}function getCacheFilePath($keys){if(!is_array($keys))$keys=array($keys);$cacheDir=$this->config("cache_dir");$path=str_replace(array("/"),"_",implode("-",$keys));$cache="{$cacheDir}{$path[0]}/{$path}.html";if(!file_exists("{$cacheDir}{$path[0]}")){mkdir("{$cacheDir}{$path[0]}",0777,true);}return $cache;}}?>
<?php class SOYBodyComponentBase extends SOY2HTML{protected $_components=array();protected $_tmpList=array();protected $_childSoy2Prefix ="soy";const SOY_TYPE=SOY2HTML::SOY_BODY;function add($id,$obj){$obj->setId($id);$obj->setParentObject($this);$obj->init();$this->_components[$id]=$obj;}function createAdd($id,$className,$array=array()){if(!isset($array["soy2prefix"]) && $this->_childSoy2Prefix){$array["soy2prefix"]=$this->_childSoy2Prefix;$array["childSoy2Prefix"]=$this->_childSoy2Prefix;}$obj=SOY2HTMLFactory::createInstance($className,$array);if($this->_soy2_innerHTML == false){if(isset($this->_soy2_permanent_attributes[$id])){foreach($this->_soy2_permanent_attributes[$id] as $key => $value){$obj->_soy2_attribute[$key]=$value;$obj->_soy2_permanent_attributes[$key]=$value;}}}$this->add($id,$obj);}function getStartTag(){return '<?php $'.$this->getId().'=$'.$this->getPageParam().'["'.$this->getId().'"]; ?>'.parent::getStartTag();}function getObject(){return $this->_tmpList;}function execute(){$innerHTML=$this->getInnerHTML();if($innerHTML){$keys=array_values($this->getComponentsList());$oldval=$this->getPermanentAttribute("_components");if($oldval){$keys=array_unique(array_merge($keys,$oldval));}$this->setPermanentAttribute("_components",$keys);}$tmpList=array();foreach($this->_components as $key => $obj){if($obj instanceof HTMLPage){$obj->setParentPageParam($this->getId());}$obj->setParentId($this->getId());$obj->setPageParam($this->getId());$obj->setContent($innerHTML);$obj->execute();$this->_set($key,$obj,$tmpList);if($innerHTML){$innerHTML=$this->getContent($obj,$innerHTML);}}$this->_tmpList=$tmpList;$this->setInnerHTML($innerHTML);}function setChildSoy2Prefix($prefix){$this->_childSoy2Prefix=$prefix;}function isMerge(){return true;}function getComponentsList($prefix=""){$content=$this->getInnerHTML();if($content == false){if(isset($this->_soy2_permanent_attributes["_components"])){return $this->_soy2_permanent_attributes["_components"];}return array();}$res=array();if($prefix)$prefix=$this->_soy2_prefix;if(preg_match_all("/${prefix}:id=\"([^\"\*]+)\*?\"/",$content,$tmp)){$res=array_unique($tmp[1]);}return $res;}}class SOY2HTMLElement extends SOY2HTML{const TEXT_ELEMENT="_text_element_";var $_elements=array();var $_innerHTML;var $_tag;public static function &createElement($tag){return SOY2HTMLFactory::createInstance("SOY2HTMLElement",array("elementTag" => $tag));}public static function &createTextElement($text){$ele= SOY2HTMLFactory::createInstance("SOY2HTMLElement",array("elementTag" => SOY2HTMLElement::TEXT_ELEMENT));$ele->_innerHTML=htmlspecialchars($text,ENT_QUOTES,SOY2HTML::ENCODING);return $ele;}public static function &createHtmlElement($html){$ele= SOY2HTMLFactory::createInstance("SOY2HTMLElement",array("elementTag" => SOY2HTMLElement::TEXT_ELEMENT));$ele->_innerHTML=$html;return $ele;}function setElementTag($tag){$this->_tag=$tag;}function getStartTag(){return "";}function getEndTag(){return "";}function setAttribute($key,$value,$flag=true){$this->_attribute[$key]=$value;}function getObject(){return $this->toHTML();}function toHTML(){$this->tag=$this->_tag;if($this->tag == SOY2HTMLElement::TEXT_ELEMENT){return $this->_innerHTML;}$html=SOY2HTML::getStartTag();$innerHTML="";foreach($this->_elements as $ele){$innerHTML .= $ele->toHTML();}if(strlen($innerHTML)){$html .= $innerHTML;$html .= SOY2HTML::getEndTag();}else{$html=preg_replace('/>$/','/>',$html);}return $html;}function appendChild(SOY2HTMLElement &$ele){$this->_elements[]=$ele;}}class SOY2HTMLStyle{var $_styles=array();function SOY2HTMLStyle($style=""){$styles=explode(";",$style);foreach($styles as $str){if(!strstr($str,":"))continue;$array=explode(":",$str,2);$this->_styles[$array[0]]=$array[1];}}function __toString(){$style='';foreach($this->_styles as $key => $value){if(!strlen($key) OR !strlen($value))continue;$style .= "$key:$value;";}return $style;}function __set($key,$value){$key=preg_replace_callback('/[A-Z]/',create_function('$word','return \'-\'.strtolower($word[0]);'),$key);$this->_styles[$key]=$value;}function __get($key){$key=preg_replace_callback('/[A-Z]/',create_function('$word','return \'-\'.strtolower($word[0]);'),$key);return $this->_styles[$key];}}class HTMLModel extends SOY2HTML{const SOY_TYPE=SOY2HTML::HTML_BODY;function execute(){}function getObject(){return "";}}?>
<?php class HTMLCSS extends SOY2HTML{var $tag="style";const SOY_TYPE=SOY2HTML::HTML_BODY;var $text="";function execute(){$this->setAttribute("type","text/css");parent::execute();}function setStyle($text){$this->text=$text;}function getObject(){return $this->text;}}?>
<?php class HTMLCSSLink extends SOY2HTML{var $tag="link";const SOY_TYPE=SOY2HTML::SKIP_BODY;var $link;function setLink($link){$this->link=$link;}function execute(){$this->setAttribute("href",$this->link);}function getObject(){return $this->link;}}?>
<?php class HTMLForm extends SOYBodyComponentBase{var $tag="form";var $action;var $_method="post";private $disabled;function setTag($tag){throw new SOY2HTMLException("[HTMLForm]タグの書き換えは不可です。");}function setMethod($method){$this->_method=$method;}function setAction($action){$this->action=$action;}function setTarget($target){$this->setAttribute("target",$target);}function getStartTag(){if($this->_method == "post"){$token='<input type="hidden" name="soy2_token" value="<?php echo soy2_get_token(); ?>" />';return parent::getStartTag() . $token;}return parent::getStartTag();}function execute(){SOYBodyComponentBase::execute();if($this->action){$this->setAttribute("action",$this->action);}else{$this->setAttribute("action",@$_SERVER["REQUEST_URI"]);}$this->setAttribute('method',$this->_method);$disabled=($this->disabled) ? "disabled" : null;$this->setAttribute("disabled",$disabled,false);}function setOnSubmit($value){if(!preg_match("/^javascript:/i",$value)){$value="javascript:".$value;}$this->setAttribute("onsubmit",$value);}function getDisabled() {return $this->disabled;}function setDisabled($disabled) {$this->disabled=$disabled;}}class HTMLUploadForm extends HTMLForm{function execute(){parent::execute();$this->setAttribute("enctype","multipart/form-data");}}abstract class HTMLFormElement extends SOY2HTML{var $name;private $disabled;private $readonly;function execute(){parent::execute();$disabled=($this->disabled) ? "disabled" : null;$this->setAttribute("disabled",$disabled,false);$readonly=($this->readonly) ? "readonly" : null;$this->setAttribute("readonly",$readonly,false);}function setName($value){$this->name=$value;$this->setAttribute("name",$value);}function getDisabled() {return $this->disabled;}function setDisabled($disabled) {$this->disabled=$disabled;}function getReadonly() {return $this->readonly;}function setReadonly($readonly) {$this->readonly=$readonly;}}class HTMLInput extends HTMLFormElement{const SOY_TYPE=SOY2HTML::SKIP_BODY;var $tag="input";var $value;var $type;function setValue($value){$this->value=$value;}function execute(){parent::execute();$this->setAttribute("value",$this->value);}function getObject(){return $this->value;}function setType($value){$this->type=$value;$this->setAttribute("type",$this->type);}function getType(){return $this->type;}}class HTMLHidden extends HTMLInput{function execute(){parent::execute();$this->setAttribute("type","hidden");}}class HTMLTextArea extends HTMLFormElement{var $tag="textarea";const SOY_TYPE=SOY2HTML::HTML_BODY;var $text;function setText($value){$this->text=$value;}function setValue($value){$this->text=$value;}function getText(){return (string) $this->text;}function getObject(){return "\n".htmlspecialchars($this->getText(),ENT_QUOTES,SOY2HTML::ENCODING);}}class HTMLSelect extends HTMLFormElement {var $tag="select";const SOY_TYPE=SOY2HTML::HTML_BODY;var $options;var $selected;var $indexOrder=false;var $property;var $each ="";function setOptions($options){$this->options=$options;}function setSelected($selected){$this->selected=$selected;}function setIndexOrder($flag=true){$this->indexOrder=$flag;}function setIndex($value){$this->setIndexOrder($value);}function setProperty($name){$this->property=$name;}function setEach($each){$attr=array();foreach($each as $key => $value){$attr[]=htmlspecialchars((string)$key,ENT_QUOTES,SOY2HTML::ENCODING).'="'.htmlspecialchars((string)$value,ENT_QUOTES,SOY2HTML::ENCODING).'"';}$this->each=implode(" ",$attr);if(strlen($this->each) > 0){$this->each=" ".$this->each;}}function execute(){$innerHTML =$this->getInnerHTML();parent::execute();$this->setInnerHTML($innerHTML.$this->getInnerHTML());}function getObject(){$isHash=(array_keys($this->options) === range(0,count($this->options)-1)) ? false : true;if($this->indexOrder){$isHash=true;}$buff="";$selected='';foreach($this->options as $key => $value){$key=(string)$key;if(is_object($value) && $this->property){$propName=$this->property;$funcName="get".ucwords($propName);if(method_exists($value,$funcName)){$value=$value->$funcName();}else{$value=$value->$propName;}}if($isHash){$selected=($this->selected($key)) ? ' selected="selected"' : '';}else{$selected=($this->selected($value)) ? ' selected="selected"' : '';}if($isHash){$buff .= "<option value=\"".htmlspecialchars((string)$key,ENT_QUOTES,SOY2HTML::ENCODING)."\"$selected".$this->each.">".strip_tags((string)$value)."</option>";}else{$buff .= "<option$selected".$this->each.">".strip_tags((string)$value)."</option>";}$buff .= "\r\n";}return $buff;}function selected($value){if(is_array($this->selected)){return in_array($value,$this->selected);}else{return ($value == $this->selected);}}function setValue($value){$this->setSelected($value);}}class HTMLCheckBox extends HTMLInput {var $label;var $elementId;var $selected;var $type="checkbox";var $isBoolean;function setLabel($label){$this->label=$label;}function setSelected($selected){$this->selected=$selected;}function setElementId($elementId){$this->elementId=$elementId;}function getStartTag(){$pref="";$tag='<?php if(strlen($'.$this->getPageParam().'["'.$this->getId().'"])>0){ ?><label for="<?php echo $'.$this->getPageParam().'["'.$this->getId().'_attribute"]["id"]; ?>">'.'<?php echo $'.$this->getPageParam().'["'.$this->getId().'"]; ?></label><?php } ?>';if($this->isBoolean()){$pref='<input type="hidden" name="<?php echo $'.$this->getPageParam().'["'.$this->getId().'_attribute"]["name"]; ?>" value="0" />';}return $pref . parent::getStartTag() . $tag;}function execute(){parent::execute();if(!$this->elementId){$this->elementId="label_".md5(crypt((string)$this->value));}$this->setAttribute("id",$this->elementId);$checked=($this->selected) ? "checked" : null;$this->setAttribute("checked",$checked,false);}function getLabel(){return (string) $this->label;}function getObject(){return htmlspecialchars($this->getLabel(),ENT_QUOTES,SOY2HTML::ENCODING);}function setIsBoolean($flag){$this->isBoolean=$flag;}function isBoolean(){return (boolean)$this->isBoolean;}}class HTMLDateInput extends HTMLInput{function getStartTag(){return $this->getWrapperStart() . $this->getWrapperEnd();}function setValue($value){if(!is_numeric($value) && strlen($value)>0){$value=time();}$array=array("date" => (strlen($value)>0) ? date("Y-m-d",$value) : "","time" => (strlen($value)>0) ? date("H:i",$value) : "");parent::setValue($array);}function getWrapperStart(){$html=array();$html[]='<input type="text" class="<?php echo @$'.$this->getPageParam().'["'.$this->getId().'_attribute"]["class"]; ?> date-input" size="11" name="<?php echo $'.$this->getPageParam().'["'.$this->getId().'_attribute"]["name"]; ?>[0]" value="<?php echo $'.$this->getPageParam().'["'.$this->getId().'"]["date"]; ?>" />';$html[]='@<input type="text" class="<?php echo @$'.$this->getPageParam().'["'.$this->getId().'_attribute"]["class"]; ?> time-input" size="9" name="<?php echo $'.$this->getPageParam().'["'.$this->getId().'_attribute"]["name"]; ?>[1]" value="<?php echo $'.$this->getPageParam().'["'.$this->getId().'"]["time"]; ?>" />';return implode("",$html);}function getWrapperEnd(){return '';}}?>
<?php class HTMLHead extends SOY2HTML{var $tag="head";var $title;var $isEraseHead=false;const SOY_TYPE=SOY2HTML::HTML_BODY;const HEAD_SCRIPT="_script_";const HEAD_LINK="_link_";const HEAD_META="_meta_";function setTitle($title){$this->title=$title;}function getTitle(){return htmlspecialchars((string)$this->title,ENT_QUOTES,SOY2HTML::ENCODING);}function setIsEraseHead($boolean){$this->isEraseHead=(boolean)$boolean;}function getIsEraseHead(){return $this->isEraseHead;}protected static function &getHeads(){static $_array;if(!$_array){$_array=array(self::HEAD_SCRIPT => array(),self::HEAD_LINK => array(),self::HEAD_META => array());}return $_array;}public static function addMeta($key,$array){$heads=&HTMLHead::getHeads();$heads[self::HEAD_META][$key]=$array;}public static function clearMeta($key){$heads=&HTMLHead::getHeads();$heads[self::HEAD_META][$key]=null;unset($heads[self::HEAD_META][$key]);}public static function addLink($key,$array){$heads=&HTMLHead::getHeads();$heads[self::HEAD_LINK][$key]=$array;}public static function clearLink($key){$heads=&HTMLHead::getHeads();$heads[self::HEAD_LINK][$key]=null;unset($heads[self::HEAD_LINK][$key]);}public static function addScript($key,$array){$heads=&HTMLHead::getHeads();$heads[self::HEAD_SCRIPT][$key]=$array;}public static function clearScript($key){$heads=&HTMLHead::getHeads();$heads[self::HEAD_SCRIPT][$key]=null;unset($heads[self::HEAD_SCRIPT][$key]);}function execute(){if($this->getIsModified() != true){return;}if($this->isEraseHead){$this->setInnerHTML("");}$innerHTML=$this->getInnerHTML();$innerHTML .= '<?php echo $'.$this->getPageParam().'["'.$this->getId().'"]["metas"]; ?>';$innerHTML .= '<?php echo $'.$this->getPageParam().'["'.$this->getId().'"]["links"]; ?>';$innerHTML .= '<?php echo $'.$this->getPageParam().'["'.$this->getId().'"]["scripts"]; ?>';$innerHTML .= "\n";if(preg_match('/<\/title>/i',$innerHTML)){$innerHTML=preg_replace('/<\/title>/i','<?php echo $'.$this->getPageParam().'["'.$this->getId().'"]["title"]; ?></title>',$innerHTML);}else{$innerHTML .= '<title><?php echo $'.$this->getPageParam().'["'.$this->getId().'"]["title"]; ?></title>'."\n";}$this->setInnerHTML($innerHTML);}function getObject(){return array("title"   => $this->getTitle(),"metas"   => HTMLHead::getMetaHTML(),"links" => HTMLHead::getLinkHTML(),"scripts"   => HTMLHead::getScriptHTML(),);}function getMetaHTML(){$array=HTMLHead::getHeads();$metaArray=array();$metas=$array[self::HEAD_META];foreach($metas as $akey => $avalue){$attributes=array();foreach($avalue as $key => $value){$attributes[$key]=$key.'="'.htmlspecialchars((string)$value,ENT_QUOTES,SOY2HTML::ENCODING).'"';}$metaArray[$akey]='<meta '.implode(" ",$attributes).'/>';}return  ((!empty($metaArray)) ? "\n" : "") . implode("\n",$metaArray);}function getScriptHTML(){$array=HTMLHead::getHeads();$scriptArray=array();$scripts=$array[self::HEAD_SCRIPT];foreach($scripts as $akey => $avalue){$attributes=array();$body="";foreach($avalue as $key => $value){$key=strtolower($key);if($key == "script"){$body="<!--\n".$value."\n-->";continue;}if($key == "src"){}$attributes[$key]=$key.'="'.htmlspecialchars((string)$value,ENT_QUOTES,SOY2HTML::ENCODING).'"';}if(!array_key_exists("type",$attributes)){$attributes["type"]='type="text/JavaScript"';}if(!array_key_exists("charset",$attributes)){$attributes["charset"]='charset="utf-8"';}$scriptArray[$akey]='<script '.implode(" ",$attributes).'>'.( (strlen($body) >0) ? "\n".$body."\n" : "" ).'</script>';}return ((!empty($scriptArray)) ? "\n" : "") . implode("\n",$scriptArray);}function getLinkHTML(){$array=HTMLHead::getHeads();$linkArray=array();$links=$array[self::HEAD_LINK];foreach($links as $akey => $avalue){$attributes=array();foreach($avalue as $key => $value){$attributes[$key]=$key.'="'.htmlspecialchars((string)$value,ENT_QUOTES,SOY2HTML::ENCODING).'"';}$linkArray[$akey]='<link '.implode(" ",$attributes).'/>';}return ((!empty($linkArray)) ? "\n" : "") . implode("\n",$linkArray);}}?>
<?php class HTMLImage extends SOY2HTML{var $src;const SOY_TYPE=SOY2HTML::SKIP_BODY;function setSrc($path){$this->src=$path;}function setImagePath($path){$this->setSrc($path);}function execute(){$this->setAttribute("src",$this->src);}function getObject(){return $this->src;}function setAlt($alt){$this->setAttribute("alt",$alt);}}?>
<?php class HTMLLabel extends SOY2HTML{const SOY_TYPE=SOY2HTML::HTML_BODY;var $text;private $width;private $isFolding;private $foldingTag="<br />";private $isHtml=false;private $suffix="...";function setText($text){$this->text=(string)$text;}function getText(){return (string)$this->text;}function setHtml($html){$this->text=(string)$html;$this->isHtml=true;}function setTexts($text){$this->text=nl2br(htmlspecialchars($text));$this->isHtml=true;}function getObject(){$text=$this->getText();if($this->isHtml){return $text;}else{if(strlen($this->width) >0){if($this->isFolding != true){$width=max(0,$this->width-mb_strwidth($this->suffix));$short_text=mb_strimwidth($text,0,$width);if(mb_strwidth($short_text) < mb_strwidth($text)){$short_text .= $this->suffix;}if(mb_strwidth($short_text) < mb_strwidth($text)){$text=$short_text;}return htmlspecialchars($text,ENT_QUOTES,SOY2HTML::ENCODING);}else{$folded="";while(strlen($text)>0){$tmp=mb_strimwidth($text,0,$this->width);$text=mb_substr($text,mb_strlen($tmp));$folded .= htmlspecialchars($tmp,ENT_QUOTES,SOY2HTML::ENCODING);if(strlen($text) >0) $folded .= $this->foldingTag;}return $folded;}}else{return htmlspecialchars($text,ENT_QUOTES,SOY2HTML::ENCODING);}}}function setWidth($width){$this->width=$width;}function setIsFolding($flag){$this->isFolding=(boolean)$flag;}function setFoldingTag($tag){$this->foldingTag=$tag;}public function getSuffix() {return $this->suffix;}public function setSuffix($suffix) {$this->suffix=$suffix;}}class HTMLDateLabel extends HTMLLabel{private $defaultFormat=null;function execute(){$prefix=$this->_soy2_prefix;$format=$this->getAttribute($prefix.":format");if(!$format){if(is_null($this->defaultFormat) || strlen($this->defaultFormat) == 0){$format="Y-m-d(W) H:i:s";}else{$format=$this->defaultFormat;}}$pubdate=$this->getAttribute($prefix.":pubdate");if($pubdate){$this->setAttribute("pubdate",soy2_date($pubdate,$this->text));}$datetime=$this->getAttribute($prefix.":datetime");if($datetime){$this->setAttribute("datetime",soy2_date($datetime,$this->text));}$this->setText($this->text);$this->_soy2_innerHTML ='<?php echo soy2_date("'.addslashes($format).'",$'.$this->_soy2_pageParam.'["'.$this->_soy2_id.'"]); ?>';}function getDefaultFormat() {return $this->defaultFormat;}function setDefaultFormat($defaultFormat) {$this->defaultFormat=$defaultFormat;}function setValue($value){$this->setText($value);}}?>
<?php class HTMLLink extends HTMLLabel{var $tag="a";const SOY_TYPE=SOY2HTML::HTML_BODY;var $link;function getStartTag(){return '<?php if(strlen($'.$this->getPageParam().'["'.$this->getId().'_attribute"]["href"])>0){ ?>' .parent::getStartTag() .'<?php } ?>';}function getEndTag(){return '<?php if(strlen($'.$this->getPageParam().'["'.$this->getId().'_attribute"]["href"])>0){ ?>' .parent::getEndTag() .'<?php } ?>';}function setLink($link){$this->link=$link;}function execute(){if(!is_null($this->text)){parent::execute();}$query=$this->getAttribute($this->_soy2_prefix.":query");if($query){if(strpos($this->link,"?")===false)$this->link.="?";$this->link.=$query;}$suffix=$this->getAttribute($this->_soy2_prefix.":suffix");if($suffix){$this->link .= $suffix;}$this->setAttribute("href",$this->link);}function getObject(){if(!is_null($this->text)){return parent::getObject();}return $this->link;}}class HTMLActionLink extends HTMLLink{function execute(){if(!is_null($this->text)){HTMLLabel::execute();}$link=$this->link;if(strpos($link,"?")===false){$link .= "?";}else{$link .= "&";}$link .= "soy2_token=".soy2_get_token();$this->setAttribute("href",$link);}}?>
<?php class HTMLList extends SOYBodyComponentBase{var $list=array();var $_list=array();var $htmls=array();var $_includeParentTag=true;protected $_notMerge=false;function setList($list){if(!is_array($list)){$list=(array)$list;}$this->list=$list;}function getStartTag(){$this->_includeParentTag=$this->getAttribute("includeParentTag");$this->clearAttribute("includeParentTag");if($this->_includeParentTag){return SOY2HTML::getStartTag()."\n".'<?php $'.$this->getId().'_counter=-1; foreach($'.$this->getPageParam().'["'.$this->getId().'"] as $key => $'.$this->getId().'){ $'.$this->getId().'_counter++; ?>';}else{return (($this->getStartNewLine()) ? "\n\n" : "") .'<?php $'.$this->getId().'_counter=-1;foreach($'.$this->getPageParam().'["'.$this->getId().'"] as $key => $'.$this->getId().'){ $'.$this->getId().'_counter++; ?>'. SOY2HTML::getStartTag();}}function getEndTag(){if($this->_includeParentTag){return '<?php } ?>'."\n" .SOY2HTML::getEndTag();}else{return SOY2HTML::getEndTag()."\n".'<?php } ?>';}}function getObject(){return $this->_list;}function execute(){$innerHTML=$this->getInnerHTML();$old=error_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);$this->populateItemImpl(new HTMLList_DummyObject(),null,-1,count($this->list));$this->createAdd("index","HTMLLabel",array("text" => ""));$this->createAdd("loop","HTMLList_LoopModel",array("counter" => -1));$this->createAdd("at_first","HTMLModel",array("visible" => false));$this->createAdd("not_first","HTMLModel",array("visible" => false));$this->createAdd("at_last","HTMLModel",array("visible" => false));$this->createAdd("not_last","HTMLModel",array("visible" => false));error_reporting($old);parent::execute();$counter=1;$length=count($this->list);foreach($this->list as $listKey => $listObj){$tmpList=array();$res=$this->populateItemImpl($listObj,$listKey,$counter,$length);if($res === false)continue;$this->createAdd("index","HTMLLabel",array("text" => $counter));$this->createAdd("loop","HTMLList_LoopModel",array("counter" => $counter));$this->createAdd("at_first","HTMLModel",array("visible" => $counter == 1));$this->createAdd("not_first","HTMLModel",array("visible" => $counter != 1));$this->createAdd("at_last","HTMLModel",array("visible" => $counter == $length));$this->createAdd("not_last","HTMLModel",array("visible" => $counter != $length));foreach($this->_components as $key => $obj){$obj->setContent($innerHTML);$obj->execute();$this->_set($key,$obj,$tmpList);}$this->_list[$listKey]=$tmpList;$counter++;}}function isMerge(){return false;}function populateItemImpl($entity,$key,$counter,$length){if(method_exists($this,"populateItem")){return $this->populateItem($entity,$key,$counter,$length);}if($this->_soy2_functions["populateItem"]){return $this->__call("populateItem",array($entity,$key,$counter,$length));}return null;}private $_component_list_=null;function getComponentsList($prefix=""){if($this->_component_list_ == null){$this->_component_list_=parent::getComponentsList($prefix);}return $this->_component_list_;}}class HTMLList_DummyObject extends ArrayObject{function __call($func,$args){return new HTMLList_DummyObject();}function __get($key){return new HTMLList_DummyObject();}function __toString(){return "";}}class HTMLList_LoopModel extends HTMLModel{private $counter;function getStartTag(){$step=(int)$this->getAttribute("step");$func ='<?php $'.$this->getId().'_loop_visible=!(boolean)'.$step.';' .'if('.$step.')$'.$this->getId().'_loop_visible=(($'.$this->getPageParam().'_counter+1) % '.$step.' === 0); ' .'if($'.$this->getId().'_loop_visible){ ?>';$res=$func . parent::getStartTag();return $res;}function getEndTag(){return parent::getEndTag()."<?php } ?>";}function setCounter($counter){$this->counter=$counter;}function getCounter(){return $this->counter;}}?>
<?php class HTMLLabelList extends HTMLList{protected $itemId="item_label";protected $property=null;function populateItem($entity){$value=$this->getValue($entity);$id=$this->getItemId();$this->addLabel($id,array("text" => $value));}function getValue($obj){if(!$this->property){return $obj;}$method="get".ucwords($this->property);return $obj->$method();}function getItemId() {return $this->itemId;}function setItemId($itemId) {$this->itemId=$itemId;}function getProperty() {return $this->property;}function setProperty($property) {$this->property=$property;}}class HTMLCheckboxList extends HTMLList{protected $name=null;protected $values=array();protected $index=true;function populateItem($entity,$key){$elementId=$this->getId()."_".$key;$name=$this->name;$this->addLabel("item_label",array("attr:for" => $elementId,"text" => $entity,));$value=($this->index) ? $key : $entity;$this->addCheckbox("item_checkbox",array("elementId" => $elementId,"name" => $name."[]","value" => ($this->index) ? $key : $entity,"selected" => in_array($value,$this->values)));}function setName($name){$this->name=$name;}function setValues($values){$this->values=$values;}function setIndex($index){$this->index=$index;}}class HTMLRadioList extends HTMLList{protected $name=null;protected $value=null;protected $index=true;function populateItem($entity,$key){$elementId=$this->getId()."_".$key;$name=$this->name;$this->addLabel("item_label",array("attr:for" => $elementId,"text" => $entity,));$value=($this->index) ? $key : $entity;$this->addCheckbox("item_checkbox",array("elementId" => $elementId,"name" => $name,"value" => ($this->index) ? $key : $entity,"selected" => $value == $this->value));}function setName($name){$this->name=$name;}function setValue($value){$this->value=$value;}function setIndex($index){$this->index=$index;}}?>
<?php class HTMLPage extends SOYBodyComponentBase{protected $_soy2_content;protected $_soy2_page;private $_soy2_body_element;private $_soy2_head_element;function HTMLPage(){$this->init();$this->prepare();}function setId($id){SOY2HTML::setId($id);$this->setPageParam($id);}function setContent($content){parent::setContent($content);$this->setInnerHTML('<?php echo $'.$this->getParentPageParam().'["'.$this->getId().'"]; ?>');}function prepare(){$this->_soy2_page=array();$content=$this->getTemplate();if(defined("SOY2HTML_ALLOW_PHP_SCRIPT") && SOY2HTML_ALLOW_PHP_SCRIPT == false){$content=preg_replace('/\A<\?xml([^\?]*)\?>/sm','@@XML_START@@$1@@XML_END@@',$content);$content=str_replace(array('<?','?>'),array('&lt;?','?&gt;'),$content);$content=str_replace(array('@@XML_START@@','@@XML_END@@'),array('<?xml','?>'),$content);}if(ini_get("short_open_tag")){$content=preg_replace('/\A<\?xml/','<?php echo "<?xml"; ?>',$content);}$this->_soy2_content=$content;if($this->_soy2_content == false){ob_start();include($this->getCacheFilePath(".inc.php"));$tmp=ob_get_contents();ob_end_clean();$this->_soy2_permanent_attributes=@unserialize($tmp);}}function getBodyElement(){if(is_null($this->_soy2_body_element))$this->_soy2_body_element=new HTMLPage_ChildElement("body");return $this->_soy2_body_element;}function getHeadElement(){if(is_null($this->_soy2_head_element))$this->_soy2_head_element=new HTMLPage_HeadElement("head");return $this->_soy2_head_element;}function create($id,$className,$array=array()){if(is_object($className)){$obj=$className;$obj->setId($id);}else{if(!isset($array["soy2prefix"]) && $this->_childSoy2Prefix)$array["soy2prefix"]=$this->_childSoy2Prefix;$obj=SOY2HTMLFactory::createInstance($className,$array);$obj->setId($id);$obj->setParentId($this->getId());}$obj->setParentObject($this);$obj->init();if($this->_soy2_content != false){$obj->setContent($this->_soy2_content);}else{$obj->setIsModified(false);if(isset($this->_soy2_permanent_attributes[$id])){foreach($this->_soy2_permanent_attributes[$id] as $key => $value){$obj->_soy2_attribute[$key]=$value;$obj->_soy2_permanent_attributes[$key]=$value;}}}if($obj instanceof HTMLPage){$obj->setParentPageParam($this->getPageParam());$obj->setPageParam($this->getPageParam());}else{$obj->setPageParam($this->getPageParam());}return $obj;}function add($id,$obj){if(!$obj instanceof SOY2HTML){return;}if($obj->getId() !== $id){$obj=$this->create($id,$obj);}$obj->execute();$this->_set($id,$obj);if($this->_soy2_content != false){$this->_soy2_content=$this->getContent($obj,$this->_soy2_content);}}function createAdd($id,$className,$array=array()){$this->add($id,$this->create($id,$className,$array));}function parsePlugin(){$plugin=new HTMLPluginBase();while(true && SOY2HTMLPlugin::length()){list($tag,$line,$innerHTML,$outerHTML,$value,$suffix,$skipendtag)=$plugin->parse("[a-zA-Z0-9]*","[a-zA-Z0-9\.\/\-_\?\&\=#]*",$this->_soy2_content);if(!strlen($tag))break;$tmpPlugin=$plugin->getPlugin($suffix);$plugin->_attribute=array();if(is_null($tmpPlugin)){$tmpTag=$plugin->getTag();$plugin->setTag($tag);$plugin->parseAttributes($line);$plugin->setInnerHTML($innerHTML);$plugin->setOuterHTML($outerHTML);$plugin->setSkipEndTag($skipendtag);$this->_soy2_content=$this->getContent($plugin,$this->_soy2_content);$this->_soy2_content=str_replace(":".$suffix,"",$this->_soy2_content);$plugin->setTag($tmpTag);continue;}$tmpPlugin->_attribute=array();$tmpPlugin->setTag($tag);$tmpPlugin->parseAttributes($line);$tmpPlugin->setInnerHTML($innerHTML);$tmpPlugin->setOuterHTML($outerHTML);$tmpPlugin->setParent($this);$tmpPlugin->setSkipEndTag($skipendtag);$tmpPlugin->setSoyValue($value);$tmpPlugin->execute();$this->_soy2_content=$this->getContent($tmpPlugin,$this->_soy2_content);}$plugin=null;}function executePlugin($key,$plugin){while(true){list($tag,$line,$innerHTML,$outerHTML,$value,$suffix,$skipendtag,$startnewline,$endnewline) =$plugin->parse($key,"[a-zA-Z0-9\.\/\-_\?\&\=#]*",$this->_soy2_content);if(!strlen($tag))break;$plugin->_attribute=array();$plugin->setTag($tag);$plugin->setStartNewLine($startnewline);$plugin->setEndNewLine($endnewline);$plugin->parseAttributes($line);$plugin->setInnerHTML($innerHTML);$plugin->setOuterHTML($outerHTML);$plugin->setParent($this);$plugin->setSkipEndTag($skipendtag);$plugin->setSoyValue($value);$plugin->execute();$this->_soy2_content=$this->getContent($plugin,$this->_soy2_content);if(!$outerHTML){$this->_soy2_content=str_replace("<".$line.">","",$this->_soy2_content);}}}function display(){if($this->_soy2_body_element)$this->_soy2_content=$this->_soy2_body_element->convert($this->_soy2_content,$this->getPageParam());if($this->_soy2_head_element)$this->_soy2_content=$this->_soy2_head_element->convert($this->_soy2_content,$this->getPageParam());$page=&$this->_soy2_page;if($this->_soy2_body_element)$page=$this->_soy2_body_element->execute($page);if($this->_soy2_head_element)$page=$this->_soy2_head_element->execute($page);$this->parsePlugin();$this->parseMessageProperty();$filePath=$this->getCacheFilePath();$this->createCacheFile();$this->createPermanentAttributesCache();$page=&HTMLPage::getPage();if($this->getId()){$page[$this->getId()]=$this->_soy2_page;}else{$page=$this->_soy2_page;}ob_start();include($filePath);$html=ob_get_contents();ob_end_clean();$layoutDirs=SOY2HTMLConfig::LayoutDirectories();$layout=$this->getLayout();$res=false;foreach($layoutDirs as $layoutDir){if($layoutDir && is_file($layoutDir . $layout)){$res=include($layoutDir . $layout);}}if(!$res){echo $html;}self::popPageStack();}function execute(){$this->_soy2_innerHTML='<?php echo @$'.$this->getParentPageParam().'["'.$this->getId().'"]; ?>';}function getObject(){ob_start();$this->display();$content=ob_get_contents();ob_end_clean();return $content;}function getTemplate(){if($this->isModified() != true){return false;}$file=$this->getTemplateFilePath();if(!file_exists($file)){return "";}return file_get_contents($file);}function getTemplateFilePath(){$dir=dirname($this->getClassPath());if(strlen($dir)>0 && $dir[strlen($dir)-1] != "/")$dir .= "/";$templateDir=SOY2HTMLConfig::TemplateDir();if($templateDir){$pageDir=SOY2HTMLConfig::PageDir();$dir=str_replace($pageDir,$templateDir,$dir);}$lang=SOY2HTMLConfig::Language();$lang_html=$dir . get_class($this)."_".$lang.".html";$default_html=$dir . get_class($this).".html";if(strlen($lang)>0 && file_exists($lang_html)){return $lang_html;}return $default_html;}function getCacheFilePath($extension=".html.php"){return SOY2HTMLConfig::CacheDir(). SOY2HTMLConfig::getOption("cache_prefix") ."cache_".get_class($this) .'_'. $this->getId() .'_'. $this->getParentPageParam() . md5($this->getTemplateFilePath()) . SOY2HTMLConfig::Language() . $extension;}function createCacheFile(){$filePath=$this->getCacheFilePath();$templateFilePath=$this->getTemplateFilePath();if($this->isModified() != true){return;}$fp=@fopen($filePath,"w");if(!$fp){throw new SOY2HTMLException("[SOY2HTML]Can not create cache file.");}fwrite($fp,'<?php /* created ' . date("Y-m-d h:i:s") .' */ ?>');fwrite($fp,"\r\n");fwrite($fp,'<?php $template_path="'.$templateFilePath.'"; ?>');if(strlen($this->getId())){fwrite($fp,'<?php $'.$this->getPageParam().'=HTMLPage::getPage("'.$this->getId().'"); ?>');}else{fwrite($fp,'<?php $'.$this->getPageParam().'=HTMLPage::getPage(); ?>');}fwrite($fp,"\r\n");fwrite($fp,$this->_soy2_content);fclose($fp);}function createPermanentAttributesCache(){$filePath=$this->getCacheFilePath(".inc.php");if($this->isModified() != true && file_exists($filePath)){return;}$fp=@fopen($filePath,"w");fwrite($fp,"<?php ");fwrite($fp,'echo \''.serialize($this->_soy2_permanent_attributes).'\';');fwrite($fp,"?>");fclose($fp);}function isModified(){$filePath=$this->getCacheFilePath();$templateFilePath=$this->getTemplateFilePath();if(defined("SOY2HTML_CACHE_FORCE") && SOY2HTML_CACHE_FORCE == true){return true;}if(!file_exists($templateFilePath)){return false;}if(file_exists($filePath)&& filemtime(__FILE__) <= filemtime($filePath)&& filemtime($templateFilePath) <= filemtime($filePath)){return false;}return true;}public static function &getPage($id=null){static $page;if(is_null($page)){$page=array();}$tmpPage=&$page;$pageStack=self::$_soy2_page_stack;foreach($pageStack as $stack){if(!isset($tmpPage[$stack]))$tmpPage[$stack]=array();$tmpPage=&$tmpPage[$stack];}if($id){if(!isset($tmpPage[$id]))$tmpPage[$id]=array();return $tmpPage[$id];}return $tmpPage;}private static $_soy2_page_stack=array();private static function pushPageStack($id){if(!$id)return;self::$_soy2_page_stack[]=$id;}private static function popPageStack(){array_pop(self::$_soy2_page_stack);}function _set($id,SOY2HTML &$obj,&$page=null){$page=&$this->_soy2_page;parent::_set($id,$obj,$page);}function setTitle($title){$this->getHeadElement()->setTitle($title);}function parseMessageProperty(){if($this->getIsModified()){foreach($this->_message_properties as $key => $message){$tmpKey="@@".$key.";";$this->_soy2_content=str_replace($tmpKey,$message,$this->_soy2_content);}}}function getLayout(){return null;}}class HTMLTemplatePage extends HTMLPage{var $_id;var $_html;function HTMLTemplatePage($args){$this->_id=$args[0];$this->_html=$args[1];HTMLPage::HTMLPage();}function getTemplate(){return $this->_html;}function getId(){return $this->_id;}function getParentId(){return $this->getId();}function getPageParam(){return $this->_id;}function getCacheFilePath($extension=".html.php"){return SOY2HTMLConfig::CacheDir(). $this->_id . $extension;}function isModified(){return true;}}class HTMLPage_ChildElement{protected $tag;private $insert=array();private $append=array();function HTMLPage_ChildElement($tag){$this->tag=$tag;}function insertHTML($html){$this->insert[]=$html;}function appendHTML($html){$this->append[]=$html;}function execute($array){$array["page_".$this->tag."_insert"]=implode("\n",$this->insert);$array["page_".$this->tag."_append"]=implode("\n",$this->append);return $array;}function convert($html,$pageParam){if($html != false){if(preg_match('/(<'.$this->tag.'\s?[^>]*>)/i',$html,$tmp1,PREG_OFFSET_CAPTURE)){$start=$tmp1[1][0];$out=$tmp1[1][0]."\n".'<?php echo $'.$pageParam.'["page_'.$this->tag.'_insert"]; ?>';$html=str_replace($start,$out,$html);}if(preg_match('/(<\/'.$this->tag.'\s?[^>]*>)/i',$html,$tmp1,PREG_OFFSET_CAPTURE)){$start=$tmp1[1][0];$out='<?php echo $'.$pageParam.'["page_'.$this->tag.'_append"]; ?>' ."\n".$tmp1[1][0];$html=str_replace($start,$out,$html);}}return $html;}}class HTMLPage_HeadElement extends HTMLPage_ChildElement{private $title;private $metas=array();function HTMLPage_HeadElement($tag=null){if($tag == null)$tag="head";parent::HTMLPage_ChildElement($tag);}function setTitle($title){$this->title=$title;}function getTitle(){return $this->title;}function _getMeta($name){if(!isset($this->metas[$name])){$this->metas[$name]=array("insert"=>"","content"=>false,"append"=>"");}return $this->metas[$name];}function appendMeta($name,$content){$array=$this->_getMeta($name);$array["append"] .= $content;$this->metas[$name]=$array;}function insertMeta($name,$content){$array=$this->_getMeta($name);$array["insert"] .= $content;$this->metas[$name]=$array;}function setMeta($name,$content){$array=$this->_getMeta($name);$array["content"]=$content;$this->metas[$name]=$array;}function clearMeta($name){if(isset($this->metas[$name]))unset($this->metas[$name]);}function execute($array){$array["page_".$this->tag."_title"]=$this->getTitle();$array["page_".$this->tag."_meta"]=$this->metas;$array=parent::execute($array);return $array;}function convert($html,$pageParam){if($html != false){if( preg_match('/(<title\s?[^>]*>)/i',$html,$tmp1,PREG_OFFSET_CAPTURE)&& preg_match('/(<\/title\s?[^>]*>)/i',$html,$tmp2,PREG_OFFSET_CAPTURE)){$start=$tmp1[1][1];$end=$tmp2[1][1] + strlen($tmp2[1][0]);$out=$tmp1[1][0] . '<?php echo $'.$pageParam.'["page_'.$this->tag.'_title"]; ?>' . $tmp2[1][0];$in=substr($html,$start,$end-$start);$html= str_replace($in,$out,$html);}preg_match_all('/(<meta([^>]*)\/?>)/i',$html,$meta,PREG_OFFSET_CAPTURE);$added=array();foreach($meta[1] as $key => $array){if(preg_match('/<?php/',$meta[2][$key][0])){continue;}if(preg_match('/name\s*=\s*"([^"]+)"/i',$meta[2][$key][0],$tmp)){$name=$tmp[1];$content="";if(preg_match('/content\s*=\s*"([^"]+)"/i',$meta[2][$key][0],$tmp2)){$content=$tmp2[1];}$replace='<?php if(isset($'.$pageParam.'["page_'.$this->tag.'_meta"]["'.$name.'"])){ ' .' $old="'.htmlspecialchars($content,ENT_QUOTES).'"; ' .' $array=$'.$pageParam.'["page_'.$this->tag.'_meta"]["'.$name.'"]; ' .' if($array["content"] == false){ $content=$array["insert"] . $old . $array["append"]; }else{ $content=$array["content"]; }' .' }else{ $content= "' . $content . '"; }' .' echo \'<meta name="'.htmlspecialchars($name,ENT_QUOTES).'" content="\'.htmlspecialchars($content,ENT_QUOTES).\'" />\'."\n"; ?>';$html=str_replace($array[0],$replace,$html);$added[]=$name;}}$head="";foreach($this->metas as $key => $array){if(in_array($key,$added))continue;$head='<?php if(isset($'.$pageParam.'["page_'.$this->tag.'_meta"]["'.$key.'"])){ ' .'echo \'<meta name="'.htmlspecialchars($key,ENT_QUOTES).'" content="\'.htmlspecialchars(' .'$'.$pageParam.'["page_'.$this->tag.'_meta"]["'.$key.'"]["insert"] . ' .'$'.$pageParam.'["page_'.$this->tag.'_meta"]["'.$key.'"]["content"] . ' .'$'.$pageParam.'["page_'.$this->tag.'_meta"]["'.$key.'"]["append"],ENT_QUOTES' .').\'" />\'."\n";'.'} ?>';}if(strlen($head) >0 && stripos($html,'</head>')!==false){$html=preg_replace('/<\/head>/i',$head.'</head>',$html);}}$html=parent::convert($html,$pageParam);return $html;}}?>
<?php class HTMLPager extends SOYBodyComponentBase{private $link;private $page=1;private $start=0;private $end=0;private $total=0;private $query="";private $pagerCount=10;private $limit=0;function execute(){if($this->_soy2_parent){$this->_soy2_parent->createAdd("count_start","HTMLLabel",array("text" => $this->getStart()));$this->_soy2_parent->createAdd("count_end","HTMLLabel",array("text" => $this->getEnd()));$this->_soy2_parent->createAdd("count_max","HTMLLabel",array("text" => $this->getTotal()));}$next=$this->getNextParam();$this->createAdd("next_link","HTMLLink",$next);$this->createAdd("next_link_wrap","HTMLModel",array("visible" => $next["visible"]));$prev=$this->getPrevParam();$this->createAdd("prev_link","HTMLLink",$prev);$this->createAdd("prev_link_wrap","HTMLModel",array("visible" => $prev["visible"]));$this->createAdd("pager_list","SOY2HTMLPager_List",$this->getPagerParam());$this->createAdd("pager_jump","HTMLForm",array("method" => "get","action" => $this->getLink()));$this->createAdd("pager_select","HTMLSelect",array("name" => "page","options" => $this->getSelectArray(),"selected" => $this->getPage(),"onchange" => "location.href=this.parentNode.action+this.options[this.selectedIndex].value"));parent::execute();}function getNextParam(){$link=($this->total > $this->getEnd()) ? $this->link . ($this->page + 1) : $this->link . $this->page;if(strlen($this->getQuery()))$link .= "?".$this->getQuery();return array("link" => $link,"class" => ($this->total <= $this->end) ? "pager_disable" : "","visible" => ($this->total > $this->end));}function getPrevParam(){$link=($this->page > 1) ? $this->link . ($this->page-1) : $this->link . ($this->page);if(strlen($this->getQuery()))$link .= "?".$this->getQuery();return array("link" => $link,"class" => ($this->page <= 1) ? "pager_disable" : "","visible" => ($this->page > 1));}function getPagerParam(){if($this->pagerCount < 0){$pagers=range(1,$this->getLastPageNum());}else{if($this->getLastPageNum() <= $this->pagerCount){$pagers=range(1,$this->getLastPageNum());}else{$pager_min=max(1,min($this->page-floor($this->pagerCount/2),$this->getLastPageNum()-$this->pagerCount + 1));$pager_max=max($this->pagerCount,min($pager_min + $this->pagerCount-1,$this->getLastPageNum()));$pagers=range($pager_min,$pager_max);}}return array("url" => $this->link,"current" => $this->page,"list" => $pagers,"visible" => ($this->getLastPageNum() > 1));}function getLastPageNum(){if($this->limit > 0){return ceil($this->total / $this->limit);}else{return 1;}}function getSelectArray(){$max=($this->limit > 0) ? (int)($this->total / $this->limit) + 1 : 1;$pagers=range(1,$max);$array=array();foreach($pagers as $page){$array[ $page ]=$page;}return $array;}function getLink() {return $this->link;}function setLink($link) {$this->link=$link;}function getPage() {return $this->page;}function setPage($page) {$this->page=$page;}function getStart() {return min($this->start,$this->total);}function setStart($start) {$this->start=$start;}function getEnd() {if(!$this->end){$this->end=min($this->total,$this->start + $this->limit-1);}return $this->end;}function setEnd($end) {$this->end=$end;}function getTotal() {return $this->total;}function setTotal($total) {$this->total=$total;}function getQuery() {return $this->query;}function setQuery($query) {$this->query=$query;}function getPagerCount() {return $this->pagerCount;}function setPagerCount($count) {$this->pagerCount=$count;}function getLimit() {return $this->limit;}function setLimit($limit) {$this->limit=$limit;}}class SOY2HTMLPager_List extends HTMLList{private $url;private $current;protected function populateItem($bean){if(is_array($bean)){list($link,$text)=$bean;}else{$link=$bean;$text= $bean;}$url=$this->url . $link;$this->createAdd("page_link","HTMLLink",array("text" => $text,"link" => ($this->current != $link)?$url : ""));$this->createAdd("page_text","HTMLLabel",array("text" => $text));$this->createAdd("current_page","HTMLModel",array("visible" => ($this->current == $link)));$this->createAdd("other_page","HTMLModel",array("visible" => ($this->current != $link)));}function getUrl() {return $this->url;}function setUrl($url) {$this->url=$url;}function getCurrent() {return $this->current;}function setCurrent($cuttent) {$this->current=$cuttent;}}?>
<?php class HTMLPluginBase extends SOY2HTML{const SOY_TYPE=SOY2HTML::HTML_BODY;protected $soyValue="";protected $parent=null;function setSoyValue($value){$this->soyValue=$value;}function setParent($page){$this->parent=$page;}function execute(){if($this->functionExists("executePlugin")){$this->__call("executePlugin",array($this->soyValue));}else{$this->executePlugin($this->soyValue);}}function getObject(){}function getPlugin($param){$plugin=SOY2HTMLPlugin::getPlugin($param);if(is_null($plugin))return $plugin;if(is_object($plugin)){return $plugin;}return new $plugin();}function executePlugin($soyValue){}function getVisbleScript(){return array("","");}}class SOY2HTMLPlugin{private static function &getPlugins(){static $_static;if(is_null($_static)){$_static=array();}return $_static;}public static function addPlugin($key,$value){$plugins=&SOY2HTMLPlugin::getPlugins();$plugins[$key]=$value;}public static function getPlugin($key){$plugins=SOY2HTMLPlugin::getPlugins();return (isset($plugins[$key])) ? $plugins[$key] : null;}public static function removePlugin($key){$plugins=&SOY2HTMLPlugin::getPlugins();@$plugins[$key]=null;}public static function length(){return count(SOY2HTMLPlugin::getPlugins());}}class PagePlugin extends HTMLPluginBase{var $isOverWrite=false;function executePlugin($soyValue){$innerHTML=array();$innerHTML[]='<?php if(!isset($'.$this->parent->getPageParam().'["page_'.md5($soyValue).'"])){ ?>';$innerHTML[]='<?php $'.$this->parent->getPageParam().'["page_'.md5($soyValue).'"]=PagePlugin::loadWebPage("'.$this->parent->getId().'","'.$this->parent->getClassPath().'","'.$soyValue.'",__FILE__); ?>';$innerHTML[]='<?php } ?>';$innerHTML[]='<?php echo $'.$this->parent->getPageParam().'["page_'.md5($soyValue).'"]; ?>';$this->setInnerHTML(implode("\n",$innerHTML));}function getStartTag(){if($this->getAttribute("isOverWrite")){$this->isOverWrite=(boolean)$this->getAttribute("isOverWrite");$this->clearAttribute("isOverWrite");}if($this->isOverWrite){return "";}return parent::getStartTag();}function getEndTag(){if($this->isOverWrite){return "";}return parent::getEndTag();}public static function loadWebPage($parentId,$parentClassPath,$className,$parentFilePath){$id="page_".md5($className.$parentClassPath);$class=SOY2HTMLFactory::pageExists($className);$filePath=realpath(SOY2HTMLConfig::PageDir().str_replace(".","/",$className).".class.php");$cachFilePath=SOY2HTMLConfig::CacheDir()."cache_".$class .'_'. $id .'_'. md5($filePath) .".html.php";if(file_exists($cachFilePath) && filemtime($cachFilePath) < filemtime($parentFilePath)){unlink($cachFilePath);}$webPage=SOY2HTMLFactory::createInstance($className);$webPage->setId($id);$webPage->setPageParam($id);$webPage->setParentId($parentId);$webPage->setParentPageParam("");$webPage->execute();$value=$webPage->getObject();return $value;}}class LinkPlugin extends HTMLPluginBase{function executePlugin($soyValue){if(strpos($soyValue,"/") !== false){$this->_attribute["href"]=SOY2PageController::createRelativeLink($soyValue);}else{$this->_attribute["href"]=SOY2PageController::createLink($soyValue);}}}class SrcPlugin extends HTMLPluginBase{function executePlugin($soyValue){if(strpos($soyValue,"/") !== false){$this->_attribute["src"]=SOY2PageController::createRelativeLink($soyValue);}else{$this->_attribute["src"]=SOY2PageController::createLink($soyValue);}}}class ActionPlugin extends HTMLPluginBase{function executePlugin($soyValue){if(strpos($soyValue,"/") !== false){$this->_attribute["action"]=SOY2PageController::createRelativeLink($soyValue);}else{$this->_attribute["action"]=SOY2PageController::createLink($soyValue);}}}class DisplayPlugin extends HTMLPluginBase{var $soyValue;function executePlugin($soyValue){$this->soyValue=$soyValue;}function getStartTag(){return '<?php if(DisplayPlugin::toggle("'.$this->soyValue.'")){ ?>'. parent::getStartTag();}function getEndTag(){return  parent::getEndTag() . '<?php } ?>';}public static function visible($soyValue){DisplayPlugin::toggle($soyValue,1);}public static function toggle($soyValue,$flag=null){static $_flags;if(!$_flags){$_flags=array();}if(!is_null($flag)){$_flags[$soyValue]=$flag;}return (isset($_flags[$soyValue])) ? $_flags[$soyValue] : true;}public static function hide($soyValue){DisplayPlugin::toggle($soyValue,0);}}class PanelPlugin extends HTMLPluginBase{var $soyValue;var $flag=true;function executePlugin($soyValue){$panels=&PanelPlugin::getPanels();$this->soyValue=$soyValue;if(in_array($soyValue,$panels)){$this->flag=true;$this->setInnerHTML("");}else{$panels[]=$soyValue;$this->flag=false;}}public static function &getPanels(){static $_panels;if(is_null($_panels)){$_panels=array();}return $_panels;}function getStartTag(){$html=array();if($this->flag){$html[]='<?php echo $_panel_plugin_'.$this->soyValue.'; ?>';}else{$html[]='<?php ob_start(); ?>';}return parent::getStartTag() . implode("\n",$html);}function getEndTag(){$html=array();if($this->flag){}else{$html[]='<?php $_panel_plugin_'.$this->soyValue.'=ob_get_contents(); ?>';$html[]='<?php ob_end_clean(); ?>';$html[]='<?php echo $_panel_plugin_'.$this->soyValue.'; ?>';}return implode("\n",$html) . parent::getEndTag();}}class IgnorePlugin extends HTMLPluginBase{function getStartTag(){return '<?php /* ?>';}function getEndTag(){return  '<?php */ ?>';}}class SOY2HTML_ControllPlugin extends HTMLPluginBase{function getStartTag(){$condition=$this->getAttribute("condition");$this->clearAttribute("condition");return '<?php $condition=ControllPlugin::checkCondition("'.$this->soyValue.'","'.htmlspecialchars($condition,ENT_QUOTES).'");' .'if($condition){ ?>' . parent::getStartTag();}public static function checkCondition($type,$key){switch($type){case "if":default:$res=false;if(strlen($key)>0){eval('$res=('.$key.');');}return $res;break;}return false;}function getEndTag(){return  parent::getEndTag()."<?php } ?>";}}?>
<?php class HTMLScript extends SOY2HTML{var $tag="script";const SOY_TYPE=SOY2HTML::HTML_BODY;var $script="";var $type="text/javascript";function setScript($script){$this->script=$script;}function setSrc($src){$this->setAttribute("src",$src);}function execute(){$this->setAttribute("type",$this->type);parent::execute();}function setType($type){$this->type=$type;}function getObject(){if(strlen($this->script)){return "<!--\n".$this->script."\n-->";}else{return $this->script;}}}?>
<?php class HTMLTreeComponent_Child extends HTMLModel{private $func="";function getStartTag(){$tag=parent::getStartTag();return '<?php foreach($'.$this->getParentId().'_child as $'.$this->getParentId()."_".$this->getId().'_child){ ?>' .$tag."";}function getEndTag(){$tag=parent::getEndTag();return $tag."<?php } /* end of loop of ".$this->getId()."*/ ?>"."\n";;}function execute(){$this->_soy2_innerHTML="<?php ".$this->func.'($'.$this->getParentId()."_".$this->getId() . '_child); ?>';}function getFunc() {return $this->func;}function setFunc($func) {$this->func=$func;}}class HTMLTreeComponent_ChildWrap extends HTMLModel{function getStartTag(){$tag=parent::getStartTag();return '<?php if(count($'.$this->getParentId().'_child) > 0){ ?>' .$tag."\n";}function getEndTag(){$tag=parent::getEndTag();return $tag."<?php } /* end of ".$this->getId()."*/ ?>"."\n";;}}class HTMLTree extends SOYBodyComponentBase{public $tree;public $list;public $_funcName;private $_list=array();function getStartTag(){$tag=parent::getStartTag();$tag .= "<?php function ".$this->getFuncName() . '($'.$this->getId().'){ /* echo "<pre style=text-align:left;>";print_r($'.$this->getId().');echo "</pre>" */;' .'$'.$this->getId().'_child=$'.$this->getId().'["child"];' .'$'.$this->getId().'=$'.$this->getId().'["object"];' ."?>";return $tag;}function getEndTag(){$tag="<?php } /* end of func ".$this->getFuncName()." */ ?>";$tag .= parent::getEndTag();$tag .= '<?php foreach($'.$this->getPageParam().'["'.$this->getId().'"] as $'.$this->getId().'_key => $'.$this->getId().'){' .$this->getFuncName() . '($'.$this->getId(). '); ' .'} ?>';return $tag;}function getObject(){return $this->_list;}function getFuncName(){if(!$this->_funcName){$this->_funcName="_soy2html_tree_component_".$this->getId()."_".time();}return $this->_funcName;}function execute(){$innerHTML=$this->getInnerHTML();$this->populateItemImpl(new HTMLList_DummyObject,-1,-1);$this->createAdd("tree","HTMLTreeComponent_Child",array("func" => $this->getFuncName()));$this->createAdd("tree_child","HTMLTreeComponent_ChildWrap");parent::execute();$this->_list=$this->parseTree($this->tree);}function parseTree($tree,$depth=0){$innerHTML=$this->getInnerHTML();$list=array();$counter=0;foreach($tree as $treeKey => $treeArray){$isLast=false;$counter++;if(!is_array($treeArray)){$isLast=(count($tree) == $counter);$treeKey=$treeArray;$treeArray=array();}else{$isLast=(count($treeArray) < 1);}if(!isset($this->list[$treeKey]))continue;$tmpList=array();$listObj=$this->list[$treeKey];$new_depth=$depth + 1;$res=$this->populateItemImpl($listObj,$treeKey,$new_depth,$isLast);if($res === false)continue;foreach($this->_components as $key => $obj){$obj->setContent($innerHTML);$obj->execute();$this->_set($key,$obj,$tmpList);}$child=(is_array($treeArray)) ? $this->parseTree($treeArray,$new_depth) : array();$list[$treeKey]=array("object" => $tmpList,"child" => $child);}return $list;}function populateItemImpl($entity,$key,$depth,$isLast=false){if(method_exists($this,"populateItem")){return $this->populateItem($entity,$key,$depth,$isLast);}if($this->_soy2_functions["populateItem"]){return $this->__call("populateItem",array($entity,$key,$depth,$isLast));}return null;}function getList() {return $this->list;}function setList($list) {$this->list=$list;}function getTree() {return $this->tree;}function setTree($tree) {$this->tree=$tree;}function setTreeIds($ids){$list=array();$tmp=null;foreach($ids as $id){if(!is_null($tmp)){$tmp[$id]=array();$tmp=&$tmp[$id];}else{$list[$id]=array();$tmp=&$list[$id];}}$this->setTree($list);}}?>
<?php class FancyURLLinkPlugin extends HTMLPluginBase{function executePlugin($soyValue){if(strpos($soyValue,"/") !== false){$this->_attribute["href"]=SOY2FancyURIController::createRelativeLink($soyValue);}else{$this->_attribute["href"]=SOY2FancyURIController::createLink($soyValue);}}}class FancyURLSrcPlugin extends HTMLPluginBase{function executePlugin($soyValue){if(strpos($soyValue,"/") !== false){$this->_attribute["src"]=SOY2FancyURIController::createRelativeLink($soyValue);}else{$this->_attribute["src"]=SOY2FancyURIController::createLink($soyValue);}}}?>
<?php class WebPage extends HTMLPage{const SOY_TYPE=SOY2HTML::HTML_BODY;function WebPage(){$this->init();$this->prepare();}function doPost(){}function prepare(){if($_SERVER['REQUEST_METHOD'] == 'POST'){$this->doPost();}parent::prepare();}function getLayout(){return "default.php";}}?>
<?php function soy2html_layout_include($file){$layoutDirs=SOY2HTMLConfig::LayoutDirectories();foreach($layoutDirs as $layoutDir){if(file_exists($layoutDir . $file)){@include($layoutDir . $file);break;}}}function soy2html_layout_get($file){try{ob_start();soy2html_layout_include($file);$html=ob_get_contents();ob_end_clean();return $html;}catch(Exception $e){ob_end_flush();throw $e;}}?>
<?php interface SOY2LogicInterface{public static function getInstance($className,$args);}abstract class SOY2LogicBase implements SOY2LogicInterface{public static function getInstance($className,$args){$obj=new $className();foreach($args as $key => $value){$method="set".ucwords($key);if(method_exists($obj,$method)){$obj->$method($args[$key]);}}return $obj;}}class SOY2Logic{public static function createInstance($classPath,$array=array()){if(!class_exists($classPath)){if(SOY2::import($classPath) == false){throw new Exception("Failed to include ".$classPath);}}if(preg_match('/\.?([a-zA-Z0-9_]+$)/',$classPath,$tmp)){$classPath=$tmp[1];}$refClass=new ReflectionClass($classPath);$interfaces=$refClass->getInterfaces();$flag=false;if(array_key_exists("SOY2LogicInterface",$interfaces)){$flag=true;}else{foreach($interfaces as $key => $interface){if($interface->getName() == "SOY2LogicInterface"){$flag=true;break;}}}if(!$flag){throw new Exception("[SOY2Logic]$classPath"." must be subclass of SOY2LogicBase.");}$method=$refClass->getMethod("getInstance");return $method->invoke(NULL,$classPath,$array);}}class SOY2LogicContainer {private $logics=array();function get($name,$array=array()){if(isset($this->logics[$name])){$obj=$this->logics[$name];}else{$obj=SOY2Logic::createInstance($name,$array);$this->logics[$name]=$obj;}foreach($array as $key => $value){$method="set".ucwords($key);if(method_exists($obj,$method)){$obj->$method($array[$key]);}}return $obj;}}?>
<?php interface SOY2PluginDelegateAction{function run($extetensionId,$moduleId,SOY2PluginAction $action);}interface SOY2PluginAction{}class SOY2Plugin{public static function registerExtension($extensionId,$delegateClassName){$inst =self::getInstance();$inst->setDelegate($extensionId,$delegateClassName);}public static function invoke($extensionId,$arguments=array()){$inst=self::getInstance();return $inst->_invoke($extensionId,$arguments);}public static function display($extensionId,$arguments=array()){ob_start();self::invoke($extensionId,$arguments);$html=ob_get_contents();ob_end_clean();return $html;}public static function extension($extensionId,$moduleId,$className,$priority=0){$inst =self::getInstance();$inst->addExtension($extensionId,$moduleId,$className,$priority);}public static function getInstance($className=null){static $_inst;if(is_null($_inst)){if(is_null($className))$className="SOY2Plugin";$_inst=new $className();}return $_inst;}private $delegates=array();private $extensions=array();private $objects=array();function setDelegate($point,$delegate){$this->delegates[$point]=$delegate;}function getDelegate($point){if(!isset($this->delegates[$point]))return false;$delegateClassName=$this->delegates[$point];if(!class_exists($delegateClassName))return false;$delegate=new $delegateClassName();if(!($delegate instanceof SOY2PluginDelegateAction))return false;return $delegate;}function addExtension($extension,$moduleId,$extensionClass,$priority){if(!isset($this->extensions[$extension]))$this->extensions[$extension]=array();if(!isset($this->extensions[$extension][$moduleId]))$this->extensions[$extension][$moduleId]=array();$this->extensions[$extension][$moduleId][]=array("class" => $extensionClass,"priority" => $priority);}function _invoke($extensionId,$arguments=array()){$delegate=$this->getDelegate($extensionId);if(!$delegate)return;SOY2::cast($delegate,(object)$arguments);$extensions=$this->getExtensions($extensionId);foreach($extensions as $extensionId => $extensionArray){foreach($extensionArray as $moduleId => $array){usort($array,array($this,"sortByPriority"));foreach($array as $_array){$extensionClassName=$_array["class"];$class=$this->getClass($extensionClassName);if(!$class)continue;if(!($class instanceof SOY2PluginAction))return;$delegate->run($extensionId,$moduleId,$class);}}}return $delegate;}function getClass($className){if(!class_exists($className)){return null;}if(!isset($this->classes[$className])){$obj=new $className();$this->classes[$className]=$obj;}return $this->classes[$className];}function sortByPriority($a,$b){return ($a["priority"] > $b["priority"]);}function getDelegates() {return $this->delegates;}function setDelegates($delegates) {$this->delegates=$delegates;}function getExtensions($extensionId=null) {if(!is_null($extensionId)){if(strpos($extensionId,".*") == strlen($extensionId)-2){$extensionId=substr($extensionId,0,strlen($extensionId)-1);$res=array();foreach($this->extensions as $key => $array){if(strpos($key,$extensionId) === 0){$res[$key]=$array;}}return $res;}else{return (isset($this->extensions[$extensionId])) ? array($extensionId => $this->extensions[$extensionId]) : array();}}return $this->extensions;}function setExtensions($extensions) {$this->extensions=$extensions;}function getObjects() {return $this->objects;}function setObjects($objects) {$this->objects=$objects;}}?>
<?php class SOY2Session{const _KEY_="_soy2_session_";private static $_deleted_class=null;public static final function get($sessionClass){return self::getSession($sessionClass)->getObject();}public static function getSession($sessionClass){$className=SOY2::import($sessionClass);if(!isset($_SESSION)){session_start();}if(!isset($_SESSION[self::_KEY_]))$_SESSION[self::_KEY_]=array();if(!isset($_SESSION[self::_KEY_][$className])){$obj=new SOY2SessionValue($sessionClass);$_SESSION[self::_KEY_][$className]=$obj;}else{$obj=$_SESSION[self::_KEY_][$className];}return $_SESSION[self::_KEY_][$className];}public static function destroyAll(){if(!isset($_SESSION)){session_start();}unset($_SESSION[self::_KEY_]);}public static function destroySession($sessionClass=null){if(!$sessionClass){return self::$_deleted_class;}$className=preg_replace('/.*\.(.*)/','$1',$sessionClass);if(!isset($_SESSION)){self::$_deleted_class=$className;session_start();}$_SESSION[self::_KEY_][$className]=null;unset($_SESSION[self::_KEY_][$className]);}function init(){}function wakeup(){}function destroy(){unset($_SESSION[self::_KEY_][get_class($this)]);}function clear(){$_SESSION[self::_KEY_][get_class($this)]->reset();}}class SOY2SessionValue{private $create;private $update;private $className;private $classObject;private $classValue;function SOY2SessionValue($className){$class=SOY2::import($className);$this->className=$className;$this->classObject=new $class;$this->create=time();if(!$this->classObject instanceof SOY2Session){trigger_error($className." is not subclass of SOY2Session");}$this->classObject->init();}function getClassName() {return $this->className;}function setClassName($className) {$this->className=$className;}function getClassValue() {return $this->classValue;}function setClassValue($classValue) {$this->classValue=$classValue;}function getObject(){if(is_null($this->classObject)){$this->classObject=new $this->className;}return $this->classObject;}function __sleep(){if($this->classObject){$this->classValue=SOY2::cast("object",$this->classObject);}$this->update=time();return array("className","classValue","create","update");}function __wakeup(){try{$this->classObject=SOY2::cast($this->className,$this->classValue);if(SOY2Session::destroySession() != get_class($this->classObject)){$this->classObject->wakeup();}}catch(Exception $e){}}function reset(){$obj=SOY2::cast("array",$this->classObject);foreach($obj as $key => $value){$obj[$key]=null;}$this->classObject=SOY2::cast($this->className,(object)$obj);}}?>
<?php function _soy2string(){$inst=SOY2String::getInstance();return call_user_func_array(array($inst,"convert"),func_get_args());}if(!function_exists("__")){function __(){$inst=SOY2String::getInstance();return call_user_func_array(array($inst,"convert"),func_get_args());}}if(!function_exists("_e")){function _e(){$inst=SOY2String::getInstance();echo call_user_func_array(array($inst,"convert"),func_get_args());}}class SOY2String{public static function getInstance(){static $_inst;if(!$_inst)$_inst=new SOY2String();return $_inst;}public static function load($configfile){if(!file_exists($configfile)){throw new Exception("config file(".$configfile.") is not found.");}$inst=self::getInstance();if($inst->status > 0)return null;$config=new SOY2StringConfig($configfile);$inst->configs[]=array("config" => $config,"priority" => $config->getPriority());return $config;}public static function doCache($dir=null){$inst=self::getInstance();if($dir){$inst->cacheDir=$dir;}if(!$inst->checkCache()){}}public static function language($lang=null){$inst=self::getInstance();if($lang){$inst->lang=$lang;}return $inst->lang;}public static function text(){$inst=self::getInstance();return call_user_func_array(array($inst,"convert"),func_get_args());}function convert(){$args=func_get_args();if(empty($args)){throw new Exception("string key is require!");}$lang=$this->lang;$key=array_shift($args);$convert=$this->lookup($key,$lang);if(!$convert)return $key;foreach($args as $key => $val){if(is_array($val)){foreach($val as $_key => $_val){$convert=str_replace("%".$_key."%",$_val,$convert);}}else{$convert=str_replace("%".$key,$val,$convert);}}if(preg_match("/#([a-zA-Z0-9\-_]+)#/",$convert,$tmp)){$convert=str_replace("#".$tmp[1]."#",$this->convert($tmp[1]),$convert);}if(strpos($convert,"<?php") !== false){ob_start();eval("?>".$convert);$convert=ob_get_contents();ob_end_clean();}return $convert;}function lookup($key,$lang){if($this->status == 0){uasort($this->configs,array($this,"sortConfigByPriority"));$all=array();foreach($this->configs as $array){$config=$array["config"];$all=array_merge($all,$config->compile($lang));}$this->mapping=$all;$this->status=1;if($this->cacheDir){$cachepath=$this->getCacheFilePath();file_put_contents($cachepath,serialize($this->mapping));}}if(!isset($this->mapping[$key])){return null;}$convert=$this->mapping[$key];return $convert;}function sortConfigByPriority($a,$b){return ($a["priority"] >= $b["priority"]) ? 1 : -1;}function checkCache(){if(!$this->cacheDir)return;$cachepath=$this->getCacheFilePath();if(file_exists($cachepath)){$this->mapping=unserialize(file_get_contents($cachepath));$this->status=2;}}function getCacheFilePath(){$cachepath=$this->cacheDir."/soy2string.".$this->lang.".cache";return $cachepath;}private $cacheDir=null;private $configs=array();private $lang="ja";private $mapping=array();private $status=0;}class SOY2StringConfig{function SOY2StringConfig($langfile){$res=file_get_contents($langfile);$res=json_decode($res,true);if(isset($res["name"]))$this->name=$res["name"];if(isset($res["description"]))$this->description=$res["description"];if(isset($res["default"]))$this->default=$res["default"];if(isset($res["language"]))$this->language=$res["language"];if(isset($res["priority"]))$this->priority=$res["priority"];$this->filepath=realpath($langfile);}private $name;private $description;private $default;private $language;private $priority=0;private $filepath;function compile($lang="ja"){$default=$this->default;$target=$this->language[$default];$filepath=dirname($this->filepath)."/".$target;$all=$this->load($lang,$filepath);if($default == $lang || !isset($this->language[$lang])){return $all;}$target=$this->language[$lang];$filepath=dirname($this->filepath)."/".$target;$langs=$this->load($lang,$filepath);foreach($all as $key => $val){if(!isset($langs[$key]))$langs[$key]=$val;}return $langs;}function getLanguageFileList(){$res=array();$filepath=dirname($this->filepath)."/";foreach($this->language as $key => $val){$res[$key]=realpath($filepath . $val);}return $res;}function save($lang,$array){if(empty($array))return false;$target=$this->language[$lang];$filepath=realpath(dirname($this->filepath)."/".$target);$filename=basename($filepath);$result=null;if(strpos($filename,".json") !== false){$result=$this->export("json",$array);}if(strpos($filename,".ini") !== false){$result=$this->export("ini",$array);}if(strpos($filename,".csv") !== false){$result=$this->export("csv",$array);}if(strpos($filename,".xml") !== false){$result=$this->export("xml",$array);}file_put_contents($filepath,$result);}function load($lang=null,$filepath=null){if(!$lang){$lang=$this->default;}if(!$filepath){$target=$this->language[$lang];$filepath=dirname($this->filepath)."/".$target;}$filename=basename($filepath);if(strpos($filename,".json") !== false){return (array)json_decode(file_get_contents($filepath));}if(strpos($filename,".ini") !== false){return parse_ini_file($filepath);}if(strpos($filename,".csv") !== false){$tmp=soy2_csv_decode(file_get_contents($filepath));$res=array();foreach($tmp as $array){if(count($array) < 1)continue;if(!$array[0])continue;$res[$array[0]]=@$array[1];}return $res;}if(strpos($filename,".xml") !== false){$xml=simplexml_load_file($filepath);if(!isset($xml->string) && !isset($xml->string))return array();$res=array();$values=array();foreach($xml->string as $key => $str){$values[]=(string)$str;}$counter=0;foreach($xml->key as $val){$res[(string)$val]=(isset($values[$counter])) ? $values[$counter] : "";$counter++;}return $res;}}function export($type,$array){ksort($array);switch($type){case "json":return json_encode($array);case "ini":return soy2_ini_encode($array);case "csv":$tmp=array();foreach($array as $key => $val){$tmp[]=array($key,$val);}$array=null;return soy2_csv_encode($tmp);case "xml":$tmp=array();foreach($array as $key => $val){if(strpos($val,"<") !== false || strpos($val,">") !== false|| strpos($val,"&") !== false){$val="<![CDATA[".$val."]]>";}$tmp[]='<key>' . $key . '</key>';$tmp[]='<string>' . $val . '</string>';}$header='<?xml version="1.0" encoding="UTF-8" ?>'."\n<strings>\n\t";$footer="\n</strings>";return $header . implode("\n\t",$tmp) . $footer;break;}}public function getName(){return $this->name;}public function setName($name){$this->name=$name;return $this;}public function getDescription(){return $this->description;}public function setDescription($description){$this->description=$description;return $this;}public function getDefault(){return $this->default;}public function setDefault($default){$this->default=$default;return $this;}public function getLanguage(){return $this->language;}public function setLanguage($language){$this->language=$language;return $this;}public function getPriority(){return $this->priority;}public function setPriority($priority){$this->priority=$priority;return $this;}}?>
<?php function soy2_absolute_url($base,$url){if(preg_match("/^https?:\/\//",$url)){return $url;}$url_array=parse_url($base);$path=$url_array["path"];$root=strtolower($url_array["scheme"])."://" .$url_array["host"];if(isset($url_array["port"]))$root .= ":".$url_array["port"];$path=$url_array["path"];if(strlen($path) > 0 && $path[strlen($path)-1] != "/")$path=dirname($path)."/";if($url[0] == "/"){$url=$root . $url;}else if($url[0] == "." && $url[1] == "/"){$url=$root . $path . substr($url,2);}else if($url[0] == "." && $url[1] == "."){$array=explode("/",$url);$path_array=explode("/",$path);$tmp=array();foreach($array as $_url){if($_url == ".."){$res=array_pop($path_array);if(empty($res))array_pop($path_array);if($res == "index.html")array_pop($path_array);continue;}if(count($path_array)>0){$tmp[]=implode("/",$path_array);$path_array=array();}$tmp[]=$_url;}$url=$root . implode("/",$tmp);}else{$url=$root . $path . $url;}return $url;}?>
<?php function soy2_check_valid_mailaddress($email){$ascii ='[a-zA-Z0-9!#$%&\'*+\-\/=?^_`{|}~.]';$domain='(?:[-a-z0-9]+\.)+[a-z]{2,10}';$d3='\d{1,3}';$ip=$d3.'\.'.$d3.'\.'.$d3.'\.'.$d3;$validEmail="^$ascii+\@(?:$domain|\\[$ip\\])$";if(! preg_match('/'.$validEmail.'/i',$email)){return false;}return true;}?>
<?php function soy2_csv_encode($array,$quote='"',$separate=','){$res=array();foreach($array as $row){$tmp=array();foreach($row as $key => $val){$tmp[]='"' . str_replace('"','""',$val) . '"';}$res[]=implode($separate,$tmp);}return implode("\n",$res);}function soy2_csv_decode($content){$lines=explode("\n",$content);$content=null;$csv_lines=array();$status=0;$buffer="";foreach($lines as $line){$buffer .= $line;$status=($status + substr_count($line,'"')) % 2;if( $status == 0 ){$csv_lines[]=$buffer;$buffer="";}}$res=array();foreach($csv_lines as $line){$res[]=soy2_csv_explode($line);}return $res;}function soy2_csv_explode($line,$separator=","){$quote='"';$separator=",";if($separator == "tab"){preg_match_all('/([^"]*?(?:"[^"]*?"[^"]*?)*)(?:\t|\r\n|\r|\n|$)/',$line,$matches);}else{preg_match_all('/([^"]*?(?:"[^"]*?"[^"]*?)*)(?:,|\r\n|\n|\r|$)/',$line,$matches);}array_pop($matches[1]);$values=array();foreach($matches[1] as $value){if($quote|| strlen($value) >1 && $value[0] == '"' && $value[strlen($value)-1]='"'|| ( strpos($value,"\n") !== false )|| ( strpos($value,"\r") !== false )|| ( $separator == "tab" && strpos($value,"\t") !== false )|| ( $separator != "tab" && strpos($value,",") !== false )){$value=preg_replace("/^\"/","",$value);$value=preg_replace("/\"\$/","",$value);$value=str_replace('""','"',$value);}$values[]=$value;}return $values;}?>
<?php function soy2_date($format,$value){if(!is_numeric($value)){return "";}$w=date("w",$value);$day=array("日","月","火","水","木","金","土");$W=$day[$w];$format=str_replace("W",$W,$format);return date($format,$value);}?>
<?php function soy2_get_object_map($array,$prop,$index=null){$get="get".ucwords($prop);if($index)$getIndex="get".ucwords($index);$res=array();foreach($array as $obj){if($index){$res[$obj->$getIndex()]=$obj->$get();}else{$res[]=$obj->$get();}}return $res;}?>
<?php function soy2_path2url($path){$path=soy2_realpath($path);$root=soy2_realpath($_SERVER["DOCUMENT_ROOT"]);$url=str_replace($root,"/",$path);return $url;}?>
<?php function soy2_realpath($dir){$path=realpath($dir);if(!$path)return $path;$path=str_replace("\\","/",$path);if(is_dir($path) && $path[strlen($path)-1] != "/")$path .= "/";return $path;}?>
<?php function soy2_require($file,$isThrowException=false){$res=(boolean)@include_once($file);if($isThrowException && !$res)throw new Exception("File Not Found:".$file);return $res;}?>
<?php function soy2_convert_image_type($src,$dst,$srcType=null,$dstType=null){if(class_exists("Imagick")){$thumb=new Imagick($src);$thumb->writeImage($dst);return;}if(function_exists("NewMagickWand")){$thumb=NewMagickWand();MagickReadImage($thumb,$src);MagickWriteImage($thumb,$dst);}if(!function_exists("getimagesize")){throw new Exception("Failed(no image library is installed...)");}if(!$srcType){$info=pathinfo($src);$srcType=strtolower($info["extension"]);}if($srcType == "jpg")$srcType="jpeg";if(!$dstType){$info=pathinfo($src);$dstType=strtolower($info["extension"]);}if($dstType == "jpg")$dstType="jpeg";$from="imagecreatefrom".strtolower($srcType);$thumb=$from($src);switch($dstType){case "jpg":return imagejpeg($thumb,$dst,100);break;default:$to="image".$dstType;if(function_exists($to)){$to($thumb,$dst);return true;}}}function soy2_getimagesize($filepath){if(function_exists("getimagesize")){list($width,$height,$type,$attr)=getimagesize($filepath);}else if(class_exists("Imagick")){$thumb=new Imagick($filepath);$width=$thumb->getImageWidth();$height=$thumb->getImageHeight();$thumb=null;}else if(function_exists("NewMagickWand")){$thumb=NewMagickWand();MagickReadImage($thumb,$filepath);list($width,$height)=array(MagickGetImageWidth($thumb),MagickGetImageHeight($thumb));$thumb=null;}return array($width,$height);}function soy2_resizeimage_maxsize($filepath,$savepath,$max){list($width,$height)=soy2_getimagesize($filepath);if($width <= $max AND $height <= $height){return soy2_resizeimage($filepath,$savepath,$width,$height);}if($width > $height){$width=$max;$height=null;}else{$width=null;$height=$max;}return soy2_resizeimage($filepath,$savepath,$width,$height);}function soy2_resizeimage_max_width_height($filepath,$savepath,$_width,$_height){list($width,$height)=soy2_getimagesize($filepath);if(!is_null($_width) && $width <= $_width){if(is_null($_height) || $height <= $_height){return true;}}if(!is_null($_height) && $height <= $_height){if(is_null($_width) || $width <= $_width){return true;}}if(!is_null($_width) && !is_null($_height)){$width=$_width;$height=$_height;}else{if(!is_null($_width) && $width > $_width){$width=$_width;$height=null;}if(!is_null($_height) && $height > $_height){$width=null;$height=$_height;}}return soy2_resizeimage($filepath,$savepath,$width,$height);}function soy2_resizeimage($filepath,$savepath,$width=null,$height=null){if(class_exists("Imagick")){$thumb=new Imagick($filepath);$imageSize=array($thumb->getImageWidth(),$thumb->getImageHeight());if(is_null($width) && is_null($height)){$width=$imageSize[0];$height=$imageSize[1];}else if(is_null($width)){$width=$imageSize[0] * $height / $imageSize[1];}else if(is_null($height)){$height=$imageSize[1] * $width / $imageSize[0];}$thumb->thumbnailImage($width,$height);$thumb->writeImage($savepath);return true;}if(function_exists("NewMagickWand")){$thumb=NewMagickWand();MagickReadImage($thumb,$filepath);$imageSize=array(MagickGetImageWidth($thumb),MagickGetImageHeight($thumb));if(is_null($width) && is_null($height)){$width=$imageSize[0];$height=$imageSize[1];}else if(is_null($width)){$width=$imageSize[0] * $height / $imageSize[1];}else if(is_null($height)){$height=$imageSize[1] * $width / $imageSize[0];}if(!MagickResizeImage($thumb,$width,$height,MW_LanczosFilter,1)){trigger_error("Failed [MagickResizeImage] ".__FILE__.":".__LINE__,E_USER_ERROR);return -1;}if(!MagickWriteImage($thumb,$savepath)){trigger_error("Failed [MagickWriteImage] ".__FILE__.":".__LINE__,E_USER_ERROR);return -1;}}return soy2_image_resizeimage_gd($filepath,$savepath,$width,$height);}function soy2_image_resizeimage_gd($filepath,$savepath,$width=null,$height=null){$info=pathinfo($filepath);$type=strtolower($info["extension"]);if($type == "jpg")$type="jpeg";$from="imagecreatefrom".$type;if(!function_exists($from)){trigger_error("Failed [Invalid Type:".$type."] ".__FILE__.":".__LINE__,E_USER_ERROR);return -1;}$srcImage=$from($filepath);$imageSize=getimagesize($filepath);if(is_null($width) && is_null($height)){$width=$imageSize[0];$height=$imageSize[1];}else if(is_null($width)){$width=$imageSize[0] * $height / $imageSize[1];}else if(is_null($height)){$height=$imageSize[1] * $width / $imageSize[0];}$dstImage=imagecreatetruecolor($width,$height);imagecopyresampled($dstImage,$srcImage,0,0,0,0,$width,$height,$imageSize[0],$imageSize[1]);$info=pathinfo($savepath);$type=strtolower($info["extension"]);switch($type){case "jpg":return imagejpeg($dstImage,$savepath,100);break;default:$to="image".$type;if(function_exists($to)){$to($dstImage,$savepath);return true;}trigger_error("Failed [Invalid Type:".$type."] ".__FILE__.":".__LINE__,2);return -1;break;}}function soy2_resizeimage_center($filepath,$savepath,$width,$height,$bgColor="#FFFFFF"){$info=pathinfo($filepath);$type=strtolower($info["extension"]);if($type == "jpg")$type="jpeg";$from="imagecreatefrom".strtolower($type);if(!function_exists($from)){trigger_error("Failed [Invalid Type:".$type."] ".__FILE__.":".__LINE__,E_USER_ERROR);return -1;}$srcImage=$from($filepath);$imageSize=getimagesize($filepath);list($image_width,$image_height)=$imageSize;if($image_width > $image_height){$image_width=($image_width > $width) ? $width : $image_width;$image_height=$image_height * $image_width / $imageSize[0];}else{$image_height=($image_height > $height) ? $height : $image_height;$image_width=$image_width * $image_height / $imageSize[1];}$top=($height-$image_height) / 2;$left=($width-$image_width) / 2;$srcImage1=imagecreatetruecolor($image_width,$image_height);imagecopyresampled($srcImage1,$srcImage,0,0,0,0,$image_width,$image_height,$imageSize[0],$imageSize[1]);imagedestroy($srcImage);$dstImage=imagecreatetruecolor($width,$height);if(preg_match('/#(.{2})(.{2})(.{2})/',$bgColor,$tmp)){$color=array(hexdec($tmp[1]),hexdec($tmp[2]),hexdec($tmp[3]),);$bgColor=imagecolorallocate($dstImage,$color[0],$color[1],$color[2]);imagefill($dstImage,0,0,$bgColor);}imagecopyresampled($dstImage,$srcImage1,$left,$top,0,0,$image_width,$image_height,$image_width,$image_height);$info=pathinfo($savepath);$type=$info["extension"];return imagejpeg($dstImage,$savepath,93);}?>
<?php function soy2_scandir($dir){$res=array();if(!file_exists($dir))return $res;$files=scandir($dir);foreach($files as $row){if($row[0] == ".")continue;$res[]=$row;}return $res;}?>
<?php function soy2_scanfiles($dir,$depth=-1){$res=array();$dir=soy2_realpath($dir);if($depth == 0)return $res;$files=soy2_scandir($dir);foreach($files as $file){if(is_dir($dir . $file)){$res=array_merge($res,soy2_scanfiles($dir . $file,($depth-1)));}else{$res[]=$dir . $file;}}return $res;}?>
<?php function soy2_serialize($var){return addslashes(serialize($var));}function soy2_unserialize($string){return unserialize(stripslashes($string));}?>
<?php function soy2_get_token(){if(!isset($_SESSION))@session_start();if(!isset($_SESSION["soy2_token"])){$_SESSION["soy2_token"]=soy2_generate_token();}return $_SESSION["soy2_token"];}function soy2_check_token(){if(!isset($_SESSION))@session_start();if(isset($_SESSION["soy2_token"]) AND isset($_REQUEST["soy2_token"])){if($_REQUEST["soy2_token"] === $_SESSION["soy2_token"]){$_SESSION["soy2_token"]=soy2_generate_token();return true;}}return false;}function soy2_generate_token(){return md5(mt_rand());}?>
<?php define("SOY2_DOUBLE_QUOTE",'"');function soy2_write_ini($filepath,$array){file_put_contents($filepath,soy2_ini_encode($array));}function soy2_ini_encode($array){$content="";uasort($array,create_function('$a,$b','return (is_array($b)) ? -1 : 1;'));foreach($array as $key => $value){if($value instanceof stdClass)$value=(array)$value;if(is_array($value)){$content .= "\n";$content .= "[$key]";$content .= "\n";$content .= soy2_ini_encode($value);$content .= "\n";}else{if(strpos($value,"\n")!==false|| strpos($value,"(")!==false|| strpos($value,")")!==false|| strpos($value,'"')!==false){$value=str_replace('"','\"',$value);$value='"' . $value . '"';}$content .= $key."=".$value;$content .= "\n";}}return $content."\n";}?>
<?php ?>
